# Decompilation Knowledge: May 2022

This document distills key decompilation knowledge from Discord conversations in the #smash-bros-melee channel during May 2022.

## Compiler Patterns

### MWCC Performance and Permuter Limitations
- The mwcc compiler runs significantly slower than GCC-based compilers (agbcc, IDO recomp)
- Running the permuter yields less than 20,000 permutations per hour with mwcceppc
- Workaround: Static recompilation of mwcc would help but requires significant RE effort
- Source: snuffysasa, revosucks (2022-05-01)

### `__PROFILE_EXIT` and Extra Instructions
- When compiling functions individually without the linker, mwcc may insert unexpected `__PROFILE_EXIT` calls and `nop` instructions:
```asm
bl       HSD_ObjFree
bl       __PROFILE_EXIT
nop
lwz      r0,28(rsp)
```
- This is normal for standalone compilation; the linker resolves these
- Source: snuffysasa (2022-05-01)

### Float Ordering with Dummy Functions
- Compiler may reorder float constants in unexpected ways
- **Fix**: Add a dummy function above that returns the float you want first
- The dummy function gets stripped by the linker but affects float ordering
- Source: camthesaxman (2022-05-21)

### For Loop Reversal Optimization
- Metrowerks can flip for loops from incrementing to decrementing if it determines functionality is unchanged
- This optimization enables use of `mtctr`/`bdnz` instructions which can only count down
- The loop body still executes in the original order; only the counter decrements
- Source: revosucks, altafen (2022-05-21)

### Debug Flag `-g` and Instruction Ordering
- Turning on "enable debug info" (`-g`) can swap instruction ordering (e.g., `lmw`/`li` swaps)
- This works because `-g` avoids the edited pathway for 1.2.5e compiler version
- Using normal 1.2.5 (non-patched) has the same result as using `-g`
- Source: vetroidmania, epochflame (2022-05-28)

### `do {} while(0)` Macro Pattern
- Using `do {} while(0)` for C preprocessor macros was considered good practice
- Forces semicolon requirement when calling macro (looks like regular function call)
- Can potentially generate different codegen vs just using scopes, even though it's optimized away
- Source: revosucks, altafen (2022-05-21)

### Cast Presence Affects Codegen
- The mere presence of a cast, even if logically unnecessary, can change register allocation:
```c
// These can produce different codegen:
ftDataInfo->...
((ftData*)ft->x10C_ftData)->...
```
- Use casts when needed to match original assembly
- Source: revosucks (2022-05-21)

### Comma Operator for Register Allocation
- The comma operator `(0, &expr)` evaluates to the rightmost expression but can affect register allocation
- Sometimes required for matching unusual codegen
- Source: altafen (2022-05-23)

### `crclr 6` / `crset 6` for Variadic Functions
- `crclr 6` means no arguments are floating-point type
- `crset 6` means at least one argument is floating-point type
- Generated when calling variadic functions (`...` in signature)
- Source: gibhaltmannkill (2022-05-29)

### Double Alignment
- 64-bit values (doubles, f64) must be aligned to 8-byte boundaries
- Empty padding words appear in data sections to ensure proper alignment
- Addresses for doubles must end in 0 or 8
- Source: revosucks (2022-05-31)

## Matching Techniques

### PUSH_ATTRS Macro Discovery
- A common pattern was discovered across all fighter OnLoad functions:
```c
#define PUSH_ATTRS(ft, attributeName)                                      \
    do {                                                                   \
        void *backup = (ft)->x2D8_specialAttributes2;                      \
        attributeName *src = (attributeName*)(ft)->x10C_ftData->ext_attr;  \
        void **attr = &(ft)->x2D4_specialAttributes;                       \
        *(attributeName *)(ft)->x2D8_specialAttributes2 = *src;            \
        *attr = backup;                                                    \
    } while(0)
```
- Works for nearly all fighters (Peach, Mars, Pikachu, Fox, Falcon, Ness, etc.)
- MasterHand required slight variation
- Emphasizes importance of pattern matching across similar functions over individual matches
- Source: revosucks, snuffysasa (2022-05-20, 2022-05-21)

### Self-Assignment for Register Allocation
```c
fighter_data3 = fighter_data3;
```
- Assigning a variable to itself can fix register allocation issues
- Seems absurd but sometimes required for matching
- Source: vetroidmania, revosucks (2022-05-25)

### Triple Equals for Register Swaps
```c
var == 0;  // Statement with no side effect
```
- Using a comparison statement (not assignment) can fix register swap issues
- Common trick when permuter can't find solution
- Source: snuffysasa (2022-05-23)

### `getFighter` Inline Function
```c
inline Fighter* getFighter(HSD_GObj* fighterObj) {
    return fighterObj->user_data;
}
```
- Used across fighter code for getting Fighter pointer from GObj
- Must have `inline` keyword or linker will complain about redefinition
- Sometimes required to match register allocation
- Source: chrisnonyminus, snuffysasa (2022-05-22)

### Switch Statement Patterns
- Small switches (2-3 cases) get optimized into comparison trees
- Compiler may reorder case checks as `if value != X`
- Range checks indicate consecutive case values:
```c
// If you see range comparison in ASM, all cases in range are handled:
switch(ASID) {
    case 0x166:
    case 0x167:
    // ... all values through ...
    case 0x16F:
        // same code
        break;
}
```
- Jump tables generated when ~5+ consecutive cases exist
- Source: revosucks, gamemasterplc (2022-05-22)

### Jump Table Tricks
```c
// To get combined cases with jump table:
case 6:
default:
    return attr->x14;
```
- Combining a case with default can produce correct jump table output
- Source: chippy__ (2022-05-30)

### Ternary Returns
```c
return (cond) ? returnThisIfTrue : thisIfFalse;
```
- Sometimes switch cases that look like if/else are actually ternary returns
- Check if phi variables can be replaced with ternary assignment
- Source: revosucks (2022-05-23)

### sqrtf Inline with Volatile
```c
// From math.h:
extern inline f32 sqrtf(f32 x) {
    volatile float y;  // Forces stack usage
    // ...
}
```
- The `volatile float y` forces the variable onto the stack instead of being optimized into a register
- This is how the original implementation worked
- Source: kiwidev (2022-05-26)

### SDA Register Loading
- `r13` is for `.sdata/.sbss` (mutable data)
- `r2` is for `.sdata2` (immutable/const data)
- For external SDA data:
```c
// Wrong (produces addi):
extern CreateItemUnk lbl_804D6D28;
temp = &lbl_804D6D28;

// Correct (produces lwz):
extern CreateItemUnk *lbl_804D6D28;
temp = lbl_804D6D28;
```
- Source: gibhaltmannkill, revosucks (2022-05-31)

### Struct Copy vs Pointer Assignment
- `*dest = *src` for struct copy generates different code than memcpy
- Cannot always use `__memcpy()` intrinsic as substitute
- Sometimes need specific variable declarations/ordering to match
- Source: revosucks (2022-05-21)

### Extern Float Labels
- When floats are in assembly but function is in C, use:
```c
extern f32 lbl_xxxx;
```
- This may alter codegen slightly; verify match on decomp.me
- Will need to remove externs once entire file is in C
- Source: snuffysasa (2022-05-22)

## Type Information

### Fighter OnLoad Template Pattern
All fighter OnLoad functions follow this structure:
1. Initialize `ft`, `ext_attr`, and `items` variables (even if unused)
2. Do pre-push attribute stuff (item calls, etc.)
3. Call `PUSH_ATTRS()` macro
4. Do post-push stuff (misc initialization)
- Source: revosucks (2022-05-20)

### Fighter State Variables (x2340+)
- State variables at offset 0x2340+ are used differently by each fighter
- Consider using a union of per-fighter structs
- Some state variables are accessed from common fighter code
- Source: vetroidmania (2022-05-29)

### HSD_Archive and DAT Files
- `.DAT` files are arbitrary data files on the disc (not embedded in DOL)
- Structure: header, data, string table with file offsets
- `HSD_ArchiveGetPublicAddress(archive, string)` looks up named data in string table
- Returns void* that can be cast to appropriate type (e.g., HSD_Joint*)
- Source: werewolf.zip (2022-05-24)

### Item Data Structure
- Item variables at `xDD4_itemVar` hold different data per item type
- Use union with specific item var structs:
```c
union {
    PKFlashVars pkFlash;
    u8 padding[0xFC8 - 0xDD4];
} xDD4_itemVar;
```
- Access: `item_data->xDD4_itemVar.pkFlash.xDD8_PKFlash`
- Source: altafen (2022-05-28)

### CreateItemUnk / SpawnItem Struct
- `SpawnItem` struct contains Vec3 members that are copied by value
- Use struct copy for Vec3 members: `spawnitem.whatever = *vel;`
- Source: altafen (2022-05-27)

## Function-Specific Insights

### Fighter OnLoad Functions
- Matched for all 33 characters using PUSH_ATTRS macro
- Clone characters call parent character's OnLoad:
  - `ftCFalcon_OnLoadForGanon`
  - `ftPikachu_OnLoadForPichu`
  - `ftFox_OnLoadForFalco`
  - `ftMario_OnLoadForDrMario`
  - `ftMars_OnLoadForRoy`
  - `ftLink_OnLoadForCLink`
  - `ftKoopa_OnLoadForGKoopa`
- Source: snuffysasa (2022-05-21)

### Fighter Internal Names
| Code Name | Character |
|-----------|-----------|
| Mars | Marth |
| Koopa | Bowser |
| GKoopa | Giga Bowser |
| CLink | Young Link (Child Link) |
| ZakoBoy/ZakoGirl | Wireframes |
- "Zako" means "small fish" in Japanese (unimportant/expendable)
- Source: altafen (2022-05-21)

### Melee Programmers
From credits, relevant to understanding code patterns:
- Akio Hanyu: Character, Stage Selection & Effect Programming
- Kouichi Watanabe: Playable Character Programming
- Tomokazu Tsuruoka: Playable Character & Special Bonus Programming
- Fighter code likely written by Hanyu, Watanabe, Tsuruoka
- Source: revosucks (2022-05-21)

### Effect Functions (ef_)
- `ef_Spawn` / `efLib_PauseAll` / `efLib_ResumeAll`
- PauseAll freezes effects, ResumeAll unfreezes
- Spawn_Async queues effects, Spawn_Sync spawns immediately
- Pause/Resume typically used for OnEnterHitlag/OnExitHitlag callbacks
- Effect IDs 0-591 are particles in EfCoData
- Model effects 1100-1200s (Yoshi egg, Firefox, Falcon Punch)
- Screen rumble: 1300, 1301
- Source: vetroidmania (2022-05-25)

### Action State Table Format
```c
ft_callback animation_callback;
ft_callback iasa_callback;
ft_callback physics_callback;
ft_callback collision_callback;
ft_callback camera_callback;
```
- Each move has 5 callbacks (from m-ex documentation)
- Source: altafen (2022-05-25)

## Tool Tips

### decomp.me Usage
- Context field is for struct definitions, function prototypes from project headers
- `hsd_gobj->user_data` is usually `Fighter*` even though typed as `void*`
- Change this in context for better auto-decompiler output
- Source: altafen (2022-05-24)

### asm-differ Linker Relocations
- `r2` or `r13` showing as `0` in current output is normal
- Gets fixed by linker (not run on decomp.me)
- `li` vs `addi r,r,0` are equivalent after linking
- Source: altafen, snuffysasa (2022-05-28)

### Permuter Setup (decomp-permuter)
```bash
python3 import.py https://decomp.me/scratch/xxxx
python3 permuter.py nonmatchings/funcname -j40 --better-only
```
- Import directly from decomp.me scratches
- Works on Windows (msys) and Linux
- Cannot create inlines, but can permute code containing them
- Limited to ~20K permutations/hour with mwcc
- Source: snuffysasa (2022-05-26, 2022-05-29)

### Building with Limited Errors
```bash
make -j20 MAX_ERRORS=1
```
- Limits error output when multiple files fail
- Note: will still show up to 20 errors (one per thread)
- Source: altafen (2022-05-22)

### DOL Extraction
- Use Dolphin emulator to extract DOL, not GCR (GC Rebuild)
- GCR extracts slightly incorrectly
- GCR still good for repacking
- DAT Texture Wizard may also have issues
- Source: epochflame, rainchus (2022-05-31)

### PPC Reference
- http://math-atlas.sourceforge.net/devel/assembly/ppc_isa.pdf
- Register overview:
  - r0-r31, f0-f31 (general and float registers)
  - r1: stack pointer
  - r2, r13: data pointers (never change)
  - r3-r12: function arguments/temps
  - r3: return value
  - r31-r14: callee-saved temps
- Source: altafen (2022-05-24)

### HSD Library Tool
- HSDLib (https://github.com/Ploaj/HSDLib) can open .dat files
- Shows string table references for debugging
- Useful for understanding what strings reference
- Source: werewolf.zip (2022-05-24)

## Pitfalls and Gotchas

### Case-Sensitive Filenames
- Windows has case-insensitive filenames, Linux/macOS do not
- `#include "ftness.h"` vs `#include "ftNess.h"` will fail on CI
- Always verify on Linux/CI after building locally on Windows
- Source: snuffysasa, altafen (2022-05-20)

### Function Order in File
- Functions must be decompiled in order within a file
- Skipping a function causes data shift issues
- Source: snuffysasa (2022-05-22)

### Float Data Duplication
- When moving functions with float constants from ASM to C, floats get duplicated
- Options:
  1. Use `extern float lbl_xxxx` references (may alter codegen)
  2. Accept non-matching DOL until entire file is complete
- Source: snuffysasa (2022-05-22)

### Union Member Default Types
- When adding union variants, don't change the default member's type:
```c
// Wrong - breaks existing usages:
-    /* 0x235C */ f32 x235C;
+    /* 0x235C */ u32 x235C;

// Correct - add new variant:
+    /* 0x235C */ u32 x235C_u32;
     /* 0x235C */ f32 x235C;
```
- Source: altafen (2022-05-27)

### Struct Size Errors
- Adding fields without updating padding causes offset shifts
- Use asmdiff.sh to diagnose data shifts
- 4-byte shift typically indicates extra/missing field
- Source: altafen (2022-05-27)

### Individual Matches vs Patterns
- Individual function matches may be "fake matches" (coincidentally matching but wrong approach)
- Focus on patterns that work across multiple similar functions
- If all OnLoad functions use same macro, a different approach for one is likely fake
- Source: revosucks (2022-05-20, 2022-05-21)

### Permuter Limitations
- Cannot fix issues requiring changes external to function (structs, inlines)
- Does not try triple equals, self-assignment tricks
- Running for 300K iterations without match suggests structural issue
- Source: snuffysasa, vetroidmania (2022-05-30)

## Progress Notes

### Milestones
- Trophy 18 achieved (2022-05-21): 6.31% code matched
- Trophy 20 achieved (2022-05-27): 6.90% code matched
- Ness character completed (2022-05-27)
- All 33 fighter OnLoad/OnDeath functions matched (2022-05-24)

### Code Size Estimates
- Fighter code (0x80068000 - 0x8015CC10): ~26% of DOL
- Total DOL size: 4,425,184 bytes

### SHA-1 Hash
- DOL hash: `08e0bf20134dfcb260699671004527b2d6bb1a45`
- Used for match verification
- SHA-1 collision attacks exist but impractical for this use case
- Source: altafen, revosucks (2022-05-21)
