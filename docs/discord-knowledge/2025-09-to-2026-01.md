# Decompilation Knowledge: September 2025 - January 2026

This document distills useful decompilation knowledge from Discord conversations in the #smash-bros-melee channel during September 2025 through January 2026.

---

## Compiler Patterns

### Debug Symbol Mode Error
When you forget to turn off `-sym on`, you'll see errors like:
```
ERROR Expected to find symbol sqrtf__Ff (type Function, size 0x64) at 0x8000D5BC
ERROR At 0x8000D5BC, found: lbVector_Angle (type Function, size 0x170)
ERROR Instead, found sqrtf__Ff (type Function, size 0x64) at 0x8000E98C
```
- Source: altafen (2025-09-01)

### Loop Unrolling by MWCC
The compiler takes simple loops and expands/unrolls them for performance optimization:
- The logic around splitting into groups of 8 and handling remainders is part of compiler optimization
- The "real" loop is the smaller loop at the end that handles the remainder
- Write your code as a simple loop; the compiler will handle unrolling
- Source: roeming, antidote6212 (2025-12-20)

### Signed vs Unsigned Loop Comparisons
If you need a `cmpw` (signed compare) instead of `cmplw` (unsigned compare) in the initial check before loop code, but changing loop vars to `int` breaks the loop unrolling:
```c
while (count-- > 0) {}
```
This pattern was used frequently in mplib for stubborn loops.
- Source: gigabowser (2025-12-21)

### fmuls Register Order
To get `fmuls f1, f1, f0` instead of storing in f0, try using compound assignment `*=`:
```c
value *= other_value;  // May produce fmuls f1, f1, f0
```
- Source: gigabowser (2025-12-18)

### Unused Bytecode Interpreter
Melee contains an unused bytecode interpreter (`HSD_ByteCodeEval`) that was part of sysdolphin:
- It's not stripped because RObj has a switch case that could reference it
- The code path is never actually reached in Melee
- Was potentially designed for a scripting language attached to RObjs
- Killer7 also has this code (unreachable) for the same reason
- Source: werewolf.zip, revosucks (2025-09-02)

---

## Matching Techniques

### M2C Union Field Selection
New m2c flags allow forcing specific union fields, solving a long-standing issue:
```bash
python tools/decomp.py ftKb_SpecialNNs_800FEDD0 \
  --union-field Fighter_FighterVars:kb \
  --union-field Fighter_MotionVars:kb \
  --union-field ftKb_MotionVars:specialn_ns
```
This avoids having to manually reorder union fields in headers.
- Source: lukechampine (2025-10-14)
- PR: https://github.com/matt-kempster/m2c/pull/301

### M2C Void Pointer Type Specification
Another m2c enhancement allows specifying types for void* variables:
```bash
python tools/decomp.py --no-copy ftKb_SpecialNNs_800FEDD0 \
  --void-var-type temp_r5:ftKb_DatAttrs
```
- Source: lukechampine (2025-10-15)
- PR: https://github.com/matt-kempster/m2c/pull/302

### Static Inline Wrapper Pattern
Sometimes a static function is wrapped by a non-static function with identical body:
```c
void it_802CC7D8(Item_GObj *gobj) {
    it_802CC7D8_inline(gobj);
}

static void it_802CC7D8_inline(Item_GObj *gobj) {
    // actual implementation
}
```
This allows the inner function to be static (file-local) while still callable from outside. May be an artifact of dev team code policy or macro-based "class" implementations.
- Source: revosucks, antidote6212 (2025-10-03)

### Chained Assignment Pattern
This m2c output pattern:
```c
temp_r31->cmd_vars[3] = 0;
temp_r31->cmd_vars[2] = 0;
temp_r31->cmd_vars[1] = 0;
temp_r31->cmd_vars[0] = 0;
```
Often comes from chained assignment:
```c
fp->cmd_vars[0] = fp->cmd_vars[1] = fp->cmd_vars[2] = fp->cmd_vars[3] = 0;
```
- Source: revosucks (2025-10-15)

### GET_FIGHTER Double Load Pattern
When m2c shows loading `gobj->user_data` twice, it often indicates an inlined function between the loads:
```c
Fighter *fp = GET_FIGHTER(gobj);
Fighter_ChangeMotionState(gobj, ...);
// The code after this might load fp again via another GET_FIGHTER
```
- Source: roeming, revosucks (2025-10-15, 2025-10-16)

### Float Ordering Issues
When sdata2 floats are in the wrong order:
1. A later function in the TU may need to use the float first
2. Can add a deadstripped helper function that uses the float:
```c
float get_min_life(void);
float get_min_life(void) {
    return 1.0f;
}
```
The linker will deadstrip this but the float ordering is preserved.
- Sometimes can use `const float min_life = 1.0f;` at file scope
- Source: altafen (2025-12-20)

### Decomp Permuter Setup
For using decomp-permuter:
1. Create a `nonmatchings` folder with `.gitignore` containing `*`
2. Add `build/binutils` to PATH
3. Run `powerpc-eabi-as -mgekko -o target.o target.s` to create target
4. Run `permuter.py .` from the function directory
- Helpful for regalloc issues and getting ideas flowing
- Source: gigabowser (2025-10-17)

### Duplicate Function Matching
Many functions share identical opcode sequences with already-matched functions:
- 989 functions (84 KB) were found to be duplicates of matched functions
- Matching the most common unmatched patterns can yield large gains
- Duplicates may use different structs/types but similar logic
- Source: lukechampine (2025-09-29)

---

## Type Information

### HSD_GObj_804085F0 TrspMask Array
```c
HSD_TrspMask HSD_GObj_804085F0[] = {
    HSD_TRSP_OPA,      // 1
    HSD_TRSP_TEXEDGE,  // 4
    HSD_TRSP_XLU,      // 2
    NULL               // 0
};
```
Used by `HSD_GObj_80390EB8` to convert a flag value to a proper TrspMask for `HSD_JObjDispAll`.
- Source: troy._ (2025-10-15)

### CollData Wall Naming Convention
`CollData` struct ends with four `SurfaceData` fields: `floor`, `right_wall`, `left_wall`, `ceiling`.
- For wall fields, the side refers to the side of the fighter contacted (left_wall = wall contacted on fighter's left)
- Function names and flag enums use the opposite convention (referring to wall facing direction)
- Suggested: Use `right_facing_wall` style names to avoid confusion
- Source: gigabowser, werewolf.zip (2025-11-17, 2025-11-18)

### Confirmed Function Names from Asserts
From assertions in the codebase:
- `lbMemory_800150F0` = `lbMemFreeToHeap`
- `lbArchiveRelocate`, `lbRefSetUnuse`, `mpCollPrev`, `mpCollEnd`, `mpGetSpeed`
- `stGetPlyDeadUp`, `ftGetParasolStatus`, `itGetKind`, `ftGetImmItem`
- `ftToSpecialNFox`, `gmResultAddPanelCamera`, `gmResultAddLight`, `gmResultAddModel`
- `gmResultSetViewPos`, `gmRegClearAddModel`, `grCorneriaGetPosMapKind2`
- `dbLoadCommonData`, `ifAddTime`, `ifAddTimeDownModel`, `ifAddMark`, `smSoundTestLoadData`
- Source: troy._ (2025-09-18)

### Header File Names from Asserts
```
shadow.h      - sysdolphin (used in lbshadow assertion)
plbonusinline.h
```
- Source: troy._ (2025-09-19)

---

## Function-Specific Insights

### Popo Ceiling Stick Bug
In `ftPp_SpecialAirS1_Coll` (Popo's aerial side-B collision callback):
```c
if ((fp->coll_data.env_flags & 0x6000) == 1) {  // Always false!
    fp->self_vel.y = 0.0F;
}
```
- `0x6000` is a bitmask for ceiling collision/hug
- The condition can never be true (result of bitwise AND with 0x6000 can't equal 1)
- Likely intended: `!= 0` instead of `== 1`
- This bug allows Popo to "stick" to ceilings with up-B
- Possible cause: inline returning bool used as `== TRUE` where BOOL is actually int
- Source: gigabowser, roeming (2025-11-30)

### Nana Garbage DI Bug
In `ftCo_800AC5A0`:
```c
ftCo_800B46B8(fp, CpuCmd_SetLstickX, stick_y);
ftCo_800B46B8(fp, CpuCmd_SetLstickY, stick_x);
```
- `stick_x` and `stick_y` can be uninitialized
- Causes Nana to DI with garbage data from r30/r5
- Use `/// @bug` documentation tag for these
- Source: kellz, werewolf.zip (2025-12-01)

### Ness PK Fire Pillar Bug
In `itNesspkfirepillar_UnkMotion0_Phys` and `itNesspkfirepillar_UnkMotion0_Coll`:
```c
if ((item->ground_or_air = GA_Air)) {  // Assignment, not comparison!
    // ...
}
```
- The `=` should be `==` for a proper check
- This always sets the item to air and always enters the if block
- Took 2 hours to discover this was intentional matching behavior
- Source: savestate, altafen, revosucks (2025-12-17, 2025-12-20)

### VIWaitXFBFlush / Game Loop
- `VIWaitXFBFlush` checks the state of VI buffers
- Used at end of game loop to wait for VI buffer to finish drawing before returning
- Core game loop: https://github.com/doldecomp/melee/blob/master/src/melee/gm/gm_1A45.c#L374
- Source: werewolf.zip (2025-12-01)

### Pokemon Stadium Screen Capture
- Uses a GObj with render priority 1 that clears framebuffer and copies EFB before HUD renders
- Separate GObjs handle text rendering with SISLib
- Setup function: `grstadium.c:L1175`
- Source: werewolf.zip (2025-12-24)

---

## Tool Tips

### decomp.me vs Local Workflow
decomp.me is good for sharing and #match-help, but has limitations:
- Cannot see data sections easily
- Must carefully track context changes
- Local build with objdiff and `tools/decomp.py` is the recommended workflow
- Source: altafen (2025-12-16)

### GET_ITEM on decomp.me
decomp.me has a limitation where `GET_ITEM(item_gobj)` fails because it can't convert `Item_GObj*` to `HSD_GObj*`:
- Workaround: Cast to `HSD_GObj*` explicitly
- Or create `HSD_GObjGetUserDataItem` that takes `Item_GObj*`
- This doesn't need to be ported to repo, just for decomp.me compatibility
- Source: altafen, ribbanya (2025-09-02)

### Ninja Build Commands
```bash
ninja all_source    # Compiles everything (including unlinked files)
ninja               # Only compiles linked (100% matched) files
ninja diff          # Shows what broke if a linked file broke

# For checking progress:
ninja baseline      # Run on master first
ninja changes       # Shows when % goes down (on your branch)
ninja changes_all   # Also shows when % goes up
```
- Source: altafen (2025-09-02)

### Context Generation
```bash
# Generate context for a specific file:
ninja build/GALE01/src/melee/vi/vi.ctx

# Using m2ctx with preprocessing:
python tools/m2ctx/m2ctx.py --preprocess
```
Static variables should go in `.static.h` files included only from the `.c` file - this gets them into context too.
- Source: altafen (2025-10-06, 2025-10-07)

### Debug Mode with Line Numbers
```bash
# Separate build dir for debug mode (avoids full rebuild when switching):
python configure.py --debug --build-dir debug

# Non-debug mode:
python configure.py --require-protos
```
Debug mode gives line numbers in objdiff, useful during development.
- Source: gigabowser (2025-12-21)

### EditorConfig / Formatting
- EditorConfig enforces formatting (line endings, final newlines)
- Run `clang-format` on files to fix formatting issues
- Most editors can auto-format based on project style
- Source: altafen (2025-12-21)

### M2C Update Issues
If m2c stops working with syntax errors about directives:
```
pip install --upgrade -r reqs/decomp.txt
```
If that doesn't work, delete `venv/Lib/site-packages/m2c*` and retry.
- Source: altafen (2025-11-02)

### Killer7 Debug Symbols
Killer7 has debug ELF with sysdolphin symbols, including inline names:
- Use disk1d ELF for debug version (inlines not stripped)
- LuigiBlood's DWARF v1 dumper provides symbol info
- Ghidra plugins for DWARF 1: https://github.com/dbalatoni13/ghidra-dwarf1 and https://github.com/emoose/ghidra-dwarf1
- Ghidra reads struct names but not members from the ELF
- Source: werewolf.zip, encounter, altafen (2025-11-21, 2025-11-22)

### Data Section Padding
Data sections are auto-padded to 8 bytes by the linker. If you see red in objdiff for a 3-byte difference at section end:
- Edit splits.txt and add `-3` to the end of that section
- It will match either way
- Source: roeming, altafen (2025-12-19)

---

## Pitfalls and Gotchas

### Diffing Mode in objdiff
When checking match status:
- Set "Diff Options" dropdown to "None" to ignore labels/data and check only instructions
- The GitHub diff bot runs with diffing type set to None
- Label differences don't mean the function is wrong if instructions match
- Source: rtburns, ribbanya (2025-10-13)

### String Pooling / Label References
When you see data symbols referencing offsets from unexpected base symbols:
- This is likely pooled string literals
- The C code accesses the struct directly, but asm uses a reference point
- Fix: Ensure data offsets in asm mirror those from generated object
- Make sure order and size of each symbol is correct and properly split
- Source: ribbanya (2025-11-06)

### Link Order for Module Files
Don't second-guess top-level modules (`gm`, `ft`, `gr`, etc.) - these are well-established by link order:
- Exception: `un` (unknown) which doesn't actually exist as a module
- Some files may need splitting
- Source: ribbanya, werewolf.zip (2025-10-17)

### File vs Function Matching
- "Matched file" = every function is 100% AND data also matches
- If a file is unmatched, build system pulls it from original DOL for hash checking
- Still stores JSON of percentages for regression detection
- Source: altafen (2025-12-27)

### Fake Matches to Avoid
Be wary of:
- Raw pointer arithmetic that happens to work
- Casts that don't make semantic sense
- Functions with pad_stack that might hide missing inlines
- LLM-generated names/comments (can be hallucinated)
- Source: rtburns, werewolf.zip (2025-12-29, 2025-12-30)

---

## Project Resources

### HSD/Sysdolphin Sources
- Killer7 has debug ELF and release ELF with sysdolphin symbols
- Pokemon Channel (JP) has HSD and sysdolphin debug prints
- HAL licensed HSD to other companies (Killer7, Bloody Roar, etc.)
- Source: werewolf.zip, .cuyler (2025-09-02)

### Naming Conventions (from asserts and patterns)
- Functions: `xxFileFunctionName` (prefix + file + name in CamelCase)
- Common file functions may not include file in name
- Structs: PascalCase
- Enum values: Mix of PascalCase and snake_case
- Defines: LOUD_SNAKE_CASE
- Source: troy._ (2025-09-19)

### File Renames from un/
The `un` (unknown) directory has been cleaned up:
- `un_2FC91` -> `ifnametag` (name tag interface)
- `un_2FC92` -> `ifhazard` (hazard indicator for Onett/Big Blue)
- `IfCoGet` = Coin Get (coin display for coin matches)
- Source: werewolf.zip (2025-12-23)

---

## AI/LLM Usage Notes

### Claude Code for Decompilation
One contributor set up an agentic workflow using Claude Opus 4.5:
```bash
claude --dangerously-skip-permissions "run /decomp, don't stop until you match 10 new functions, then commit them and open a PR"
```
- Match percentage is verifiable; interpretation/naming is not
- LLMs can hallucinate function names and comments
- Always verify names have justification with file references
- Don't let incorrect assumptions from training data sneak in
- Source: itsgrimetime, rtburns, werewolf.zip (2025-12-26 - 2025-12-30)

### Good LLM Use Cases
- "Hey this function does this, what's a better name for it?"
- Finding all sites where a placeholder struct member is used and suggesting names
- Processing Japanese function names to match English naming conventions
- Source: rtburns, troy._ (2025-09-19)

---

## Progress Milestones

- September 2025: Fuzzy match % passed 50%
- November 2025: Close to halfway point on strict matching
- December 2025: 47.39% matched, 28.49% linked (640/962 files)
- gigabowser ported collision code to a Melee engine reimplementation, verifying behavior
- Source: various (2025-09 through 2025-12)
