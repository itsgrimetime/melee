# Decompilation Knowledge: 2022-01

This document distills knowledge from the #smash-bros-melee Discord channel during January 2022.

## Compiler Patterns

### Compiler Version Selection (mwcc 1.2.5 vs 1.2.5e)

- **SDK libraries use plain 1.2.5**, while the actual game code uses the patched **1.2.5e** (with Frank epilogue modifications)
- Files in `e_files.mk` are compiled with 1.2.5e; everything else uses 1.2.5
- Using the wrong compiler version can cause epilogue instruction swapping issues
- Source: camthesaxman (2022-01-03), kiwidev (2022-01-03)

```
# Example: MSL code showing branch-to-next-instruction with wrong compiler
# If you see branches to the next instruction, try using 1.2.5 instead of 1.2.5e
```

### Frank Tool Behavior

- Frank applies epilogue modifications (mtlr/addi swap) to **entire files**, not individual functions
- If only one function needs the mtlr/addi swap and the rest break with Frank, you're out of luck
- Files processed by Frank go in `e_files.mk`
- Source: epochflame (2022-01-13)

### Register Allocation and sdata/sbss

- `r13` references variables in `.sdata` or `.sbss` sections (non-const globals)
- `r2` references variables in `.sdata2` or `.sbss2` sections (const data, similar to rodata)
- Sections ending in `2` are for const data
- Source: camthesaxman, seekyct, epochflame (2022-01-03)

### u16 Return Value Casting

When a function returns a halfword that gets cast to u16:
```c
// Assembly pattern:
//   bl      func_8016AF0C
//   clrlwi  r30,r3,0x10    // r30 = r3 & 0xFFFF

// C code:
u16 val = (u16)func_8016AF0C();
```
- Source: kiwidev, shibboleet (2022-01-18)

### rlwinm with Dot Suffix

- Any instruction ending with `.` (dot) compares the output register with 0 and sets condition register
- Example: `rlwinm.` performs rotate-left-word-immediate-then-AND-with-mask AND compares result to 0
- Source: kiwidev (2022-01-18)

## Matching Techniques

### Regalloc Forcing Trick

To force register allocation to stay the same without changing semantics, use a no-op expression:
```c
// Instead of:
t &= w;

// Use:
t & w;  // Result isn't saved, compiler optimizes it out but leaves regalloc intact
```
- This can help match when you have regalloc differences that seem like typos
- Source: werewolf.zip (2022-01-05)

### Subtracting l1 Position for Regalloc

```c
// Sometimes swapping which operand is on the left vs right matters
// If regalloc is wrong, try swapping l1 from left to right position
```
- Source: werewolf.zip (2022-01-03)

### Static Constant Literals

Be careful with constant literals - forgetting `0x` prefix changes the value:
```c
// WRONG - decimal literal
#define K1 80808080

// CORRECT - hex literal
#define K1 0x80808080
```
- This caused a single-word DOL mismatch at offset 0x430B78
- Source: waynebird, epochflame (2022-01-15)

### fpclassify / Float Classification

- `fpclassify` is often inlined everywhere and may not exist as a standalone function
- Look for it in pikmin2 headers: `include/Dolphin/float.h`
- It's likely implemented as a switch statement
- Source: kalua, epochflame, gibhaltmannkill (2022-01-05)

### Finding Function Names

1. Generate a map file: `make -j4 GENERATE_MAP=1`
2. Search the map for the address (case insensitive)
3. Static functions won't appear in the map
4. Each function address appears in ASM comments: `/* 800438D4 00040834 ... */`
- Source: camthesaxman, revosucks (2022-01-07)

## Type Information

### Fighter Struct Guidelines

- Use offset prefixes in variable names: `x84_pos`, `x221A_flags`
- The 0x222C - 0x22F8 range is a union that varies by character - don't use generic `fighter_var` from Akaneia
- Set up unions on per-character basis (e.g., `laser_holstered` for Fox at 0x222C)
- **Don't copy-paste Akaneia or community structs** - they may be wrong or not match decomp conventions
- Source: werewolf.zip (2022-01-04, 2022-01-09)

### Struct Documentation Practice

Always document struct offsets:
```c
struct UnkStructTemporary {
    /*0x00*/ char filler0[0x10];
    /*0x10*/ int unk10;
};
```

Or use subtraction for filler sizes:
```c
u8 filler[0x10 - 0x00];  // Less mental math needed
```
- Source: revosucks (2022-01-21), camthesaxman (2022-01-21)

### _p Macro Pattern

`_p` is shorthand for pointer, used as a macro for globals:
```c
#define _p ((HSD_VIInfo*)&HSD_VIData)
```
- Source: werewolf.zip (2022-01-20)

### MSL Quirks

- MSL (Metrowerks Standard Library) wraps things backwards: `<cmath>` normally wraps `math.h`, but MSL does it the other way around
- Some MSL code uses `#pragma cplusplus on` and `#pragma cplusplus reset` to compile C code with C++ name mangling
- Different MSL versions may have different functions (e.g., tanf location varies between versions)
- Source: arookas, camthesaxman (2022-01-03)

## Function-Specific Insights

### Fighter File Organization

- `ftcommon` contains physics-related functions and things shared by characters
- Common action states (walk, jump, shield) are in common functions, not character-specific files
- Character-specific files contain: Specials, OnLoad, OnDeath, etc.
- State machine data is in `.dat` files, not code
- Files are named with Japanese character names: `ftpurin` for Jigglypuff
- Source: werewolf.zip (2022-01-05)

### Melee Physics/Rendering Architecture

- Physics updates are decoupled from rendering rate
- Lightning Melee speeds up physics loop; Slow Mo Melee slows it down
- Input polling runs in a separate thread at 60Hz (not 59.95)
- This causes occasional "dead input frames"
- Faster Melee ran at 120Hz with half-speed engine for better netplay
- Source: werewolf.zip (2022-01-05)

### Assert Line Numbers

- Check the `r4` argument passed to `__assert` for the line number
- If all asserts in a file use the same line (e.g., 0x66/102), keep it as an inlined function
- Source: werewolf.zip, snuffysasa (2022-01-12)

## Tool Tips

### decomp.me Usage

- decomp.me calls the same compiler and compares assembly
- If it matches on decomp.me, it will match when moved to repo
- **Caveat**: decomp.me doesn't print data sections - verify those match separately
- Data section issues are usually trivial fixes in C
- Source: gibhaltmannkill, werewolf.zip (2022-01-20)

### rlwinm Decoder

Useful tool for understanding rotate/mask instructions:
https://celestialamber.github.io/rlwinm-clrlwi-decoder/
- Source: camthesaxman (2022-01-18)

### Map File Generation

```bash
make -j4 GENERATE_MAP=1
```
- Map generation is slow, so it's optional
- The linker calculates addresses for everything during build
- Source: camthesaxman (2022-01-07)

### Verbose Build Output

```bash
make VERBOSE=1  # See which tools are being invoked
make clean      # Always clean after changing devkitPPC versions!
```
- Source: revosucks (2022-01-09)

### Quick Disassembly

```bash
python3 doldisasm.py melee.dol > code.s
```
- Gives quick and dirty ASM source to copy from
- Run in a clean folder or it'll overwrite the LCF
- Source: revosucks (2022-01-07)

## Build Environment Issues

### devkitPPC r40-3 Bug (Critical)

**Problem**: devkitPPC r40-3 (released January 2022) produces incorrect output on Linux and Windows.

**Symptoms**:
- DOL checksum mismatch
- Shifted addresses in map file
- class.o and other object files have wrong sizes

**Solution**: Downgrade to devkitPPC r39-2
```bash
# Linux (Arch/Manjaro)
wget "wii.leseratte10.de/devkitPro/devkitPPC/r39%20(2021-05-25)/devkitPPC-r39-2-x86_64.pkg.tar.xz"
sudo pacman -U devkitPPC-r39-2-x86_64.pkg.tar.xz

# Windows (MSYS2)
wget "wii.leseratte10.de/devkitPro/devkitPPC/r39%20(2021-05-25)/devkitPPC-r39-1-windows_x86_64.pkg.tar.xz"
pacman -U devkitPPC-r39-1-windows_x86_64.pkg.tar.xz

# ALWAYS run make clean after changing devkitPPC versions!
make clean && make
```

**Archive of old versions**: https://wii.leseratte10.de/devkitPro/
- Source: kalua, revosucks, heralayansalty, waynebird (2022-01-08, 2022-01-09)

### PowerPC ABI Reference

The Embedded PowerPC ABI (used by mwcc eppc):
https://www.nxp.com/docs/en/application-note/PPCEABI.pdf

- LR is saved at `0x4(sp)`, not `0x8(sp)` like some other PPC ABIs
- Source: gibhaltmannkill (2022-01-17)

## Pitfalls and Gotchas

### Dead Code Stripping

- The linker strips unused functions - you won't get errors for undefined symbols in stripped code
- Use `#pragma force_active on` to prevent stripping during development
- If a function isn't referenced anywhere, the linker won't complain about missing symbols it calls
- Source: gibhaltmannkill, epochflame (2022-01-21)

### Extern Declarations

- `extern` tells the compiler to look elsewhere for a symbol
- Unused externs don't cause errors - the linker only resolves symbols that are actually used
- Only when you actually USE an extern will you get "undefined symbol" errors
- Source: epochflame, camthesaxman (2022-01-21)

### Partial Linking Caveats

- Float constants used in multiple functions can cause extern matching issues
- Recommend: Don't link the C file until all functions are decompiled
- Alternative: Put decompiled functions in unlinked .c file, mark as matching
- For Melee (C code), partial linking is less problematic than C++ projects
- Source: camthesaxman, epochflame, gibhaltmannkill (2022-01-21)

### Label vs Function Detection

Some functions appear as `lbl_XXXXXXXX` instead of `func_XXXXXXXX` because:
- They're static (file-local)
- They're only called via function pointers
- They're callbacks that aren't directly branched to

Check for address usage in data sections (e.g., `lbl_802F4424` might reference `lbl_802F4194`)
- Source: werewolf.zip, epochflame (2022-01-21)

### obj_files.mk Ordering

- Functions must be in the same order as the original
- Mismatched ordering causes shifted addresses
- When splitting ASM files, functions in one split file cannot reference labels defined in another split file (local labels)
- Source: waynebird (2022-01-15)

### Workflow Best Practices

1. **Rename then decomp** (not decomp then rename)
2. **Check :ok: at every step**
3. Rename symbols in ALL files (ASM included) when renaming
4. Use defines for temporary name mappings: `#define sin func_80473745`
5. Don't use community/Akaneia struct names unless verified by matching
6. Put minimum required struct fields - use filler for unknown areas
- Source: Multiple contributors (2022-01-21)

### Commit Practices

- Don't sit on matched functions for weeks - push WIP PRs
- If matching takes a while, push progress so others can help
- Commit to unlinked .c files if the file isn't complete
- Use `#ifdef NON_MATCHING` for functions that can't match due to string/data issues
- Source: werewolf.zip, epochflame (2022-01-04)
