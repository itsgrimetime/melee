# Decompilation Knowledge: July 2022

This document distills technical knowledge from the #smash-bros-melee Discord channel during July 2022. Progress during this month went from approximately 7.5% to 9.5% code matching, with significant work on fighter characters, sysdolphin libraries, and build tooling.

## Compiler Patterns

### Inline Auto Depth Limits
- The `-inline auto` flag has a default depth of approximately 3 levels
- When a function inlines another function that inlines yet another, the third level may refuse to inline and instead emit a `bl` call
- This caused issues with `HSD_JObjSetScale` -> `HSD_JObjSetMtxDirty` chain where the innermost inline stopped inlining
- Workaround: Create a "hack" version that manually inlines the final call
- Source: revosucks (2022-07-01 through 2022-07-03)

### Static vs Inline Function Float Ordering
- **Critical**: Using `static` functions affects float constant ordering in `.sdata2`, whereas `inline` does not
- To force float order, declare a static function at the top of the file that uses the float first:
```c
static float get_zero() {
    return 0.0f;
}
```
- The linker will strip unused static functions, but float constants are still placed in order
- This is essential when partially decompiling files where float order must match existing ASM
- Source: revosucks, altafen (2022-07-04)

### Volatile in sqrtf Inline
- The official SDK `sqrtf` inline uses a `volatile` variable for no apparent reason
- This causes pointless stack store/reload sequences (`stfs` followed by `lfs` to same address)
- The volatile was likely a compiler bug workaround from original developers
- When seeing this pattern, use the correct sqrtf macro from math.h rather than trying to replicate it manually
- Source: revosucks, shibboleet (2022-07-21)

### Variable Declaration Order Affects Register Allocation
- The order variables are declared at the top of a function affects which registers they're assigned
- Swapping the order of two variable declarations can swap their registers throughout the function
- Example: `Fighter* fp;` before `FighterSpecificAttributes* attrs;` produces different regalloc than vice versa
- Source: revosucks (2022-07-25)

### Chain Assignment Affects Distant Codegen
- Chain assignments like `top_y = right_x = bottom_y = left_x = 0.0f;` can affect register allocation and codegen hundreds of lines away
- Changing the order of variables in chain assignment affects codegen even for code not directly related
- The permuter's randomization pass was specifically added to find these distant effects
- Source: snuffysasa, altafen (2022-07-11)

### mfcr Instruction Pattern
- `mfcr` (move from condition register) is used for storing boolean comparison results
- Pattern: `mfcr r0` followed by `rlwinm` shifts to extract specific condition bits
- Used for float comparisons like `*(u32*)&stack->data = *(f32*)&stack->data > var;`
- Different shift amounts (0x1F, 0x1E, 0x1D) correspond to different comparison operators (<, >, <=, >=, ==, !=)
- Source: revosucks, camthesaxman (2022-07-09)

### eqv Instruction
- `eqv rd, ra, rb` computes `rd = ~(ra ^ rb)` (equivalence / XNOR)
- Rarely seen in normal code; appears in bytecode interpreter functions
- Source: ocesmt (2022-07-09)

### frsqrte and sqrtf
- `frsqrte` instruction (floating reciprocal square root estimate) indicates use of the SDK `sqrtf` inline
- The inline uses intrinsic `__frsqrte`
- Do not try to generate this manually; use the macro from math.h
- Source: rtburns, altafen (2022-07-16)

### Bitfield vs Manual Masking
- HSD/sysdolphin code uses manual masking with u32 (`flags & 0x80000000`) rather than bitfields (`: 1`)
- Using bitfields generates `rlwimi` and other instructions vs masks which generate `and`/`or`
- Fighter code appears to use bitfields, but HSD code does not
- Source: werewolf.zip (2022-07-15-16)

### subfic Instruction Mystery
- Some functions generate `subfic` (subtract from immediate carrying) in mysterious ways
- Example: `i = 5; for (i -= 5; i < 5; i++)` generates subfic but `i = 0; for (; i < 5; i++)` doesn't match
- May be related to 1.2.5e vs patched compiler differences
- Still unresolved for some functions
- Source: vetroidmania, ocesmt (2022-07-09)

## Matching Techniques

### Float Absolute Value Bit Hack
- Melee (but not later games like KAR) uses a bit manipulation macro for float absolute value:
```c
#define ABS(x) *(u32*)&x = *(u32*)&x & ~0x80000000;
```
- This generates `clrlwi` to clear the sign bit
- Later HSD versions (GNT4, Kirby Air Ride) use standard `fabs`/`fabsf`
- Source: amber_0714, vetroidmania (2022-07-02)

### 3x4 Matrix Inverse Function (func_80379310)
- A notoriously difficult function calculating 3x4 matrix inverse with inline determinant
- Required extremely ugly nested calculations to match
- The determinant formula was written in non-standard order
- Uses the float bit hack for absolute value
- Source: amber_0714, vetroidmania (2022-07-01 through 2022-07-08)

### fnmsubs vs fmsubs
- To get `fnmsubs` (floating negative multiply-subtract), can try `__fnmsubs()` intrinsic
- This was needed for some matrix functions
- Source: revosucks (2022-07-03)

### Stack Alignment and Inlines
- Stack is allocated in 8-byte increments
- When compiler considers a function "unsafe" (certain conditions), stack becomes unconsolidated
- Adding filler variables (2 at a time for 8-byte alignment) can help match stack size
- Using inlines reserves additional stack space that may or may not be optimized away
- Source: revosucks (2022-07-01, 2022-07-21)

### Double-Initialization Pattern
- Some functions require strange patterns like `Fighter* fp = fp = GET_FIGHTER(gobj);`
- This may indicate an inline function that itself does the assignment
- The double assignment generates specific register moves
- Source: revosucks, allocsb (2022-07-25-26)

### Switch Statement Detection
- Chains of `beq`/`b` branches often indicate switch statements
- If cases are contiguous (0,1,2,3...), compiler may optimize to jump table
- Otherwise generates binary search pattern with nested if-else
- Source: kiwidev (2022-07-21)

### Return Statement Stack Artifact
- A `return;` statement inside an if block can leave behind a `cmpwi r3,0` with no following branch
- The comparison instruction remains even after optimization removes the branch
- Source: ninji (2022-07-05)

### Unused Variable Trick
- Declaring unused variables can affect register allocation and stack usage
- `s32 unused[2];` or similar padding can force specific stack layout
- Source: revosucks (2022-07-04)

## Type Information

### Fighter Struct State Variables (x2340+)
- The area after offset 0x2340 in Fighter struct contains action-state-specific variables
- Different action states reuse this memory with different interpretations
- Likely implemented as a union of per-action-state structs
- Different fighters may have different unions in this area
- Source: vetroidmania, snuffysasa (2022-07-05-06, 2022-07-12)

### Fighter Callback Naming
- HAL naming convention for special moves: `SpecialN`, `SpecialS`, `SpecialHi`, `SpecialLw`
- Air versions have "Air" before the direction: `SpecialAirN`, `SpecialAirHi`, etc. (not `SpecialNAir`)
- Callback functions get `_Action` suffix: `ftNess_SpecialHi_Action`
- Source: vetroidmania, altafen, snuffysasa (2022-07-05)

### CollData ECB Differences
- ECB (Environmental Collision Box) in item.h uses 4x f32
- ECB in fighter.h uses 4x Vec2
- Fighter ECBs are animated which may explain the difference
- Source: altafen, ribbanya (2022-07-11)

### GObj/JObj/CObj Hierarchy
- GObj = General Object (base container)
- JObj = Joint Object (has skeleton/joints for animation)
- CObj = Camera Object
- RObj = Reference Object
- GObjs contain pointers to more specific object types via their `hsd_obj` field
- Source: revosucks, amber_0714, vetroidmania (2022-07-06)

### Fighter Input Flags
- `fighter->input.x668` contains button press flags (instant presses)
- `fighter->input.x65C` contains held button flags
- Each bit represents a button (e.g., 0x200)
- Source: snuffysasa, vetroidmania (2022-07-16)

### HSD_SList Structure
```c
typedef struct _HSD_SList {
    struct _HSD_SList* next;
    void* data;
} HSD_SList;
```
- Used extensively in bytecode interpreter
- Data can be cast to different types (s32, f32, pointer) depending on context
- Source: revosucks (2022-07-09)

## Function-Specific Insights

### HSD_ByteCodeEval
- ~1,600 lines of ASM, one of the largest functions in the codebase
- Contains two major switch statements
- Evaluates a bytecode scripting system (not the fighter animation bytecode)
- Contains 91 assert calls, helpful for mapping cases to line numbers
- Opcodes enumerate from 0x00 to 0xFF
- Used for RObj bytecode expressions
- Source: revosucks (2022-07-08-09)

### ECB_Interpolate (mpcoll.c)
- Responsible for the rare crash at tournaments (mpcoll.c line 1193)
- Crashes when any ECB float becomes NaN
- Checks 8 different float values with `fpclassify(x) == FP_NAN`
- Calls OSReport("error\n") then asserts "0"
- Source: altafen, revosucks, bazoo23 (2022-07-03-04)

### Fighter_OnItemPickup Callbacks
- Most fighters share nearly identical OnItemPickup functions
- Some fighters (Kirby, Link, CLink, Purin, Mewtwo) have different implementations
- A macro can generate most but not all of them
- Related callbacks: OnItemInvisible, OnItemVisible, OnItemRelease share similar patterns
- Source: snuffysasa (2022-07-03-05)

### Stripped Function Strings
- When a function is stripped by the linker but contained assert strings, the strings remain
- "fighter parts model dobj num over!\n" and similar strings exist without corresponding code
- Workaround: Declare const strings between functions to maintain ordering
- Source: werewolf.zip, altafen, snuffysasa (2022-07-03)

### Sheik References Ness Function
- ftSheik uses an ECB calculation function defined in ftNess_AttackHi4.c
- This is unusual - first known case of one fighter using another fighter's C file function
- Ness code comes before Sheik in link order (alphabetically)
- Source: vetroidmania (2022-07-18)

## Tool Tips

### decomp.me Usage
- Tab completion exists but not in the web editor
- Scratch "family" view shows related scratches
- Score of 60 typically indicates a match when using permuter (due to epilogue penalty)
- Source: various (throughout month)

### asm-differ / objdiff
- Configure with `diff_settings.py` in repo root
- Run with `python ../asm-differ/diff.py -mwo func_XXXXXXXX`
- Use `-b` flag to compare against diff.py start time instead of last save
- Metrowerks map format differs by version (1.1 lacks File Offset column)
- Can use `-o` flag combined with watch mode for rapid iteration
- Source: altafen, encounter, simonlindholm (2022-07-14)

### wibo (Wine Alternative)
- Lightweight Windows binary loader for Linux
- Much faster than Wine for compiler invocations (2x speedup reported)
- No DLL loading overhead that Wine has
- Fixed intermittent linker failures that plagued Wine
- MWLD 1.1 has a bug reading garbage from stack; patched by changing loop counter at offset 130933
- Patch: `printf '\x51' | dd of=tools/mwcc_compiler/1.1/mwldeppc.exe bs=1 seek=130933 count=1 conv=notrunc`
- Source: altafen, encounter, rtburns, ninji (2022-07-05-13)

### Linker Version Differences
- MWLD 1.1 links faster but has stack corruption bug under wibo
- MWLD 1.2.5 is more stable but generates huge .map files slowly (1m46s per link)
- MWLD 1.2.5 writes one byte at a time with fflush (terrible performance)
- Use 1.1 locally, 1.2.5 on CI for reliability
- Source: altafen, werewolf.zip, encounter (2022-07-12)

### Permuter Setup
- Use mwcc_233_163 (1.2.5) for permutation, not 1.2.5e
- Score of 60 indicates match (due to epilogue differences)
- Randomization pass can find "action at a distance" effects
- Source: snuffysasa (2022-07-11)

### OSReport Debugging
- OSReport logs visible in Dolphin's log viewer
- Enable in Show Log Configuration
- Useful for real-time debugging of custom DOL
- Very clean output (not cluttered)
- Source: vetroidmania, waynebird (2022-07-05)

### Float Constant Pool Splitting
- When a float constant appears twice in a .s file, second occurrence marks new C file
- Script (WIP) automates splitting based on this heuristic
- Use `.4byte` to reference floats from C file to ASM when partially decompiling
- Source: altafen (2022-07-14, 2022-07-28)

### PPC Instruction Reference
- http://math-atlas.sourceforge.net/devel/assembly/ppc_isa.pdf
- Search for specific instructions rather than reading cover-to-cover
- Source: altafen (2022-07-22)

## Build System

### GitHub Actions Improvements
- Switched from Wine to wibo for CI builds
- Patched MWLD 1.1 to fix intermittent failures
- Build now reliably succeeds (100% after 8000 runs with patch)
- Map file and progress now shown as artifacts/status
- Source: altafen (2022-07-13-14)

### Integer-to-Float Conversion Constants
- `0x43300000` + `0x00000000` used for unsigned int to float
- `0x43300000` + `0x80000000` used for signed int to float
- These appear in .sdata2 and relate to xoris conversion pattern
- Source: snuffysasa, moester_ (2022-07-11-12)

## Common Pitfalls

### Including C Files
- Can include C files but considered bad practice
- If including code, should be an inline header instead
- Function declarations belong in headers, not C file includes
- Source: revosucks, werewolf.zip, camthesaxman (2022-07-28)

### Register Swaps from Type Mismatches
- Passing wrong type (e.g., Fighter* vs Item GObj*) causes register shuffling
- Check `lwz r3, 0xXXXX(rYY)` to see what's actually being passed
- If compiler loads from struct offset for r3, that's what gets passed
- Source: altafen, vetroidmania (2022-07-15)

### GameCube Float Non-Compliance
- GameCube FPU is ~99% IEEE 754 compliant, not 100%
- Some edge cases differ (e.g., early CW versions had `Sqrt(0)` return infinity)
- Dolphin developers have more info on specific differences
- Be careful when porting code to standard IEEE platforms
- Source: revosucks (2022-07-04, 2022-07-16)

### Fake Matches
- Contrived code that matches assembly but isn't what developers wrote
- Look for: excessive temp variables, pointless casts, strange inline usage
- Clean up after matching when possible
- Document known fakes for later fixing
- Source: various (throughout month)

### Stack Mismatch Debugging
- First match all code except stack, then fix stack
- Inlines often cause stack discrepancies
- Adding/removing inlines changes stack reservation
- Order of inline usage matters
- Source: revosucks (2022-07-21)

## Project Milestones

### Progress Statistics
- Started month: ~7.5%
- End of month: ~9.5%
- Trophies: 25 -> 27
- mtx.c fully decompiled (previously one of hardest files)
- Major fighter work: G&W, Luigi, Fox, Donkey Kong, Zelda

### CW_Update.zip Search
- The compiler patch from 2001 remains unfound
- Was distributed via FTP to licensed developers only
- Contacted multiple potential sources (game developers) with no luck
- Eternal Darkness developers couldn't/wouldn't share
- Bounty still open
- Source: revosucks, cortex420 (2022-07-03, 2022-07-18)

---

*Compiled from 3,140 Discord messages in #smash-bros-melee, July 2022*
