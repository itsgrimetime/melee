# Decompilation Knowledge: 2020-08

Early project days - second month of activity with 1,650 messages. Major focus on build infrastructure, shiftability, and early decompilation work.

## Compiler Patterns

### mwcc Optimization Levels
- `-O4` implies `-opt level=4, peephole, schedule, autoinline, func_align 16`
- `-O4,p` specifies speed optimization, `-O4,s` specifies space optimization
- Different parts of a game could be compiled with different compiler options
- Melee confirmed using `-O4,p` with `-proc gekko -fp hardware -Cpp_exceptions off -enum int -fp_contract on -inline auto`
- Source: revosucks, shibboleet, kitesage (2020-08-30)

### lmw/stmw Instructions
- `lmw`/`stmw` (load/store multiple words) are stack push/pop optimizations
- These are slow instructions and were explicitly disabled for most of Melee
- Only menu files (`mnmain`) appear to have them enabled via pragma
- If `-use_lmw_stmw` wasn't explicitly disabled, the entire game would use them
- Developers likely thought they'd get speedup in menu code and enabled it
- These show up in HSD library code in other games (like Killer7) that compiled sysdolphin themselves
- Source: werewolf.zip (2020-08-06)

### Instruction Scheduling Differences
- The postprocess script handles mtlr instruction reordering for epilogues
- Sometimes `mr` instruction ordering in epilogues needs manual handling
- Pattern: mtlr is typically shifted up, but scheduler may move it more than expected
- Example epilogue issue:
```asm
# Expected:
mr r3, r31
lwz r0, 36(r1)
lwz r31, 28(r1)
addi r1, r1, 32
mtlr r0
blr

# With schedule off - different order:
stfs f0, 8(r31)
lwz r0, 36(r1)
mr r3, r31
...
```
- Source: revosucks, camthesaxman (2020-08-07)

### mwcc Inline Behavior
- mwcc processes inline assembly **before** preprocessor expansion
- This allows a hack where `#define _SDA_BASE_(dummy) 0` works for inline asm but not standalone assembly
- The compiler looks at inline asm before macro expansion occurs
- Source: revosucks (2020-08-05)

### Compiler Float Multiplication Bug
- mwcc erroneously optimizes out `*= 1.0f` operations
- Per IEEE standards, the result should still be calculated (not guaranteed to be the same)
- Source: revosucks (2020-08-04)

## Matching Techniques

### Inline Functions for Register Usage
- Inline functions can force specific register allocation patterns
- Using inline accessor functions produces more unique register usage
- Example: `HSD_FObjRemoveAll` needed inline functions to match register usage (r28, r29, r30, r31 vs r0, r31)
```c
inline HSD_FObj *HSD_FObjGetNext(struct _HSD_FObj *fobj) {
    return fobj->next;
}

inline void *HSD_Loop(struct _HSD_FObj *fobj) {
    if (!fobj)
        return;
    HSD_FObjRemoveAll(fobj->next);
    HSD_FObjRemove(fobj);
}
```
- The compiler "unrolls" recursive calls multiple times when using inlines
- Source: revosucks, werewolf.zip (2020-08-11)

### Array Out-of-Bounds Hack for Stack Matching
- Some functions require UB (undefined behavior) array access to match stack layout
- Example from `func_8000D2EC`:
```c
#ifdef AVOID_UB
    float foo[2];
#else
    float foo[1]; // Uses foo[1] which is out of bounds
#endif
    foo[1] = sqrtf(a[0] * a[0] + a[1] * a[1] + a[2] * a[2]);
```
- The compiler allocates only 1 float but code accesses `foo[1]`
- This may indicate: (1) programmer misunderstanding of C array initialization, or (2) compiler difference
- The pattern appears in multiple lbvector functions
- Use `#ifdef NONMATCHING` or `#ifdef AVOID_UB` for these cases
- Source: revosucks, camthesaxman (2020-08-07)

### Volatile Casts for Load/Store Order
- Use volatile casts to force specific load/store ordering:
```c
f0[0] = ((volatile float *)b)[0];
f0[1] = ((volatile float *)a)[0];
```
- Source: revosucks (2020-08-07)

### Section Pragmas for Init Functions
- Use `__declspec(section ".init")` on function prototypes to place them in .init section:
```c
__declspec(section ".init") void * memset(void * dst, int val, unsigned long n);
```
- mwcc orders explicit section functions first, then non-explicit but specified objects
- Source: revosucks (2020-08-05)

## Type Information

### Function Pointer Tables
- Generic Animation/Action-State tables are 0x20 bytes per entry:
```c
struct anim_ft {
    u32 id;              // Action state ID
    u32 unk_flags0;      // Flags
    u32 unk_flags1;      // Flags
    u32 animationInterrupt;  // Function pointer
    u32 inputInterrupt;      // Function pointer
    u32 actionPhysics;       // Function pointer
    u32 collisionInterrupt;  // Function pointer
    u32 cameraBehaviour;     // Function pointer
};
```
- Source: revosucks (2020-08-06)

### HSD Object Initialization Pointers
Key HSD object info init pointers:
- `hsdMObj` - 80405E28 -> MObjInfoInit (80405E28)
- `hsdLObj` - 804060C0 -> LObjInfoInit (80367688)
- `hsdCObj` - 80406220 -> CObjInfoInit (80406220)
- `hsdPObj` - 80406398 -> PObjInfoInit (8036eb88)
- `hsdJObj` - 80406708 -> JObjInfoInit (803737F4)
- `hsdObj` - 804072A8 -> ObjInfoInit (804072A8)
- `hsdClass` - 80407590 -> _hsdInfoInit (803822C0)

To find these: search for xrefs to `hsdInitClassInfo` (80381c18) - r3 contains the static pointer.
- Source: werewolf.zip (2020-08-06)

### DOL/ELF Section Layout
BSS size in DOL header is misleading - it's actually `sizeof(bss) + sizeof(sdata) + sizeof(sbss)`

Section order:
```
.init
extab
extabindex
.text
.ctors
.dtors
.rodata
.data
.bss
.sdata
.sbss
.sdata2
.sbss2
```
- Source: revosucks (2020-08-02, 2020-08-12)

### SDA Base Calculation
- `_SDA_BASE_` = sdata section base + 0x8000
- `_SDA2_BASE_` = sdata2 section base + 0x8000
- This offset exists because EABI requires SDA offsets within signed 16-bit value
- Allows accessing twice as much SDA memory with negative offsets
- Source: revosucks (2020-08-04)

### Kirby-Specific Notes
- Kirby has ~203 special move functions (one .c file per hat/copy ability)
- Kirby's code is 34k lines of assembly
- Estimated ~5% of entire codebase size
- Source: werewolf.zip (2020-08-06, 2020-08-07)

## Function-Specific Insights

### Stub Functions
- Many stub functions (`blr` only) exist throughout the codebase
- Every stage has ~3 stub functions
- Stubs are sometimes padded with 0x00000000 bytes to align to 0x10 or 0x20
- No evidence of stubbed/cut fighters - all character slots are accounted for
- Source: werewolf.zip (2020-08-06)

### Unused Blink Function Table
- Address 0x3BF2D4 (ROM) contains an entirely NULL function pointer table
- Used for texture toggle callbacks during character blinking
- Referenced by func_8007058C but never initialized
- Leftover from some unused blinking mechanic
- Source: werewolf.zip (2020-08-06)

### Memory Card Exploit
- Memcard name tags have buffer overflow vulnerability
- Developers assumed no one would access memcard data directly
- No size validation despite fixed-length name tags
- This is the "HomeBros" exploit vector
- Source: werewolf.zip (2020-08-07)

## Tool Tips

### Linker File Order
- Object link order is determined by command-line order passed to mwldeppc
- In CodeWarrior IDE, there's a tab to manage file link order (move up/down)
- Wildcard LCF sections use command-line order for resolution
- Source: revosucks, werewolf.zip (2020-08-05)

### elf2dol BSS Size Fix
- Original elf2dol incorrectly calculated BSS size
- Fix required tracking PHDR values for sdata and sbss
- BSS size = sizeof(bss) + sizeof(sdata) + sizeof(sbss)
- Pass PHDR indices to elf2dol (e.g., `tools/elf2dol main.elf main.dol 9 10`)
- Source: revosucks (2020-08-05)

### Assembly Extern Requirements (mwasmeppc)
- mwasmeppc doesn't recognize `.global` for external symbols
- Must use `.extern` for forward references
- Create a `global.inc` with all extern declarations
- Include this file in every assembly file
- Source: revosucks (2020-08-12)

### GCC Syntax Checking
- Run CCCHECK with GCC to parse C syntax before mwcc compilation
- Catches syntax errors that mwcc might not report clearly
- Source: revosucks (2020-08-05)

### Disassembly Tools
- Doldisasm generates .s files: https://gist.github.com/camthesaxman/a36f610dbf4cc53a874322ef146c4123
- Output is meant for GNU assembler, not mwasmeppc directly
- Converting to mwasmeppc format requires `.extern` declarations
- Source: camthesaxman (2020-08-01, 2020-08-12)

### Wine Compatibility
- Wine 5.14 and 5.15 broke CodeWarrior linker (CWParserSetOutputFileDirectory error)
- Wine 5.13 is last known working version
- Error: `Unexpected error in CWParserSetOutputFileDirectory [3]`
- Source: revosucks (2020-08-21)

## Pitfalls and Gotchas

### SDA Relocation Limitations
- GNU assembler cannot generate `R_PPC_EMB_SDA21` relocations for SDA-relative access
- mwasmeppc also cannot do this from standalone assembly files
- Only inline assembly in C files (processed by mwcc) properly generates SDA21 relocations
- The assembler can't handle two linker symbols in a subtraction (e.g., `label - _SDA_BASE_`)
- Workaround: migrate asm to C files with inline assembly, or wait for full decompilation
- Source: revosucks, camthesaxman (2020-08-03 - 2020-08-05)

### .word vs .4byte in Assembly
- `.word` directive may not be recognized by devkitPPC assembler
- Use `.4byte` instead - `.word` silently fails/is ignored
- Source: revosucks (2020-08-06)

### Case Sensitivity in Makefiles
- File paths are case-sensitive on Linux
- Makefiles must preserve case sensitivity (e.g., `MSL/PPC_EABI/` vs `msl/ppc_eabi/`)
- mkdir may not preserve case; verify directory names match exactly
- Source: revosucks, werewolf.zip (2020-08-11)

### Function Alignment Mystery
- mwasmeppc-assembled objects have default 0x10 alignment
- C-compiled objects do not have this same alignment
- Some functions have 0x00000000 padding after `blr` for alignment
- This may indicate static library boundaries (align at .a file boundaries)
- Source: revosucks (2020-08-06)

### Linker Script Extab Issues
- extab/extabindex sections need proper GROUP placement in LCF
- Using SDK template requires renaming to `extab_` and `extabindex_` until proper fix
- Source: revosucks (2020-08-05)

### CPP Exceptions Leftover
- Melee has C++ exception tables despite `-Cpp_exceptions off`
- Suggests pre-release build configuration or library linkage issues
- No actual try/catch usage in game code
- Source: werewolf.zip, revosucks (2020-08-06)

## Build Infrastructure Notes

### SDK Template Adoption
- Project migrated to use official Dolphin SDK LCF template
- Template uses MEMORY/SECTIONS with GROUP for proper ordering
- Object order now controlled via Makefile rather than hardcoded in LCF
- Eliminates SDA/SDA2 hardcoding in linker script (but not in asm files yet)
- Source: revosucks (2020-08-05)

### Progress Tracking
- calcrom.cpp modification needed for decomp progress bot
- Can calculate percentage of decompiled code vs assembly
- Source: revosucks (2020-08-06)

## Compiler Version Hunt

### Target: mwcc 2.2 (Metrowerks Embedded PowerPC)
- Melee likely compiled with mwcc 2.2.x, not 2.3.x
- Current project using 2.3.x (CW for Dolphin 1.1/1.3.2)
- mwcc 2.2 may be in "CodeWarrior for Embedded PowerPC" packages, not specifically Dolphin SDK
- Possible sources:
  - Motorola MPC500 development kits
  - M-Core compiler packages older than 2.0
  - General Embedded PowerPC toolchains
- Team searched: eBay, Fiverr, direct emails to former Metrowerks engineers
- Source: revosucks (2020-08-07, 2020-08-19)

### Version Clues
```
Embedded PPC compiler version 2.3.1 contains all improvements from MacOS "Pro 5" (version 2.3)
```
- Bug fix list for 2.2.2 includes WB1-3126, WB1-3127, IL9901-0077, IL9901-0102
- Source: revosucks (2020-08-08)
