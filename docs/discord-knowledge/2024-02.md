# Decompilation Knowledge: 2024-02

This document distills technical insights from the #smash-bros-melee Discord channel during February 2024.

## Compiler Patterns

### Literal Symbol Names (@170, @173, etc.)
- These are compiler-generated names for literals like floats (1.0f) and strings
- They are per-file, not program-wide (test.c will have different symbol names than file.c for the same 0.0f)
- The numbers appear to be related to parse IDs (nth token or similar)
- Source: chippy__, gamemasterplc (2024-02-12)

### int vs s32 Behavior
- `int` has special properties in mwcc - can generate either 8-bit or 32-bit instructions depending on context
- Sometimes generates `lbz` instead of `lwz` for function arguments
- Our `s32` definition (from Dolphin SDK) is `long`, so they are technically different types
- Melee developers seemed to prefer `int` for most cases
- Source: ribbanya (2024-02-14)

### cmplwi vs cmpwi for Pointer Detection
- If comparison uses `cmplwi` (unsigned compare), the variable is likely a pointer
- `cmpwi` (signed compare) suggests an integer
- Useful for determining parameter types when declarations are unknown
- Source: ribbanya, wyatt.wtf (2024-02-28)

### PAD_STACK and .rodata Generation
- Using `= { 0 };` in PAD_STACK macro causes .rodata to be generated
- This was fixed by removing the zero initialization
- However, removing it breaks behavior inside inlines
- Source: werewolf.zip (2024-02-19)

### Tautological Comparisons
- Some functions require invalid/tautological comparisons to match:
```c
static int DifferentTluts(HSD_Tlut* t0, HSD_Tlut* t1)
{
    return (t0->lut != t0->lut) || (t0->n_entries != t1->n_entries);
}
```
- The `-Wno-tautological-compare` warning was disabled due to this
- Source: werewolf.zip (2024-02-16)

### Inverted Constants for subi
- Some SFX IDs use inverted constants because the ASM requires `subi` instead of `addi`:
```c
Item_8026AE84(it, ~0xFFFD40C6, 0x7f, 0x40);
```
- This is rare but does occur in the codebase
- Source: werewolf.zip (2024-02-20)

## Matching Techniques

### Preventing Unwanted Inlining
- Use `#pragma dont_inline on` (not `1`) to prevent function inlining
- Also available: `#pragma inline_depth(n|smart)`
- Adding `(void)0;` at function start can sometimes prevent inlining (retail asserts leave this)
- Source: werewolf.zip, ribbanya, revosucks (2024-02-14)

### Stack Variable Ordering
- Not always same as source ordering
- Roughly sorted by size to minimize padding
- Inlines mess with stack ordering significantly
- Adding more inlines can cause stack allocation to increase in specific spots
- Source: vetroidmania, walnut356, altafen (2024-02-14)

### Fixing Stack and Register Swaps
- Calling an inline with different arguments can fix both stack layout and register swaps
- Example: https://decomp.me/scratch/S6bLg vs https://decomp.me/scratch/Bp6zu
- Usually requires finding a direct copy of function that only differs by one function call
- Source: ribbanya (2024-02-26)

### _p Macro Pattern
- HAL used macros like:
```c
#define _p(m) (((Allocator*) &g_alloc)->m)
```
- Used in asserts: `HSD_ASSERT(0x7B, _p(free_heap));`
- "p" typically stands for pointer in their naming
- Source: werewolf.zip (2024-02-14)

### Clamp Macro Discovery
```c
#define Clamp(val,min,max) (val = ((val < min) ? min : (val > max) ? max : val))
```
- Separate from HSD_ClampFloat function
- `private.h` likely contains utility macros including ABS
- Source: werewolf.zip (2024-02-15)

### GET_FIGHTER Macro
- Has been a perfectly compatible pattern since discovery
- Never fails when used correctly
- Source: ribbanya (2024-02-26)

## Type Information

### CObjDesc Union Structure
- CObjDesc is a union, not a struct (confirmed via symbols from Killer7)
- Contains redundant member copying across union variants:
```c
union {
    char* class_name;
    struct { /* common fields */ } HSD_CameraDescCommon;
    struct { /* common + frustum */ } HSD_CameraDescFrustum;
    // ortho reuses frustum struct
}
```
- Source: werewolf.zip (2024-02-01)

### BobOmbRain Structure
- `x0` field is `HSD_GObj*`, not `s32` or `enum_t`
- `x4` is `HSD_JObj*`
- Source: werewolf.zip, rtburns (2024-02-28)

### Memcard Region Base
- `804D3EE0` points to start of memcard region at `8045A6C0`
- `8045BF28` is start of unlocked character bits
- `8045D850` is end of save named tags (buffer overflow location)
- Source: werewolf.zip (2024-02-26)

### Field Offset Comment Convention
- Deprecated: `s32 x634_max_num_allocs;`
- Preferred: `/* +634 */ s32 max_num_allocs;`
- Source: ribbanya (2024-02-14)

## Function-Specific Insights

### ftData x4C Field
- Previously assumed to be CollData - this was wrong
- Actually SFX data
- Required updating many existing matches
- Source: werewolf.zip (2024-02-19)

### zakogenerator Functions
- "zako" means weak/trash generator
- Controls trash mob spawning in Adventure mode
- `grZakoGenerator_801CAE04` called by basically every stage
- May control item spawns in general
- Passes `Item_GObj*` despite function signatures sometimes showing otherwise
- Source: werewolf.zip (2024-02-22)

### lbAudioAx_800237A8
- Parameters: `(s32 sfx_id, u8 sfx_vol, u8 sfx_pan)`
- 0x7F and 0x40 are standard volume and panning values
- Could be defines since they're constant across call sites
- Source: ribbanya (2024-02-20)

### IsTrophyUnlocked (8015D984)
- Part of gmmain_lib
- Named by altimor's Ghidra database
- Oddly writes to memory despite being a "check" function
- Source: altafen (2024-02-26)

## Tool Tips

### Build System

#### Cleaning Properly
- Best way to clean is to delete the entire build directory
- `ninja -t clean` may not catch everything
- Linker processes can get stuck and lock files
- Source: encounter (2024-02-01)

#### ninja diff Command
- Use `ninja diff` to find which files broke when debugging non-matches
- objdiff doesn't make this easier on its own
- Source: encounter (2024-02-01)

#### objdiff vs asm-differ
- objdiff is less forgiving than asm-differ (which decomp.me also uses)
- Even with Levenshtein distance enabled
- objdiff considers relocations by default
- Source: ribbanya, gamemasterplc (2024-02-14)

#### Generating MAP Files
- Pass `--map` to configure.py
- Output: `build/GALE01/main.MAP`
- Linker takes longer when generating maps
- Can import into Dolphin debugger for symbols
- Source: ribbanya, revosucks (2024-02-16)

### decomp.me Usage
- For local workflow, objdiff is preferred
- decomp.me mainly useful for sharing functions needing help
- Can use m2c directly instead of decomp.py wrapper:
```sh
python -m m2c.main --target ppc-mwcc-c --context build/ctx.c build/GALE01/asm/melee/it/items/itsscope.s >src/melee/it/items/itsscope.c
```
- Regenerate context with: `python tools/m2ctx/m2ctx.py -pq`
- Source: ribbanya (2024-02-13)

### dtk Commands

#### Reverting ASM
```sh
tools/revert_asm.py src/.../foo.c
```
- For incorrect types, add `data:string` to symbols.txt entry
- Source: ribbanya (2024-02-20)

#### Building DOL from ELF
```sh
build/tools/dtk dol apply config/GALE01/config.yml build/GALE01/main.elf
```
- May add gaps (dtk bug) but can be sed'd away
- Source: ribbanya (2024-02-28)

### objdiff-cli Installation
```sh
git clone https://github.com/encounter/objdiff.git -b cli
cargo install --path objdiff/objdiff-cli
cd melee
objdiff-cli report
```
- Generates detailed per-function progress
- Source: ribbanya (2024-02-28)

### Nix Development Environment
- PR #1335 adds Nix support for reproducible builds
- `nix-shell` puts you in development environment
- Sandboxed builds without network access
- wibo with fortify hardening causes buffer overflow (use `hardeningDisable = [ "fortify" ]`)
- Compilers URL: `https://files.decomp.dev/compilers_20230715.zip`
- Source: rtburns, whovian9369 (2024-02-26-27)

## Pitfalls and Gotchas

### Unused Stack Variables
- May be real (debug/retail differences) not fake
- Retail asserts can leave stubs that declare but don't use variables
- `asm("");` is sometimes a legitimate optimization trick
- Empty `goto jump; jump:;` can prevent compiler from moving code
- Source: revosucks, werewolf.zip (2024-02-16)

### PAD_STACK Limitations
- Won't cover all cases
- Sometimes need specific types (e.g., 2 fake Vec3s instead of int _[6])
- Different allocation sizes can result from type choices
- Source: werewolf.zip (2024-02-16)

### Type Alias Casting Issues
- Item_GObj, Fighter_GObj, Ground_GObj aliases are typedefs to HSD_GObj
- decomp.me context treats them as distinct structs
- Causes unnecessary casts in code
- Can cause matches to fail when inlines are involved
- Consider modifying context directly when working on decomp.me
- Source: ribbanya, werewolf.zip, rtburns (2024-02-22)

### Circular Include Errors
- "array has incomplete element type" can be caused by circular includes
- Check if types.h or similar is including the problematic header
- Source: werewolf.zip, ribbanya (2024-02-19)

### Symbol Name Volatility
- sdata2 literal names change as files change
- Will stabilize when entire file is matched
- Can update symbols.txt to match base object but not critical
- `dtk elf config` feature exists but was broken at time of discussion
- Source: ribbanya (2024-02-12)

### PAL vs NTSC Timing
- Game/physics engine runs at same rate between PAL and NTSC
- PAL skips rendering every 6th frame
- PAL60 mode works like NTSC
- Source: camthesaxman (2024-02-19)

## Progress and Metrics

### Progress Calculation (as of late February 2024)
```json
{
  "fuzzy_match_percent": 23.460627,
  "total_size": 3894116,
  "matched_size": 845932,
  "matched_size_percent": 21.72334,
  "total_functions": 20126,
  "matched_functions": 7231,
  "matched_functions_percent": 35.92865
}
```
- `matched_size_percent` recommended as primary metric
- `matched_functions_percent` is function count only
- Source: ribbanya (2024-02-27)

### Progress Tracking
- frogress integration: https://progress.decomp.club/data/melee/
- Auto-updates via CI
- Can exclude TRK/Dolphin SDK from progress (feature requested)
- Source: ribbanya, encounter (2024-02-27)

## Cross-Project Resources

### Dolphin SDK (dolsdk2001)
- r36 SDK (1.0-1.2.5 era) being decompiled by revosucks
- Has debug and DWARF available
- O0 version available
- https://github.com/doldecomp/dolsdk2001
- Very close to Melee's SDK version (Revision 47)
- Source: revosucks (2024-02-16)

### Other Game Symbols
- Bloody Roar has same sysdolphin link order as Melee
- Killer7 has DWARF symbols (source of CObjDesc union info)
- Zoids games share symbols with Bloody Roar (both Eighting)
- Source: werewolf.zip (2024-02-01, 2024-02-05)

### Altimor's Ghidra Database
- Contains some gmmain_lib function names
- IsTrophyUnlocked, IsFeatureUnlocked, etc.
- Source: altafen (2024-02-26)
