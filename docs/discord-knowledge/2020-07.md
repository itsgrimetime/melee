# Decompilation Knowledge: July 2020

This document captures foundational knowledge from the first month of the Melee decompilation project. July 2020 marks the project's inception with critical discoveries about compiler behavior, project setup, and early matching strategies.

## Project Setup

### Target Version
- **Melee 1.02 (NTSC)** is the target version (also called "1.2" or "Revision 2")
- DOL SHA1: `08e0bf20134dfcb260699671004527b2d6bb1a45`
- ISO SHA1: `d4e70c064cc714ba8400a849cf299dbd1aa326fc`
- Versions: 1.0, 1.1, 1.02/1.2, and PAL exist; 1.02 has the most community documentation

### Compiler Version
- **MWCC (Metrowerks CodeWarrior) 1.1** is used initially
- Compiler build: `2.3.3 build 159`
- Critical discovery: **Melee likely used a pre-1.1 compiler (2.2.x)** because:
  - The 2.3 changelog notes "Function Epilogues and Prologues are now scheduled"
  - This causes epilogue/prologue ordering mismatches with 1.1
  - A postprocessor was developed to fix epilogue ordering

### MetroTRK Version Analysis
- Melee uses **MetroTRK for Dolphin v0.8**
- CW 1.1 ships with MetroTRK v0.5
- This suggests HAL updated MetroTRK but not the compiler
- Other games with same MetroTRK version don't have Melee's epilogue ordering

## Compiler Patterns

### Optimization Flags
The working compiler flags discovered:
```
-Cpp_exceptions off -proc gekko -fp hard -O4,p -nodefaults
```

Key findings:
- `-O4,p` means optimization level 4 with "peephole" scheduling
- **Flag order matters**: `-proc gekko -O4,p` vs `-O4,p -proc gekko` produces different scheduling
- When `-O4,p` comes first, scheduler uses "generic PPC" instead of the specified proc
- Source: werewolf.zip, revosucks (2020-07-24)

### Processor Targeting
- `-proc gekko` is for GameCube's Gekko processor
- `-proc 750` and `-proc generic` produce different codegen
- **`__PPCGEKKO__` define is NOT set** in Melee's build, confirmed by examining `longjmp` at 0x80322840
- This suggests `-proc gekko` may not have been passed, or was overridden
- Source: werewolf.zip (2020-07-08)

### Float Handling
- `-fp hard` enables hardware floating point
- `-fp_contract on` enables fused multiply-add instructions (fmadds)
- However, the pragma `#pragma fp_contract on` must be used - the flag alone doesn't work
- Source: camthesaxman (2020-07-05)

### Small Data Area (SDA)
- Variables <= 8 bytes go in `.sdata` (r13-relative) or `.sbss`
- Read-only small data goes in `.sdata2` (r2-relative)
- The linker automatically generates r13/r2-relative loads for appropriately sized variables
- `_SDA_BASE_ = 0x804DB6A0`
- `_SDA2_BASE_ = 0x804DF9E0`

### Int-to-Float Conversion Constants
Each translation unit that uses int-to-float conversion gets its own copy of magic constants:
- Signed: `0x4330000080000000`
- Unsigned: `0x4330000000000000`
- These duplications help identify file boundaries (283+ boundaries found this way)
- Source: gamemasterplc (2020-07-02)

### The `asm` Keyword Side Effects
**Critical discovery**: Using `asm` functions in a file affects OTHER functions' codegen:
- `asm` disables peephole optimization on ALL subsequent functions in the file
- Fix: Add `#pragma peephole on` after asm functions to restore optimization
- This makes inline assembly problematic for nonmatching stubs
- Source: werewolf.zip, revosucks (2020-07-30)

### Inline Function Behavior
- `inline` keyword is a suggestion, not mandatory
- `-inline auto` enables automatic inlining at compiler discretion
- `-inline deferred` allows inlining functions before their definition
- `-inline smart` does 4 passes, limiting later passes to small functions
- Source: gamemasterplc (2020-07-07)

### Jump Tables
- Switch statements with 5+ consecutive cases become jump tables
- Jump tables are placed in `.data` section (not `.rodata`)
- Pattern: Uses `bctr` instruction (vs `bctrl` for function pointers)
- Small switches become nested if-else chains with binary search pattern
- Source: werewolf.zip, gamemasterplc (2020-07-02)

### String Literals
- Strings < 8 bytes go in `.sdata`
- Larger strings go in `.data` (not `.rodata` like some compilers)
- Source: gamemasterplc (2020-07-01)

### LMW/STMW Instructions
- `lmw`/`stmw` (load/store multiple words) are off by default
- Controlled by `-use_lmw_stmw on/off`
- Using `-proc gekko` before `-O4,p` incorrectly enables these
- Source: werewolf.zip (2020-07-24)

## Matching Techniques

### The Ten Rules of Matching
```
Rule 1: When in doubt, scrub C
Rule 2: Never assume it won't get optimized out
Rule 3: When the answer is elusive, never rule out a typo
Rule 4: Always be prepared to cram a square peg into a circle hole
Rule 5: If you still can't get it to match, it's a combination you think you tried but haven't
Rule 6: Volatile is a dangerous magic sauce that may explode
Rule 7: If you're afraid you need to use math, be
Rule 8: If you think you understand the compiler, the compiler will tell you you don't
Rule 10: Rule 9 was optimized out
```
Source: revosucks (2020-07-03)

### Register Allocation Tricks

**Volatile for forcing register usage:**
```c
// Forces specific register ordering in loads
float f0 = ((volatile float *)b)[0];
float f1 = ((volatile float *)a)[0];
```
Source: camthesaxman (2020-07-02)

**Extern vs literal affects fcmpu operand order:**
```c
// Using extern reverses fcmpu operands compared to literal 0.0f
if (lbl_804D7AA8 == f4)  // Uses extern constant
```
Source: camthesaxman (2020-07-02)

**Local array for stack offset control:**
```c
// Using array can force different stack offsets
float foo[2];
foo[1] = sqrtf(...);
// vs single variable which may be placed differently
```
Source: revosucks (2020-07-02)

### Prologue/Epilogue Scheduling Fix
The main compiler version issue manifests as incorrect epilogue ordering:
```
Expected:          Generated:
addi r1,r1,N       mtlr r0
mtlr r0            addi r1,r1,N
blr                blr
```

**Workaround using postprocessor:** A Python script patches the `.o` files to swap the epilogue ordering.

**Pragma workaround (partial):**
```c
#pragma push
#pragma altivec_codegen on
#pragma altivec_model on
void problem_function(...) {
    // This fixes epilogue for some functions
}
#pragma pop
```
However, this breaks other functions - not a universal solution.
Source: revosucks, werewolf.zip (2020-07-09, 2020-07-29)

### Control Flow Permutations
Different C constructs produce different codegen:
```c
// Version A - may produce mr. optimization
if (aobj != NULL && aobj->fobj) { ... }

// Version B - may NOT produce mr. optimization
if (aobj) {
    if (aobj->fobj) { ... }
}

// Early return changes codegen
if (!aobj) return;
// ... rest of function
```

The `mr.` instruction (move register and set condition) is an optimization for NULL checks that requires specific C patterns.
Source: werewolf.zip, revosucks (2020-07-03, 2020-07-04)

### Bitfield Operations
Order of operations matters for register allocation:
```c
// May use different registers depending on ordering
flags &= (AOBJ_LOOP | AOBJ_NO_UPDATE);
aobj->flags = aobj->flags & ~(flags);

// vs
aobj->flags &= ~(flags & (AOBJ_LOOP | AOBJ_NO_UPDATE));
```
Source: revosucks (2020-07-04)

### Function Prototypes Affect Codegen
**Critical discovery**: Having a function prototype changes prologue scheduling!
```c
// Without prototype - one codegen
void func() { external_call(); }

// With prototype - different prologue ordering
void external_call(void);
void func() { external_call(); }
```
Source: revosucks (2020-07-09)

## Type Information

### HSD Object Naming Convention
The sysdolphin library uses single-letter prefixes:
- **A**Obj - Animation Object
- **C**Obj - Camera Object
- **D**Obj - Data Object (display list)
- **F**Obj - Frame Object
- **G**Obj - Game Object (universal container)
- **J**Obj - Joint Object
- **L**Obj - Light Object
- **M**Obj - Material Object
- **P**Obj - Polygon Object
- **R**Obj - Reference Object (attachments/bytecode)
- **T**Obj - Texture Object
- **W**Obj - World Object

Source: werewolf.zip (2020-07-05)

### Sysdolphin File Boundaries (from Killer7 debug symbols)
```
mobj.c    = 0x80362D30 - 0x80363FC4
aobj.c    = 0x80363FC8 - 0x80365398
lobj.c    = 0x8036539C - 0x803676F4
cobj.c    = 0x803676F8 - 0x8036A940
fobj.c    = 0x8036A944 - 0x8036B8CC
pobj.c    = 0x8036B8D0 - 0x8036EC0C
jobj.c    = 0x8036EC10 - 0x8037389C
displayfunc.c = 0x803738A0 - 0x80374E44
initialize.c  = 0x80374E48 - 0x80375888
video.c   = 0x8037588C - 0x80376998
pad.c     = 0x8037699C - 0x80378A30
objalloc.c = 0x8037A968 - 0x8037AE30
id.c      = 0x8037CD80 - 0x8037D04C
wobj.c    = 0x8037D050 - 0x8037D96C
fog.c     = 0x8037D970 - 0x8037E1B8
perf.c    = 0x8037E1BC - 0x8037E3F8
list.c    = 0x8037E3FC - 0x8037E6C0
object.c  = 0x8037E6C4 - 0x8037E704
```
Source: werewolf.zip (2020-07-02)

### Section Layout
```
.init     @ 0x80003100  (text0)
.text     @ 0x80005940  (text1 - main game code)
.extab    @ 0x80005520  (data0 - C++ exception tables)
.extabindex @ 0x800056C0 (data1)
.ctors    @ 0x803B7240  (data2)
.dtors    @ 0x803B7260  (data3)
.rodata   @ 0x803B7280  (data4)
.data     @ 0x803B9840  (data5)
.sdata    @ 0x804D36A0  (data6)
.sdata2   @ 0x804D79E0  (data7)
.bss      @ 0x804316C0
.sbss     @ 0x804D63A0
```
Source: gamemasterplc, camthesaxman (2020-07-01)

### Important Addresses
- Entry point: `0x8000522C`
- Main function: `0x8015FEB4`
- First hitbox-related functions are near the start of .text

## Function-Specific Insights

### Intrinsic Functions
MWCC has built-in intrinsics that don't need declarations:
- `__frsqrte(double)` - Reciprocal square root estimate
- `__fnmsub(double, double, double)` - Fused negative multiply-subtract
- `__cntlzw(int)` - Count leading zeros
- `__memset` - Built-in memset

The SDK's `math_ppc.h` contains inline implementations using these intrinsics.
Source: gamemasterplc, camthesaxman (2020-07-02)

### Variadic Functions
Variadic functions use `cr1` to decide whether to save float parameters:
```asm
# cr1 check pattern indicates variadic function
creqv   6, 6, 6  # Set cr1 bit 6
```
Source: gamemasterplc, ma.de (2020-07-01)

### PSVECCrossProduct
Function at `0x80342E58` uses paired single instructions and is `PSVECCrossProduct` from the SDK's vector-matrix library. These functions use handwritten assembly and cannot be matched with C.
Source: gamemasterplc (2020-07-05)

## Tool Tips

### Linker
- `mwldeppc.exe -dis file.o` - Disassemble object file
- `FORCEFILES` directive prevents linker from discarding "unused" sections
- `FORCEACTIVE` for specific symbols
- Linker does partial filename matching - `debug.o` can conflict with `dsp_debug.o`
- Link times are O(n^2) on symbol count; splitting files dramatically improves speed

### Build System
- Dolphin emulator can load extracted filesystem directly (no ISO rebuild needed)
- Right-click game -> Properties -> Filesystem -> Extract to get DOL

### Debugging Symbols
- Interactive Multi-Game Demo Disk 2004 has full TRK debug symbols
- Killer7 has unoptimized sysdolphin with DWARF v1 debug info
- HAL Resource Tool contains struct definitions for many HSD types

## Pitfalls and Gotchas

### Things That Cause Mismatches

1. **`asm` keyword presence** - Affects peephole optimization on ALL subsequent functions
2. **Function prototype presence** - Changes prologue scheduling
3. **Flag order** - `-proc gekko -O4,p` vs `-O4,p -proc gekko` have different behavior
4. **Literal vs extern constants** - Can reverse `fcmpu` operand order
5. **`!= NULL` vs implicit check** - Different codegen for NULL comparisons
6. **Control flow structure** - `if(a && b)` vs nested `if` produces different code

### Nonmatching Strategy
Since `asm` functions affect other functions, use a postprocessing approach:
1. Write C that produces correct-size functions (using volatile writes if needed)
2. Inject correct assembly into the `.o` file after compilation
3. Use `#ifdef NONMATCHING` to keep the readable C version available

### Linker Quirks
- `extab` section name is treated specially; may need different naming
- Partial filename matching can cause wrong file insertion
- Empty/stub functions may be ignored even with `FORCEACTIVE`
- Files with similar names (e.g., `id.o` and `grkraid.o`) may conflict

### Cross-File Dependencies
- Constants are NOT shared across translation units (no LTO)
- Each file gets its own copy of int-to-float conversion constants
- Inline functions are duplicated in every file that uses them

## Resources

### External References
- HAL Resource Tool: https://archive.org/details/halresourcetool
- Melee community documentation spreadsheet (struct layouts)
- FRAY (non-matching decomp): https://github.com/PsiLupan/FRAY
- Linker map documentation: https://github.com/hosaka-corp/melee-re/blob/master/docs/LINKERMAP.md

### Debug Symbol Sources
- Killer7 - Sysdolphin DWARF v1 symbols
- Zoids games - Some HSD symbols
- Bloody Roar: Primal Fury - Additional HSD coverage
- Interactive Multi-Game Demo Disk - TRK symbols
