# Decompilation Knowledge: July-December 2023

This document distills technical knowledge from the `#smash-bros-melee` channel in the gc-wii-decomp Discord server during the second half of 2023. This period saw significant progress (from ~17% to ~18.3%) with major contributions to sysdolphin libraries (FObj, AObj, PObj, LObj, RObj, video.c) and various ground/item files.

---

## Compiler Patterns

### The 1.2.5n Hotfix Compiler
- **Ninji's patch (mwcceppc 1.2.5n)** is the correct hotfix for the epilogue scheduling bug, replacing "frank" (the previous workaround)
- The patch adds `fSideEffects` to the `addi r1, r1, x` instruction (or `lwz r1, 0(r1)` for dynamic stack functions)
- This replicates what Metrowerks did in build 167
- **Use 1.2.5n for all "hotfix" code** - do not use frank anymore
- The decomp.me Melee preset uses 1.2.5n in the background
- Source: Ninji, revosucks (2023-07-15)

### Register Allocation Reference
Standard PPC register conventions for mwcc:
- `r1`: Stack pointer
- `r2`, `r13`: Pointers to data sections (sdata/sdata2)
- `r3-r10`: Function arguments
- `r3`: Function return value
- `r0`, `r14-r31`: Local variables
- `r3-r12`: Can also be used as locals
- `r11`: Stack frame pointer (certain optimizations)
- `r12`: Reserved for calling variable functions
- Source: altafen (2023-07-13)

### Stack Size Sensitivity
- Extra variables can increase/decrease stack size unexpectedly
- Inlines can increase stack size
- Compiler version 1.2.5 is "extremely picky" about this
- Source: chippy__ (2023-10-29)

### Subfic Hack Pattern
The `var -= immediate` subfic assembly pattern is really just `i = var = 0`:
```c
// When you see subfic in asm for subtraction
// The actual C is often simpler assignment
i = var = 0;
```
- Source: vetroidmania (2023-10-17)

### Self-Assignment Trick
When seeing `rlwimi` vs `ori` differences in bitfield operations:
```c
// Sometimes you need explicit self-assignment to get the right codegen
state = state;
```
- Source: werewolf.zip (2023-09-22) - used to match FObj

---

## Matching Techniques

### GET_FIGHTER and Similar Accessors
- Item callbacks accessing `item->xDD4_itemVar` need an accessor that casts to the appropriate item type
- This consumes an additional 4 bytes of stack space
- Similar pattern to `GET_FIGHTER` and `GET_JOBJ` macros
- Source: rtburns (2023-07-01)

### Fake Stack Variables
When stack size doesn't match but code is otherwise correct:
```c
// Missing 8 bytes of stack often indicates a stripped inline function
// Missing 4 bytes might just be an unused variable
HSD_JObj* bone_jobj = fp->parts[FtPart_LLegJA].joint;
// This line may be completely stripped by compiler but affect stack
```
- Source: werewolf.zip, ribbanya (2023-10-09)

### Float Literals vs Extern Floats
- Many functions appear non-matching due to extern float declarations
- Using actual float literals instead of externs often fixes matches
- The ftPurin functions needed file splits and using actual floats instead of externs
- Source: werewolf.zip (2023-09-18)

### Decimal vs Hex in Data
When data doesn't match:
```c
// Wrong - compiler may generate different instruction
StageData data = { 26, ... };

// Correct - use hex for stage IDs
StageData data = { 0x26, ... };
```
- Source: rtburns (2023-09-12)

### sdata vs sdata2 Placement
- `sdata` is for variables (non-const)
- `sdata2` is for constants
- If floats appear in wrong section, check `const` qualifier
- Using literals instead of named constants can fix section placement issues
- Source: ribbanya (2023-12-19)

### Local Label Format
- `.L_` labels in asm don't work with mwcc
- Replace with `lbl_` prefix for m2c compatibility
- The dump branch uses `lbl_` format
- Source: ribbanya (2023-10-27)

### Helmite Spline Variable Naming
Debug symbols from K7 reveal actual variable names for math functions:
```c
f32 splGetHelmite(f32 fterm, f32 time, f32 p0, f32 p1, f32 d0, f32 d1)
{
    f32 _3t2_T2;
    f32 _2t3_T3;
    f32 t3_T2;
    f32 t2_T;
    f32 t2;
    f32 _1_T2;
    // ...
}
```
- Variable names indicate the mathematical terms being computed
- Source: werewolf.zip (2023-09-24)

---

## Type Information

### HSD_GObj Size
- `HSD_GObj` is confirmed to be `0x38` bytes
- Init info found at `803914A0`
- Source: altafen (2023-11-20)

### ftCollisionBox vs ftECB
- `ftCollisionBox` has floats for top/bottom:
```c
struct ftCollisionBox {
    float top;
    float bottom;
    Vec2 left;
    Vec2 right;
};
```
- `ftECB` has `Vec2` for all four points
- Some functions incorrectly use `ftECB` when they should use `ftCollisionBox`
- `mpColl_80042C58` uses this structure
- Source: altafen (2023-11-20)

### Ground Structs
- Grounds have an area similar to FighterVars at `gp->xC4`
- Same offset can be accessed as different types (short, HSD_TObj*, HSD_JObj*)
- This is a union pattern
- Source: altafen (2023-08-20)

### DVDFileInfo Size Bug
- `DVDFileInfo` in the decomp is larger than what Melee used
- `DVDFastOpen` writes to offset `0x38` (callback) which can corrupt memory with old struct size
- Workaround: Create `OldDVDFileInfo` struct for affected functions:
```c
typedef struct OldDVDFileInfo {
    DVDCommandBlock cb;
    u32 startAddr;
    u32 length;
} OldDVDFileInfo;
```
- This is an actual bug in the original game code
- Source: werewolf.zip (2023-09-13)

### ItemCommonData Type Issue
- Field `x8` changed from `f32` to `u32` at some point
- Affects scratches using this struct
- Source: altafen, kiwidev (2023-09-13)

### HSD_ByteCodeEval Debug Info
Completely unused function with full debug symbols from K7:
```
HSD_ByteCodeEval(u8* bytecode, f32* args, s32 nb_args)
Local variables: stack, i, last_command, operand_count, operand, list, f, f0, f1, d0, d1
```
- Function at `802e4988-802e6080`
- Referenced by RObj but never actually called by the game
- Source: werewolf.zip (2023-09-25)

---

## Function-Specific Insights

### Callback Naming Convention
HAL used `proc` for callbacks internally:
```
fighter procUpdate pos error.   pos.x=%f        pos.y=%f
fighter procMap pos error.      pos.x=%f        pos.y=%f
Other Dead_Proc Existence
```
- `procUpdate` corresponds to animation callback
- HSD uses `pre_cb`, `post_cb`, `drawdone.cb` patterns
- Recommend using `_cb` suffix: `render_cb`, `anim_cb`, `phys_cb`
- Source: vetroidmania, werewolf.zip, ribbanya (2023-10-09)

### HSD_CObjSetCurrent
- Takes only 1 argument, not 2
- Previous match with 2 args was incorrect
- The second arg was render pass but was never actually used
- Contains inlined `setupNormalCamera` function
- Source: werewolf.zip (2023-10-14)

### Item Spawn Functions
```c
// Airborne spawns
HSD_GObj* Item_80268B18(SpawnItem* spawnItem);

// Ground spawns
void Item_80268B5C(SpawnItem* spawnItem);
```
- Source: werewolf.zip (2023-09-18)

### Library Mysteries
No debug info found for these HSD libraries:
- JPEG
- THP
- SIS (text/menu related - see HSDLib's `SIS_MenuData.cs`)
- Source: rtburns, werewolf.zip (2023-09-25)

---

## Tool Tips

### decomp.me Workflow
1. Create new scratch with asm from one function
2. Use the Melee preset (auto-selects correct compiler/flags)
3. Functions in `asm/melee/it/items/` are good starting points
4. Use context from https://doldecomp.github.io/melee/ctx.html
- Source: rtburns, altafen (2023-07-13)

### Context Generator Limitations
- Does not preserve `AT_ADDRESS` macro for hardware registers
- WGPIPE and similar hardware register definitions don't match properly
- Manual setup required for anything using hardware registers
- Source: werewolf.zip (2023-09-26)

### objdiff Setup
- Remove `.c.o` and `.s.o` extensions to make objdiff work
- Disable build calls in objdiff
- Reference commit: `e05312dd333b6eb3c79f09c964bf5c43d7f0bfc4`
- Can generate `objdiff.json` for persistent config
- Source: altafen (2023-09-13), encounter (2023-11-21)

### asm-differ Scoring
- Score of 0 = complete match
- Higher score = more bytes not matching
- Regswaps penalize less than reorders
- decomp.me and asm-differ use similar scoring mechanisms
- Source: ribbanya (2023-09-27)

### Permuter
- https://github.com/simonlindholm/decomp-permuter
- Useful for final differences like regalloc
- Randomly permutes C statements to find matches
- Most effective when "1 diff away"
- Source: revosucks (2023-12-17)

### Local Build Requirements
```bash
# Generate map file for function names
make GENERATE_MAP=1

# Progress only prints if map is generated
# Map location: build/ssbm.us.1.2/GALE01.map
```
- Source: rtburns (2023-12-20)

### Finding Functions
- `obj_files.mk` maps the executable to files
- `asm/` contains undecompiled functions
- `src/` contains decompiled code
- Files with offsets as names are not fully identified
- Source: revosucks (2023-12-17)

### Training Scratch
https://decomp.me/scratch/I6vWF - Training exercises with answer key
- Source: revosucks (2023-12-17)

---

## Pitfalls and Gotchas

### decomp.me Preset Reset
- decomp.me sometimes randomly resets the preset when clicking "New"
- Especially happens when the site is slow
- Always verify compiler settings before debugging other issues
- Source: werewolf.zip (2023-12-20)

### math.h Header Conflicts
- Including math.h can cause sdata2 mismatches in some TUs
- grizumi.c stops matching if math.h is included
- Use intrinsics.h for `__frsqrte` instead
- Source: altafen, ribbanya (2023-10-14)

### Windows Build Considerations
- Windows builds are slower on GitHub Actions
- WSL2 is "extremely slow" for compiling Melee
- mingw provides bash and make, lighter than msys2
- Multiple bash environments (WSL, git bash, mingw) cause confusion
- Source: revosucks, altafen, ribbanya (2023-11-20)

### Inline Detection
- Many functions have unused stack space suggesting stripped inlines
- Ness has ~8 functions with inlined yoyo code that matches without explicit inlines
- "We're just fake matching in a lot of cases"
- Source: werewolf.zip, vetroidmania (2023-10-30)

### Stub Functions
```asm
.global grTMario_8021FB4C
grTMario_8021FB4C:
    blr
.L_8021FB50:
    mflr r0
    ...
```
- A `blr` followed by more code indicates two separate functions
- First is a stub (immediately returns)
- The `.L_` label starts a new function
- Source: werewolf.zip (2023-12-18)

---

## Progress Milestones

### Major Completions (Jul-Dec 2023)
- **FObj fully matched** - "Eat my ass, HAL" (werewolf.zip, 2023-09-22)
- **AObj fully matched** (werewolf.zip, 2023-09-24)
- **PObj fully matched** - ~0.34% jump, new trophy (werewolf.zip, 2023-09-26)
- **LObj matched** (werewolf.zip, 2023-09-27)
- **video.c matched** - ~0.12% jump (werewolf.zip, 2023-12-20)
- **grIzumi.c (Fountain of Dreams)** matched (altafen, 2023-10-14)

### Progress Tracking
- July: ~17.2%
- September: ~17.9% (52 trophies)
- October: ~18.14% (53 trophies)
- November: ~18.16% (53 trophies)
- December: ~18.3%

### Code Statistics
- Melee DOL: ~3.9MB of code total
- Line count (naive): ~63k semicolons in src/
- Source: werewolf.zip, ribbanya (2023-09-13, 2023-10-23)

---

## Project Infrastructure

### Frogress Integration
- Project set up at https://github.com/decompals/frogress
- Enables progress badges and graphs
- API key stored as `PROGRESS_API_KEY` in repo secrets
- Source: encounter, ribbanya (2023-08-18)

### Documentation Links
- **Context for decomp.me**: https://doldecomp.github.io/melee/ctx.html
- **Progress page**: https://doldecomp.github.io/melee/progress/
- **Asm dump**: https://doldecomp.github.io/melee/dump/
- **TU assignments**: https://github.com/doldecomp/melee/wiki/Translation-Units
- **All Melee scratches**: https://decomp.me/preset/63
- Source: ribbanya (2023-11-02)

### Toolchain Evolution
- dtk (decomp-toolkit) being adopted for builds
- Will replace make with ninja for faster Windows builds
- Will eliminate need for asm files on repo (generate on-demand)
- Windows-native support without mingw/msys2
- Source: ribbanya (2023-12-19)

---

## Workflow Examples

### Basic Decompilation Flow
1. Find undecompiled function in `asm/` directory
2. Create scratch on decomp.me with Melee preset
3. Paste asm for single function (starts at `.global`, ends at `blr`)
4. Use m2c output as starting point
5. Fix types, clean up code until it compiles
6. Iterate until diff shows 0
7. Copy matched code to src file
8. Run `make` to verify overall build still matches

### Unknown Struct Convention
```c
// For unknown structs, use address-based naming:
UnkStruct8005C22C         // General unknown struct
UnkInputStruct8005C22C    // Unknown struct passed as argument
UnkStruct8005C22C_Temp_R3 // Stack variable
```
- Source: revosucks (2023-12-17)

### New Contributor Starting Points
- `asm/melee/it/items/` - Simple item callbacks
- Training scratch with exercises: https://decomp.me/scratch/I6vWF
- Ask questions in #match-help or main channel
- Post scratches for feedback
- Source: rtburns, ribbanya, revosucks (2023-08-12, 2023-12-17)
