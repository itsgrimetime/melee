# Decompilation Knowledge: August 2022

## Compiler Patterns

### Peephole Optimization Bug After Inline ASM
- Metrowerks has a bug in 1.0-1.2.5 where using an `asm{}` function disables peephole optimization and forgets to re-enable it afterwards
- **Workaround**: Always add `#pragma peephole on` after each inline asm function
- Source: revosucks (2022-08-14)

```c
asm void whatever(void) {
  nofralloc
  // paste asm here
}
#pragma peephole on
```

### Float Conversion Constants
- The compiler automatically generates conversion constants for int-to-float conversions
- There's one conversion constant for signed integers and another for unsigned integers
- These constants (like `lbl_804DE4D8`) are used when converting integer values to floats
- Source: gibhaltmannkill, revosucks (2022-08-21)

### sqrtf Inline Implementation
- HAL used a custom sqrtf inline from Metrowerks CW includes
- The implementation uses Newton-Raphson iterations via `__frsqrte`:

```c
extern inline float sqrtf(float x)
{
  static const double _half=.5;
  static const double _three=3.0;
  volatile float y;
  if(x > 0.0f)
  {
    double guess = __frsqrte((double)x);   // returns an approximation
    guess = _half*guess*(_three - guess*guess*x);  // now have 12 sig bits
    guess = _half*guess*(_three - guess*guess*x);  // now have 24 sig bits
    guess = _half*guess*(_three - guess*guess*x);  // now have 32 sig bits
    y=(float)(x*guess);
    return y;
  }
  return x;
}
```

- There are multiple sqrtf inlines floating around in the codebase
- The 0.5 and 3.0 constants may appear as floats instead of doubles in some variants
- Bug in version 1.0: `sqrt(0)` returns infinity instead of 0 (fixed in 1.1)
- Source: revosucks, altafen (2022-08-14)

### Division by Constants Using MULT_HI
- Division/modulo by constants like 60 get optimized to `mulhw` (multiply high word) instructions
- Example: `MULT_HI(x, 0x88888889) >> 5` is equivalent to `x / 60`
- M2C decompiles `mulhw` to `MULT_HI(...)` macro calls
- Source: waynebird, altafen (2022-08-14)

### Static Variables and Data Sections

**Section allocation rules:**
- `.bss` - uninitialized data
- `.data` - non-const initialized objects
- `.rodata` - const (read-only) initialized objects
- If an object is 8 bytes or smaller, it goes into small sections: `.sbss`, `.sdata`, or `.sdata2`
- `.sdata2` is for small const stuff (the small version of `.rodata`)
- Float and double literals, as well as struct/array initializers within functions, go into `.rodata` or `.sdata2` depending on size
- **Exception**: String literals go into `.data` or `.sdata` (not rodata)

**Access patterns:**
- Small data accessed via `r13` register (`.sdata`, `.sbss`)
- Small const data accessed via `r2` register (`.sdata2`)
- Removing `const static` from data makes it go into r13 instead of rodata
- Source: camthesaxman (2022-08-17)

### Function Ordering in Object Files
- Functions in .c and .s files must be in the same order as they appear in the original DOL
- The order in the map file shows: `[c file] → functions → [s file]`
- If you decompile functions out of order, you need to either:
  1. Keep them in separate files and order them correctly in the build
  2. Embed asm functions directly in the C file
- Source: revosucks, altafen (2022-08-14)

### Struct Passed by Value on Stack
- Structs over 8 bytes passed by value will always be on the stack
- Smaller structs may also be on stack depending on member layout
- Normal args can be put on stack if there's not enough registers
- Source: seekyct (2022-08-28)

## Matching Techniques

### The (s64) Cast / 64-bit AND Trick
- Adding `(s64)` cast or `& 0xFFFFFFFFFFFFFFFF` can fix certain regswaps
- This is traditionally an "IDO trick" but works with Metrowerks in some cases
- Source: altafen (2022-08-14)

### Explicit (s32) Casts on Division
- Removing explicit `(s32)` cast from division can change generated code even when the variable is already s32
- Example: `(s32) temp_r6 / 60` generates different code than `temp_r6 / 60` even if temp_r6 is s32
- Source: waynebird (2022-08-14)

### Local Variables for Struct Literals
- Struct literals in rodata are deduplicated across functions but not within the same function
- To match code that reuses the same literal values, assign to local variables:

```c
Vec const position = {0.0F, 0.0F, 0.0F};
Vec const interest = {0.0F, 0.0F, 0.0F};

void HSD_LObjGetLightVector(HSD_LObj *lobj, VecPtr dir)
{
    Vec p = position;
    Vec i = interest;
    // use p and i instead of position and interest
}
```

- Source: rtburns (2022-08-23)

### MIN/MAX Macros
- Using `#define MIN(a,b) ((a)<(b)?(a):(b))` can help match certain patterns
- Always properly parenthesize macros:
  - Wrap the whole expression in parentheses
  - Wrap each argument usage in parentheses
  - Ideally only use each argument once

```c
#define CLIFFCATCH_0(fp) (((fp)->x2C < 0) ? LEFT : RIGHT)
```

- Source: altafen, kiwidev (2022-08-21)

### Matching Animate Inlines
- Pattern of "read from jobj, call HSD_AObjReqAnim, call HSD_AObjSetRate" is often an inline function
- Source: altafen (2022-08-14)

### Prototype for __frsqrte
- If permuter chokes on `__frsqrte`, add a prototype:

```c
double __frsqrte(double);
```

- Source: camthesaxman (2022-08-14)

## Type Information

### Collision Flags (CollData)
```c
#define Collide_LeftWallPush 0x1
#define Collide_LeftWallHug 0x20
#define Collide_LeftWallMask 0x3F
#define Collide_RightWallPush 0x40
#define Collide_RightWallHug 0x800
#define Collide_RightWallMask 0xFC0
#define Collide_CeilingPush 0x2000
#define Collide_CeilingHug 0x4000
#define Collide_FloorPush 0x8000
#define Collide_FloorHug 0x10000
#define Collide_LeftEdge 0x100000
#define Collide_RightEdge 0x200000
#define Collide_Edge 0x800000
#define Collide_LeftLedgeGrab 0x1000000
#define Collide_RightLedgeGrab 0x2000000
#define Collide_LeftLedgeSlip 0x10000000
#define Collide_RightLedgeSlip 0x20000000

#define CollisionFlagAir_StayAirborne 0x1
#define CollisionFlagAir_PlatformPassCallback 0x2
#define CollisionFlagAir_CanGrabLedge 0x4
```
- Source: altafen (2022-08-21)

### CollData Union at x104
- CollData has a union starting at offset x104 (size 0x2C)
- x104 acts as a tag for whether it contains floats or JObj pointers
- When x104 == 2: Contains floats (ECB dimensions + rotation angle)
  - x108: top_y
  - x10C: bottom_y
  - x110: right_x
  - x114: left_x
  - x118: angle (in radians)
- When x104 != 2: Contains JObj pointers
- Error message: `"not support rotate at JObj type coll\n"` + infinite loop on type mismatch
- Source: altafen (2022-08-21)

### GObj Classes
```c
#define GOBJ_CLASS_STAGE 0x2
#define GOBJ_CLASS_CAMERA_RUMBLE 0x3
#define GOBJ_CLASS_PLAYER 0x4
#define GOBJ_CLASS_ITEM 0x6
#define GOBJ_CLASS_CHAIN_ITEM 0x7  // Chain-type items in-game
#define GOBJ_CLASS_GFX 0x8
#define GOBJ_CLASS_TEXT 0x9
#define GOBJ_CLASS_HSD_FOG 0xA
#define GOBJ_CLASS_HSD_LOBJ 0xB
#define GOBJ_CLASS_HSD_COBJ_TITLE 0x13
```
- Class 7 user_data struct varies based on which scene is running
- Source: werewolf.zip (2022-08-27)

### GObj_Create Signature
- `HSD_GObj* GObj_Create(GObjClass class, GObjPLink p_link, byte p_prio)`
- The function is a wrapper around `func_8038FFB8`
- Source: altafen (2022-08-15)

### Timer Display Structure
- Value at 0x8046DB68 bit 2 determines whether the pause HUD (LRAS graphic) renders when paused
- Source: waynebird (2022-08-14)

## Function-Specific Insights

### func_8000AFBC
- Returns OSTicksToSeconds
- Source: b_squo (2022-08-16)

### func_80046904 (mpcoll)
- Uses collision ECB calculations
- Related to ECB bones and position updates
- Contains debug message: `"Error:oioi... id=%d\n"` ("oioi" is Japanese for "wtf")
- Source: altafen, ribbanya (2022-08-21)

### Extern Static Variable Access
- C allows accessing another function's static variable by externing from within a different function
- Banjo Kazooie relies on this pattern for a match
- Example from BK:

```c
// In func_8038FDE0:
static f32 D_803912CC;

// In func_8038FF70:
extern f32 D_803912CC; // Access the static from above
```

- Source: revosucks (2022-08-17)

## Tool Tips

### decomp.me
- decomp.me is probably slightly more accurate than permuter's scorer, but don't trust either too much
- To toggle Frank (epilogue processing): Change compiler from `1.2.5e` to `1.2.5`
- Setting `EPILOGUE_PROCESS` controls Frank
- Source: simonlindholm, altafen (2022-08-01, 2022-08-22)

### asm-differ Setup
```bash
# Build first with:
./build.sh -fme  # frank map expected

# Run differ:
python tools/asm-differ/diff.py -wos <func_name>

# Regen expected:
tools/build.sh && rsync -a --delete build/ expected/build/
```
- Dependencies: Need to source venv first
- Source: ribbanya, altafen (2022-08-26)

### Python venv Activation
- Use `. venv/bin/activate` (dot with space), NOT `./venv/bin/activate`
- The dot is shorthand for `source`
- Windows uses `venv/Scripts/` instead of `venv/bin/`
- Source: altafen (2022-08-18)

### calcprogress Script
- New version uses TU sections instead of symbols
- Pass `--old-map=true` for older map format
- Command: `python tools/calcprogress.py --dol=build/ssbm.us.1.2/main.dol --map=build/ssbm.us.1.2/GALE01.map --asm-obj-ext=.s.o --old-map=true`
- Map format changed between CW 2.6 and 2.7 (added file offset column)
- Source: kiwidev (2022-08-24)

### Ghidra Tips
- To see full strings: hover over the truncated string, or click and Ctrl+C to copy the whole thing
- Ghidra has a program diff feature for comparing binaries
- Source: kiwidev, ribbanya (2022-08-19)

### Inline ASM entry Directive
- The `entry` directive lets you export labels inside a function as globals
- Syntax: `entry YourNameHere` on its own line inside asm block
- You must also forward declare it as a function in C
- Works with Melee's version of CodeWarrior
- Source: seekyct (2022-08-21)

### Symbol Replacement Script
```python
from elftools.elf.elffile import ELFFile

f = open(debug_elf, "rb")
e = ELFFile(f)
symtab = e.get_section_by_name(".symtab")
symbols = [x for x in symtab.iter_symbols()]

for fname in asm_files:
    f = open(fname, "r")
    file_text = f.read()
    f.close()

    for sym in symbols:
        if sym.entry.st_info.bind != "STB_LOCAL":
            hexstr = hex(sym.entry.st_value)[2:].upper()
            file_text = file_text.replace(f"lbl_{hexstr}", sym.name)
            file_text = file_text.replace(f"func_{hexstr}", sym.name)

    f = open(fname, "w")
    f.write(file_text)
    f.close()
```
- Uses pyelftools library
- Source: rtburns (2022-08-27)

## Pitfalls and Gotchas

### C/S File Order in Build
- The order of .c and .s files in the build determines symbol placement in DOL
- If functions compile to wrong addresses, check the build order
- Map file shows section sizes - compare to expected to find mismatches
- Source: revosucks, ribbanya (2022-08-14, 2022-08-27)

### Frank Bugs
- Frank (epilogue scheduling patch) can introduce mismatches
- Not all code patterns benefit from Frank - turning it off may help some functions
- Some patterns don't match with or without Frank
- Pattern example:
  ```
  goal:          lwz fsubs addi
  without frank: lwz addi fsubs
  with frank:    fsubs lwz addi
  ```
- Source: altafen (2022-08-14)

### Shared Float/String Constants
- Functions sharing rodata (float constants, strings) with asm can cause issues
- `const` keyword affects which section data goes to
- A function's rodata may be reused by subsequent functions in the same TU
- Source: altafen (2022-08-21)

### Redeclared Identifier Errors
- Error like `identifier 'X(...)' redeclared - was declared as: 'int (...)'` means there's an implicit declaration somewhere
- The function was called before being declared, so compiler assumed `int` return type
- Add proper prototypes or reorder declarations
- Source: .durgan (2022-08-01)

### Static Arrays Inside Functions
- Static arrays declared inside functions are real and may need to match specific addresses
- Order of static declarations affects their addresses
- May need to adjust C/S file ordering to get statics at correct addresses
- Source: vetroidmania (2022-08-17)

### Data Section from Int to Float Conversion
- If int-to-float conversion constant is at wrong offset, you're missing constants in the file or the order is wrong
- Order of operations on a single line may affect constant ordering
- Source: seekyct (2022-08-28)

### Macro Safety
- Always wrap macro arguments in parentheses:
  ```c
  // BAD:
  #define ASD(x) (x < 0) ? 0 : 1
  // ASD(-5) + 1 becomes (-5 < 0) ? 0 : 1 + 1 = 0

  // GOOD:
  #define ASD(x) (((x) < 0) ? 0 : 1)
  // ASD(-5) + 1 becomes (((-5) < 0) ? 0 : 1) + 1 = 1
  ```
- Source: altafen (2022-08-21)

## Workflow Notes

### Progress Tracking
- August 2022: Project reached ~12% code, ~3.4% data
- Trophy system: Unlock virtual trophies at progress milestones
- Trophy 35 unlocked this month
- Source: revosucks (various dates)

### PR Guidelines
- Squash commits on merge for cleaner history
- PRs should be close to done before opening (non-draft)
- Draft PRs are fine to show WIP branch location
- Having matching source is more important than shiftability during early decomp
- Source: werewolf.zip, camthesaxman (2022-08-26)

### Authoritative References
- archive.org has Dolphin SDK + documentation
- Leaked Wii SDK source exists but is for different version
- LibOGC is "practically just IDA dumped code" with different naming
- dolwin-docs repo has some reimplementation: https://github.com/ogamespec/dolwin-docs
- Source: werewolf.zip (2022-08-22)
