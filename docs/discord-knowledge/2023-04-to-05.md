# Decompilation Knowledge: April-May 2023

## Project Status

- April 2023: ~14.5% code completion, 11.97% data
- End of May 2023: 16.43% code completion, 12.22% data (48 trophies)
- Smash 64 decomp approaching 30% completion (vetroidmania)

## Compiler Patterns

### Cast to Force Specific Codegen

A random cast in an `||` chain can prevent the compiler from optimizing consecutive comparisons:

```c
// This gets optimized into a switch-like structure:
if (msid == 0xB7 || msid == 0xB8 || msid == 0xB9 ||
    msid == 0xBF || msid == 0xC0 || msid == 0xC1)

// But adding a cast prevents optimization:
if (msid == 0xB7 || msid == 0xB8 || (s32)msid == 0xB9 ||
    msid == 0xBF || msid == 0xC0 || msid == 0xC1)
```

Source: chippy__ (2023-05-30)

### Callback Inlining

Callbacks can get inlined even when passed as function pointers:

```c
// ensureUnkItem isn't in the dol - it got inlined into the caller
// https://decomp.me/scratch/DggG7
```

This can simplify repeated callback functions. Source: ribbanya (2023-05-06)

### Unused Stack Variables for Alignment

Sometimes unused stack variables are needed for alignment:

```c
void ft_8009B390(ftCo_GObj* gobj, float force_mul)
{
#ifdef MUST_MATCH
    u8 _[16] = { 0 };
#endif
    // ... function body
}
```

Source: .cuyler, revosucks (2023-05-28)

### Local Variable Non-Existence

Sometimes m2c-generated local variables don't actually exist - the address is computed directly:

```c
// cd_x148_rad doesn't exist as a local var
// https://decomp.me/scratch/q4zu3
```

Source: vetroidmania (2023-05-15)

### IDO Scheduler Chaos (N64)

For Smash 64, the IDO compiler scheduler reorders instructions wildly:
- Example ordering: 54 -> 107 -> 59 -> 56 -> 93 -> 95

Source: vetroidmania (2023-05-03)

## Matching Techniques

### GUARD Macro for Early Returns

A common pattern for IASA (interrupt) functions with many early-return checks:

```c
#define GUARD(cond)          \
    if ((cond)) {            \
        return;              \
    }

void ftCo_AttackLw3_IASA(HSD_GObj* gobj)
{
    ftCo_Fighter* fp = GET_FIGHTER(gobj);
    if (fp->allow_interrupt) {
        GUARD(ftCo_AttackS4_CheckInput(gobj))
        GUARD(ftCo_AttackHi4_CheckInput(gobj))
        // ... more guards
    }
}
```

Source: ribbanya (2023-05-13)

### Subaction Event Opcode Extraction

The correct way to extract opcodes from subaction events:

```c
// Wrong approach:
eventCode /= 4;
eventCode %= 64;

// Correct approach - loading a 6-bit opcode:
struct SubactionEvent {
    u32 opcode : 6;
    // ... other fields
};
```

Source: vetroidmania (2023-05-25)

### Ternary for bge; b Sequences

A `bge; b` instruction sequence can be generated by ternaries:

```c
ftCo_Fighter* fp = gobj->user_data;
FtMotionId msid = (float) fp->dmg.x1830_percent < p_ftCommonData->x488
                      ? ftCo_MS_CliffEscapeQuick
                      : ftCo_MS_CliffEscapeSlow;
```

Source: .cuyler (2023-05-30)

### Inverted Conditions

Sometimes the condition needs to be inverted to match:

```c
// If you have the condition inverted, swap the order:
// Original (doesn't match): condition ? A : B
// Fixed (matches): !condition ? B : A
```

Source: .cuyler (2023-05-30)

## Type Information

### FighterVars Size Breaking m2c

Using `FighterVars_Size` as an enum or const breaks m2c context generation:

- Enum and `const u32` both break it
- Solution: Use `#define` but force pcpp to evaluate it with `-U FIGHTERVARS_SIZE`
- The define remains in source but gets expanded in context

Source: altafen, ribbanya (2023-04-23)

### SurfaceData Struct

```c
typedef struct SurfaceData {
    s32 index;  // 83C
    u32 unk;    // 840
    Vec3f normal; // 844
} SurfaceData;
```

At `fp+0x14C`, accessible as `&fp->x14C_ground.normal` at offset 0x844.

Source: altafen (2023-05-15)

### Attack Group Flags (x2070)

Located around offset 0x2070 in fighter struct, using halfword union convention:

```c
// https://github.com/doldecomp/melee/blob/master/src/melee/ft/types.h#L853-L870
```

Link's boomerang gets flagged as smash attack if thrown with smash-B input.

Source: vetroidmania, ribbanya (2023-05-30)

### HSD Object Naming Convention

| Prefix | Meaning |
|--------|---------|
| GObj | Global |
| WObj | World |
| SObj | Scene |
| CObj | Camera |
| LObj | Light |
| JObj | Joint |
| DObj | Display |
| PObj | Polygon |
| MObj | Material |
| TObj | Texture |
| AObj | Animation |
| FObj | Frame |
| RObj | Reference |

DObj = Display Object, containing mesh/model data. In HSDRaw, skeleton expands into JObjs and DObjs where DObjs contain mesh data.

Source: .durgan (2023-05-27)

### Subaction Event: Graphic Effect (0x0A)

```c
struct GraphicEffect_Header {
    u32 opcode : 6;
    u32 boneId : 8;
    u32 useCommonBoneIDs : 1;
    u32 destroyOnStateChange : 1;
    u32 useUnkBone : 1; // Forces spawn on head instead of given bone ID
    u32 padding : 15;
};
struct GraphicEffect_Data1 {
    u32 gfxID : 16;
    u32 unkFloat : 16;
};
struct GraphicEffect_Data2 {
    s16 offsetZ : 16;
    s16 offsetY : 16;
};
struct GraphicEffect_Data3 {
    s16 offsetX : 16;
    u16 rangeZ : 16;  // UNSIGNED, not signed
};
struct GraphicEffect_Data4 {
    u16 rangeY : 16;
    u16 rangeX : 16;
};
```

Range values are unsigned - if signed, it stops matching. Negative values appear both behind and in front (possibly RNG decides sign).

Source: altafen, vetroidmania (2023-05-26)

### Enable Jab Followup Event

The 26-bit value after opcode:
- 0 = normal
- 1 = bunny hood only (can start followup only if bunny hood equipped)

This is why Ganondorf could do his second jab with bunny hood in v1.00.

Source: vetroidmania (2023-05-25)

### Damage Log Structure

Located at `80459278`, stores up to 10 simultaneous hits per frame:
- Hurtbox that got hit
- Attacker's hitbox pointer
- Attacker's GObj
- Log index resets every frame
- All players share the same log

Melee also has "tiplog" for phantom hits.

Source: vetroidmania (2023-05-21)

### Attack ID Conventions

- 0 = not attack
- 1 = not attack but used for staling (needs 1 for "no stale" in attack ID, 0 in state flags)
- IDs >= 2 = specific attack types

Source: vetroidmania (2023-04-24)

## Naming Conventions

### Motion vs Action vs Subaction

- HAL calls them "motions" internally, "status" in Brawl onward
- Community historically used "Action State" (ASID)
- "Subaction" refers to animation-related data in dat files
- The counts line up: ~341 common states at `fp+2340`

Source: ribbanya, vetroidmania, rtburns (2023-04-15)

### Animation Name Conventions

From dat file node names:
- `Hi`/`Lw` = High/Low (for aerials)
- `F`/`B`/`U`/`D` = Forward/Back/Up/Down (for throws, and U/D for prone facing)
- `3` = tilt, `4` = smash (Attack prefixes)
- Names come from animation filenames like `PlyCaptain5K_Share_ACTION_Swing42_figatree`

Source: altafen (2023-04-23)

### Japanese Names in Code

- `ottotto` = teeter
- `furafura` = dazed

Recommendation: Use English names in code with Japanese noted in comments, though keeping Japanese for searchability against animation files is also valid.

Source: altafen, ribbanya (2023-05-28)

### File Prefixes

- `mp` = map (stage/ground collision) - "proc map" callbacks
- `ft` = fighter
- `it` = item
- `ItCo.dat` exists for common items
- `PlFx.dat`, `GrPu.dat` = character/stage dat files

Source: vetroidmania (2023-05-05)

## Tool Tips

### Context Generation with pcpp

The context generator uses pcpp (Python C Preprocessor):
- Macros are now included in context
- Use `-U SYMBOL` to force evaluation of specific defines before context generation
- `passthru-defines` passes defines to context as-is but doesn't expand them in array sizes

Source: ribbanya (2023-04-23)

### Map File from GitHub Actions

Get `GALE01.map` from GitHub Actions artifacts:
1. Go to https://github.com/doldecomp/melee/actions/workflows/build-melee.yml
2. Find latest successful run on master
3. Download `GALE01.map` under Artifacts

Source: ribbanya (2023-05-02)

### Git Branch Comparison

```
# Three dots shows merge-base comparison (for PRs)
github.com/doldecomp/melee/compare/master...user:branch

# Two dots shows direct comparison
github.com/doldecomp/melee/compare/master..user:branch
```

When heads are the same, reset hard or rebase to sync.

Source: ribbanya (2023-05-18)

### Doxygen Documentation Format

```c
/**
 * Brief description (becomes summary).
 *
 * Detailed description here.
 *
 * @param arg0 Description of parameter
 * @return Description of return value
 */
```

Guidelines:
- Don't start with "This function"
- First sentence becomes summary
- Use `#SomeOtherMember` to reference other definitions
- Use `@p foo` to reference parameters
- Use `@code{c}` and `@endcode` for code blocks

Source: ribbanya (2023-05-19)

### decomp.me Local vs Remote Mismatch

Sometimes code matches locally but not on decomp.me - verify with local build.

Source: ribbanya (2023-05-15)

### asm-differ Setup for New Files

After setting up a new function file:
1. Run `make` once with `WIP=1`
2. Then asm-differ with `-m` option will auto-rebuild

Source: ribbanya (2023-05-25)

## Pitfalls and Gotchas

### Include Guards vs pragma once

`#pragma once` is buggy on mwcc before version 3.0. Use include guards instead:

```c
#ifndef _FILENAME_H_
#define _FILENAME_H_
// ... header content
#endif
```

Source: swarejonge (2023-04-29)

### Circular Dependencies with Typedefs

To avoid circular includes:
1. Create a `forward.h` with typedefs only
2. Put struct definitions in main header
3. Include the struct header in .c files directly, not in other headers
4. Or use `struct Fighter` everywhere instead of typedef

Source: ribbanya (2023-04-28)

### GET_FIGHTER Macro Issues

`GET_FIGHTER` stops working in some contexts:
- When extra float args are added (e.g., for landing lag)
- When used in callbacks passed to certain functions like `ft_80082C74`
- Workaround: Use direct `gobj->user_data` assignment with unused stack padding

Source: ribbanya (2023-05-28)

### Smash 64 Hurtbox Bug

Both Smash 64 and Melee have a bug when setting individual hurtbox collision states - returns after first bone ID match instead of checking all hurtboxes on the same bone.

Source: vetroidmania (2023-05-26)

### Windows Build Issues

If getting "fatal error: opening dependency file" on Windows:
- Try installing devkitpro and running in its msys environment
- Or use `bash -c 'make ...'` in PowerShell
- Issue may be Python path related

Source: _go0b_, ribbanya (2023-04-10)

## Function-Specific Insights

### SDI (Smash Directional Influence)

SDI implementation: https://decomp.me/scratch/aVCqi

Source: ribbanya (2023-05-15)

### Ledge Mechanics

- `CliffEscape` = ledge roll
- `CliffClimb` = ledge getup
- `CliffJump` = ledge jump
- Slow/Quick variants based on `p_ftCommonData->x488` damage threshold

Source: kiwidev, ribbanya (2023-05-28)

### Master Hand FighterVars Access

HAL points 4 bytes ahead and uses that pointer to access Master Hand's fightervars instead of accessing directly.

Source: vetroidmania (2023-05-02)

### Unused Features

**Smash 64 Angled Up Tilts**: Code exists for angled up tilts (up-forward, up-backward) but no character has animations for them. Dropped in later games.

**Polygon Fighter Specials**: In Smash 64, polygon fighters have special move and grab code but are prevented from using them via a flag. Specials often crash when enabled.

**Jigglypuff Unused Content**: Has unused rapid jab and neutral B statevar in Smash 64.

Source: vetroidmania (2023-04-29, 2023-05-20)

### Smash 64 Alt Costumes

64 treats alt costumes as matanims (material animations) for the most part instead of separate model files - enables the 3D character select screen.

Source: vetroidmania (2023-05-22)

## Cross-Project Insights

### Smash 64 Subaction Events Pattern

Melee uses function pointers for "advance pointer 4 bytes at a time" convention while 64 uses one big switch statement:
https://decomp.me/scratch/A0gY4

Source: vetroidmania (2023-05-10)

### Hitbox Differences

Smash 64 has interpolated cubes for hitboxes, Melee has interpolated spheres.

64 automatically ignores fighter hitbox vs item hitbox collision if you have a reflector up or the item can't be reflected. Melee doesn't do this, causing issues like Ness's bat destroying projectiles.

Source: vetroidmania (2023-05-08, 2023-05-20)

## GPT/AI for Decompilation

### ChatGPT 4 Results

stephenjayakar reported GPT-4 improved a scratch from 44% -> 90% match:
- https://decomp.me/scratch/pt6Xo
- Had to tell it to use specific types
- Summarized changes it made

Source: stephenjayakar (2023-05-21)

### AI Limitations

- ChatGPT not trained on mwcc/GameCube compiler specifics
- Produces code aesthetically similar to m2c output but often wrong
- Tends to give wrong SIMD functions and times out on complex requests
- Phind search engine gives better results than ChatGPT/Bing for decomp info

Source: werewolf.zip, darkeye., ribbanya (2023-04-07, 2023-05-20)

## Resources

### External References

- Melee Light collision code: https://github.com/schmooblidon/meleelight/blob/master/src/physics/environmentalCollision.js
- FRAY HSD implementation: https://github.com/PsiLupan/FRAY
- MMW Character Data: https://github.com/DRGN-DRC/Melee-Modding-Wizard/blob/main/bin/CharDataTranslations.json
- Dat format docs: https://smashboards.com/threads/melee-dat-format.292603/
- GX docs: https://github.com/ogamespec/dolwin-docs/blob/master/HW/GraphicsSystem/GX.md
- Peppi action state enums: https://github.com/hohav/peppi/blob/master/peppi/src/model/enums/action_state.rs
- Smash 64 decomp: https://github.com/VetriTheRetri/ssb-decomp

### Useful Scratches

- Master Hand fightervars: https://decomp.me/scratch/zwmsx
- Subaction events (64): https://decomp.me/scratch/A0gY4
- SDI implementation: https://decomp.me/scratch/aVCqi
- Knockback code: https://decomp.me/scratch/92pzH
