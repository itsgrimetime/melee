# Decompilation Knowledge: March-July 2024

This document distills decompilation knowledge from the #smash-bros-melee channel covering March through July 2024. The period saw continued progress on matching, SDK integration work, project tooling improvements, and several new contributors joining the effort.

## Compiler Patterns

### Assert Macro Impact on Stack and Inlining (revosucks, 2024-03-31)
The correct assert macro format significantly affects codegen, particularly stack allocation and inlining behavior:

```c
#define ASSERTMSGLINE(line, cond, msg) \
    ((cond) || (OSPanic(__FILE__, line, msg), 0))
```

Key points:
- The `, 0` at the end is **required** for correct behavior
- This format allows asserts to be used in `if()` conditions
- Using the wrong assert macro can cause stack inflation and unexpected inlining issues
- Some void pointer cast hacks may have been workarounds for incorrect assert macros

However, werewolf.zip noted (2024-04-19) that HSD code uses its own `HSD_ASSERT` macro, which may differ from SDK asserts. Testing showed the SDK-style assert still caused 0x8 bytes of extra stack in some HSD functions.

### Ternary vs If-Else Generates Different Assembly (revosucks, 2024-05-01)
Equivalent logical constructs can produce different codegen:
```c
// These may NOT produce the same assembly:
if (condition) x = a; else x = b;
x = condition ? a : b;
```
Consider any logically equivalent code as potentially generating different assembly.

### Inline Depth and Auto-Inlining (foxcam/revosucks, 2024-06-19)
When a function gets inlined, inner function calls may or may not be inlined based on nesting depth:
- If function A calls function B which calls function C
- When A inlines B, the compiler may hit inline depth limit and NOT inline C
- This explains cases where a function appears as both inlined code and as a `bl` call in different contexts

Look for patterns where the same small function is:
1. Inlined in one location
2. Called directly in another location immediately below/above

### Stack Differences of 0x8 Bytes (werewolf.zip, 2024-04-18)
A stack size difference of exactly 0x8 bytes typically indicates a missing inline function call:
- This is the exact stack reservation for a function call with this compiler
- If you see `r1+0x14` in target but `r1+0x1C` in your code (or similar 0x8 diff), look for missing inlines

### GET_FIGHTER Macro Casting (revosucks, 2024-05-01)
The macro should NOT include the GObj cast - functions do their own casting:
```c
// Correct - functions handle casting
#define GET_FIGHTER(gobj) ((Fighter*) HSD_GObjGetUserData(gobj))

// The cast is in the function, not the macro
void myFunc(Fighter_GObj* gobj) {
    Fighter* fp = GET_FIGHTER(gobj);  // Works with proper prototype
}
```
This can affect codegen and may explain some "fake matches."

### File Path in __FILE__ Affects Codegen (gamemasterplc/revosucks, 2024-06-11)
The expansion of `__FILE__` in asserts affects register loads:
- If context has `"src/sysdolphin/baselib/jobj.h"` but should have `"jobj.h"`, string loads differ
- Too many or too few characters changes how the string gets loaded
- Always verify `__FILE__` path matches expected format in decomp.me context

## Matching Techniques

### Using Raw Float Literals vs Constants (werewolf.zip, 2024-04-15)
When register ordering is wrong, try using literal floats instead of named constants:
```c
// May produce different register allocation:
fp->some_field = ftSeak_SOME_CONSTANT;  // Uses constant from data section
fp->some_field = 0.0f;                   // Inline literal
```
Test both approaches when you have close-but-not-matching code.

### RETURN_IF Macro Pattern (ribbanya, 2024-03-11)
For IASA callbacks and similar functions, use the RETURN_IF macro pattern:
```c
#define RETURN_IF(expr) if (expr) { (void)gobj; return; }

void ftYs_GuardOn_0_IASA(HSD_GObj* gobj)
{
    RETURN_IF(ftCo_80093694(gobj));
    RETURN_IF(ftCo_8009515C(gobj));
    RETURN_IF(ftCo_80099794(gobj));
    // ...
}
```
The `(void)gobj;` produces an errant `cmpwi` instruction that otherwise seems to do nothing.

### Switch Statement Detection (revosucks, 2024-06-11)
Deeply nested if-else chains with comparisons often are switch statements:
```c
// M2C output with nested ifs like:
if (temp_r3 != 0x1C) {
    if (temp_r3 < 0x1C) {
        if (temp_r3 != 0xF) {
// ...

// Is probably:
switch(gm_801A4310()) {
    case 0x1C:
    case 0x0F:
    case 0x2B:
        return 1;
    default:
        return 0;
}
```

### Data Symbol Base Address Offsetting (altafen/gamemasterplc, 2024-07-30)
The compiler often loads the first symbol in a data section and offsets from it:
```c
// M2C may show:
(it_803F6CA8 + (temp_r29->unkDD4 * 4))->unkB0;

// This is actually:
it_803F6D58[temp_r29->unkDD4]  // Where 803F6D58 = 803F6CA8 + 0xB0
```

Key insight: The `*4` indicates array indexing (4-byte elements), and the offset points to a different array than the base symbol. Don't assume the decompiler's symbol reference is accurate.

### Struct Copy vs Field Assignment (gamemasterplc/foxcam, 2024-07-31)
When copying Vec3 or similar structs:
```c
// Struct copy - uses integer registers (generic copy)
pos = other_pos;

// Field assignment - uses floating point registers
pos.x = other_pos.x;
pos.y = other_pos.y;
pos.z = other_pos.z;
```
M2C often shows struct copies as separate s32/u32 assignments - recognize this pattern.

### Returning Result of Void Function for State Tables (gamemasterplc, 2024-07-04)
When a state table expects `int` return but you have a `void` function:
```c
// If state table slot expects: int (*)(HSD_GObj*)
// But function is: void foo(HSD_GObj*)

// Solution: return result of a no-argument function call
int wrapper(HSD_GObj* gobj) {
    foo(gobj);
    return other_func();  // Generates transfer of value
}
```
This generates the expected codegen for void functions in int-returning slots.

## Type Information

### Fighter Struct Pattern (revosucks, 2024-04-26)
Melee devs consistently declare gobj and fighter pointers at function start:
```c
type myFighterFunc(GObj* gobj) {
    Fighter* fp = GET_FIGHTER(gobj);
    // HSD_JObj* optional = gobj->jobj_data;

    // do things with fighter structs/vars
}
```
This is an 85-90% consistent pattern. If you see JObj/Fighter pointer inits in the middle of a function, suspect missing inlines.

### Item Data Structure at Offset 0x1974 (werewolf.zip, 2024-03-22)
Offset 0x1974 on Fighter is a pointer to an item GObj:
```c
// When you see offset 0x1974 from GObj, it's likely:
Item_GObj* item = (Item_GObj*)(fp->x1974);
```
Items don't have offsets that high, so 0x1974+ on a GObj is typically Fighter-related item data.

### Purin Attributes Unknown Region (altafen, 2024-04-22)
In `_ftPurinAttributes`:
```c
u8 _48[0x88 - 0x48];  // "we don't know what goes here but it fills 0x40 bytes"
```
When you encounter these padding regions and need fields at specific offsets, add them properly (e.g., add Vec2 at 0x80).

### HSD_ObjAlloc Structure (werewolf.zip, 2024-05-23)
`HSD_ObjAllocInfo` doesn't actually exist - it's an inline struct within `HSD_ObjDumpStat`:
```c
// Wrong:
HSD_ObjAllocInfo->getData()  // This pattern is nonsense

// Correct - using inline struct with function pointer:
struct {
    const char* name;
    HSD_ObjAllocData* (*func)(void);
} types[i];

// Called as:
HSD_ObjAllocGetUsing(types[i].func());
```

### GObj User Data (werewolf.zip, 2024-07-28)
GObjs are the core game loop objects:
- `user_data` is `void*` because GObjs hold everything: UI, Items, Fighters, Stages
- Priority dictates list ordering
- Link members dictate which object array they're in
- `gxlink_prios` bitfield controls graphics render order (up to 64 priorities)

```c
#define GET_FIGHTER(gobj) ((Fighter*) HSD_GObjGetUserData(gobj))
#define GET_ITEM(gobj) ((Item*) HSD_GObjGetUserData(gobj))
```

## Tool Tips

### objdiff-cli Progress Reporting (encounter/altafen, 2024-05-22)
Use `objdiff-cli report` to get partial progress:
```bash
objdiff-cli report generate --project . --output test.json
```
Output includes:
- `fuzzy_match_percent`: ~24%
- `matched_size_percent`: ~22%
- `matched_functions_percent`: ~37%

Note: On Windows, use full path instead of `.` for the project argument.

### Relocation Diff Checking in objdiff (ribbanya, 2024-07-07)
To see relocation differences that might cause checksum failures:
- Uncheck `Diff Options > Relax relocation diffs` in objdiff

This helps catch sbss/sdata ordering issues that would otherwise show as "100% match."

### ASM for decomp.me from Repository (altafen, 2024-07-09)
Don't manually extract ASM - use the repo's generated files:
```
https://github.com/doldecomp/melee/blob/master/asm/sysdolphin/baselib/hsd_3B2E.s
```
Copy from `.global function_name` to `blr` for decomp.me scratch.

### Finding Virtual Addresses for Renamed Functions (ribbanya, 2024-03-14)
If a function was renamed, search for its virtual address (the hex suffix):
```
HSD_GObjObjet_80390B0C -> search for "80390B0C"
```
The address will still be in symbols.txt even if the name changed.

### Build System: dtk-template Bug Fix (altafen, 2024-06-01)
If Matching files aren't being included in the DOL, check `tools/project.py`:
```python
# Move this line:
built_obj_path: Optional[Path] = None
# To before the if/else statement above it
```
This was fixed upstream in dtk-template.

### make vs ninja for sdata/sbss Ordering (rtburns, 2024-05-23)
The ninja build's fuzzy matching can miss sbss/sdata ordering issues:
- `make` will catch reversed ordering
- Use `asmdiff-elf.sh` or similar tools to diff objdump output

Example of caught error:
```diff
-804d74b0 <__AR_Callback>:
+804d74b0 <__AR_init_flag>:
```

### Creating Headers for New Functions (ribbanya, 2024-03-14)
When decompiling a function that calls undeclared functions:
1. Create the header file for that TU (e.g., `grfigureget.h`)
2. Add declarations there
3. Never use `extern` in .c files - that's laziness

## Pitfalls and Gotchas

### NonMatching Files Don't Affect DOL (altafen, 2024-06-01)
The build system combines:
- Original DOL (for NonMatching files)
- Built Matching files

If you modify a file marked NonMatching in configure.py, changes won't appear in the output DOL. Mark it as Matching to test modifications.

### Errant cmpwi from Void Casts (ribbanya, 2024-03-11)
An unexplained `cmpwi` that does nothing with its result is often from:
```c
(void)gobj;  // Produces cmpwi with no branch
```
Used in RETURN_IF macros and similar patterns.

### Multiple Data References Coalesce (gamemasterplc, 2024-05-12)
If you reference data symbols multiple times in a function, the compiler may coalesce them:
```c
// Instead of separate string loads:
OSReport("message1");
OSReport("message2");

// You might see:
OSReport(((char*) &baseSymbol) + offset1);  // Both relative to first symbol
OSReport(((char*) &baseSymbol) + offset2);
```
Solution: Define all data in that TU properly, possibly requiring decompilation of preceding functions.

### SDK Version Differences (werewolf.zip/revosucks, 2024-05-23)
Melee uses SDK from around December 2001, not May 2001:
- September 2001 SDK had significant changes
- December 2001 debug builds may help
- Some functions have extra null checks that May 2001 lacks:
```c
// Melee version (Dec 2001):
void __AXGetAuxAInput(u32* p) {
    if (__AXCallbackAuxA != NULL) {
        *p = (u32) &__AXBufferAuxA[...];
    } else {
        *p = 0;
    }
}

// May 2001 version:
void __AXGetAuxAInput(u32* p) {
    *p = (u32) &__AXBufferAuxA[...];  // No null check!
}
```

### Shiftability Explained (altafen, 2024-07-15)
The decomp is shiftable because symbols are referenced by name, not hardcoded addresses:
```asm
; Non-shiftable (hardcoded):
lis r4, -0x7fc0        ; Magic number
subi r0, r4, 0x58      ; Another magic number

; Shiftable (symbolic):
lis r4, un_803FFFA8@ha
addi r0, r4, un_803FFFA8@l
```
The linker resolves `@ha`/`@l` at link time. Can't just search-replace numbers because some are actual data (colors, bitmasks like `0x80400001`).

### Stack Padding Can Be Many Things (ribbanya, 2024-07-14)
Stack size mismatches could indicate:
- Missing parameter
- Missing local variable
- Missing inline function
- Something else entirely

If the checksum passes, it's better to mark as matching even with padding hacks - perfect stack guessing is often not worth the time investment.

## Function-Specific Insights

### ftData_UnkMotionStates4 (rtburns, 2024-03-01)
According to melee-re, this is a table of "charge neutral-B" action states, based on fighters listed.

### Memory Card Encryption/Decryption (alex_aitch/cuyler/altafen, 2024-07-09)
Functions at 0x803b31cc (decrypt) and 0x803b2e04 (encrypt):
- Main decrypt function: `MemoryCard_DecryptMain`
- Scramble operation uses modulo 13
- Matched scratches available for reference

### Link's Hookshot vs Samus Grapple (foxcam, 2024-07-25)
While both are ledge tethers/grabs:
- Share some code (e.g., `ftCo_AirCatch`, collision at 80051ec8)
- Link's has manual matrix math for animations
- 800c3d6c has similar code in big if-else for both

## Project Status Notes

### Progress Metrics (May 2024)
- Full file matching: ~18%
- Partial/fuzzy matching: ~24%
- The percentage dropped when partial linking and asm functions were deprecated

### Trello Deprecated (April 2024)
- Trello limited free workspaces to 10 collaborators
- Project transitioning to GitHub Projects
- For now, just announce in Discord what you're working on

### CI Regression Detection (altafen, 2024-05-22)
CI uses `objdiff-cli` with `jq` to detect regressions:
- Checks if any function went from 100% to less
- Catches changes in partial files that would be invisible otherwise
- Python script added (July 2024) for more reliable checking
