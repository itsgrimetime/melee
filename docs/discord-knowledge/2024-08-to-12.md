# Decompilation Knowledge: August-December 2024

This document distills technical knowledge from the #smash-bros-melee Discord channel during August through December 2024 (~1,143 messages).

## Compiler Patterns

### Explicit NULL Checks Affect Codegen
- Explicit `if (ptr != NULL)` checks produce different codegen than `if (ptr)` for inlined functions
- The compiler can discard `if (ptr)` checks when it knows the pointer is non-null (e.g., from a local variable)
- Using explicit `NULL` can break inlines where the check would otherwise be optimized away
- Recommendation: Use `if (ptr)` style checks for consistency
- Source: werewolf.zip (2024-09-05)

### Switch Statement Codegen Patterns
- Nested if-else chains in decompiler output often represent switch statements
- Example pattern that becomes a switch:
```c
if (kind < 0x8A) {
    if (kind < 0x4C) {
        if (kind < 0x4A) {
            // empty
        } else { code_A; }
    }
} else if (kind < 0x8C) { code_B; }
```
Becomes:
```c
switch (kind) {
    case 0x4A:
    case 0x4B:
        code_B;
        break;
    case 0x8A:
    case 0x8B:
        code_A;
        break;
}
```
- Different switch orderings can produce nearly identical assembly - try multiple patterns
- Source: bbr0n, foxcam (2024-08-01)

### Inline Auto Behavior
- `-inline auto` causes the compiler to inline small static functions until reaching a certain depth (~3 levels)
- A file that originally had 7-8 functions can compress to 2-3 due to inline auto
- Functions called exactly once in the same file are prime candidates for inlining
- Source: revosucks, werewolf.zip (2024-09-17)

### Double Branch Instructions
- Double `b` (branch) instructions like `b .L_X / b .L_X` are indicative of switch statements
- This is a "Metrowerks moment" - quirky compiler behavior
- Source: stephenjayakar, revosucks, werewolf.zip (2024-09-19)

### Structure Copies Use Word Loads
- When copying structures, the compiler may use `lwz` (load word) instructions even for float fields
- This is an optimization that copies the raw bytes rather than interpreting as floats
- Source: kiwidev (2024-08-14)

## Matching Techniques

### Bitfield Access Patterns
- When decompiler produces `(u8)(flag & ~0x10)`, it often indicates a bitfield struct
- The `b*` fields (b0, b1, etc.) allow setting individual bits:
```c
// Instead of:
item->xDCC_flag.b0 = (u8)(item->xDCC_flag.b0 & ~0x10);
// Write:
item->xDCC_flag.b3 = 0;
```
- Search context for the offset (e.g., `x2219`) to find the correct bitfield access like `fp->x2219_b1`
- Source: foxcam (2024-08-01, 2024-10-11)

### Unrolled Loops for Vec3 Operations
- Repeated Vec3 assignments may need to be written as an unrolled for loop:
```c
for (i = 0; i < 3; i++) {
    *(&item->xDD4_itemVar.linkarrow.x48 - i) =
        *(&item->xDD4_itemVar.linkarrow.x3C - i);
}
```
- C implicitly multiplies pointer math by the type size - no explicit multiply needed
- Source: foxcam (2024-08-01, 2024-08-02)

### sqrtf Inline Recognition
- The sqrtf inline produces a distinctive pattern with `__frsqrte` and Newton-Raphson iterations:
```c
if (var_f4 > 0.0f) {
    sqrt = __frsqrte(var_f4);
    temp_f1_3 = 0.5 * sqrt * -((var_f4 * (sqrt * sqrt)) - 3.0);
    temp_f1_4 = 0.5 * temp_f1_3 * -((var_f4 * (temp_f1_3 * temp_f1_3)) - 3.0);
    temp_f1_5 = 0.5 * temp_f1_4 * -((var_f4 * (temp_f1_4 * temp_f1_4)) - 3.0);
    sp10 = var_f4 * temp_f1_5;
    var_f4 = sp10;
}
```
- Replace with `sqrtf()` call - search the repo for existing usage
- Source: chippy__, ribbanya (2024-09-30)

### JObj Inlines from jobj.h
- `__assert` calls with `jobj.h` in the string are inlines from the baselib header
- Search for `HSD_JObjSetTranslateZ` in context to find the full inline list
- Example simplification:
```c
// Long assert-laden code becomes:
HSD_JObjSetTranslateZ(jobj_1, temp_f31);
```
- Source: foxcam (2024-08-01)

### Linked List Operations
- Pattern like `lwz r4, 0(r3) / lwz r0, 4(r3) / stw r0, 4(r4)` indicates linked list manipulation
- The decompiler may produce `temp_r5 = M2C_FIELD(...)` for struct field access
- These should be rewritten using proper struct types with next/prev pointers
- Source: altafen, rainchus (2024-09-13)

### Register Argument Detection
- If the first thing that happens to r3 in a function is a load (not a write), it must be an argument
- Pattern `bl func / mr r30, r3` indicates the function returns something (r3 is return register)
- "Unset register" m2c error almost always means a missing parameter or missing return value
- Source: foxcam (2024-10-11), ribbanya (2024-10-13)

### Fake Variables from Register Reuse
- When you see duplicate `GET_FIGHTER()` calls, it may be:
  1. The compiler reusing a register for the fp pointer
  2. An inlined function that also calls GET_FIGHTER
- temp variables assigned in if-statements may be "fake" - just register reuse
- Source: foxcam, ribbanya (2024-10-11)

### Decomp Permuter for Regswaps
- The decomp-permuter tool can help with final regswaps or instruction swaps
- Sometimes produces unsatisfying "solutions" like empty if-statements that tickle regalloc:
```c
Fighter* ft = GET_FIGHTER(fighter);
if ((!db_804D6B48.b3) && (!db_804D6B48.b3)) { // ? permuter
}
ft->x21FC_flag.grouped_bits.b0_to_5 = db_804D6B48.b3;
```
- Source: altafen (2024-10-20)

### Handling `.L_` Labels
- `.L_` labels are local labels for branches, not separate functions
- If a label starts with `mflr`, it's a function - rename it to `fn_XXXXXXXX`
- Small functions without `mflr` also end with `blr`
- Source: werewolf.zip, ribbanya (2024-09-19)

## Type Information

### Compiler Version
- Project primarily uses CW 1.2.5 hotpatch (called 1.2.5n internally)
- SDK is OS revision 47 (vs May 2001 SDK which is revision 37)
- Source: encounter, werewolf.zip (2024-09-01, 2024-09-19)

### GObj Type System
- `Item_GObj`, `Fighter_GObj`, etc. are all typedef'd to `HSD_GObj` when compiled
- The specific types exist to help m2c infer the `user_data` field type
- When compiled locally, an ifdef makes them all HSD_GObj to avoid cast errors
- decomp.me requires casts between these types that aren't needed locally
- The GET_FIGHTER macro has a cast to HSD_GObj but others don't - may need fixing
- Source: foxcam, altafen, bbr0n (2024-08-23, 2024-09-18)

### Fighter vs ftCo Distinction
- `Fighter` is the abstract base class
- `ftCo` is the concrete implementation of common states
- Use `ftCo_GObj` when function uses common state variables (walk acceleration, etc.)
- Use `Fighter_GObj` when function just uses general Fighter struct
- Source: ribbanya (2024-09-24)

### UNK_T Fields
- `UNK_T` in structs means the type is unknown - treated as `void*`
- Arrays with hexadecimal names (like `x1234[0x100]`) indicate unknown data
- Don't name fields based on external documentation until confirmed by decompiling
- Source: werewolf.zip (2024-09-02)

### Item Struct Conventions
- Runtime variables: `item->xDD4_itemVar`
- Serialized attributes: `item->xC4_article_data->x4_specialAttributes`
- Character item structs go in `itCharItems.h`
- Common item structs go in `itCommonItems.h`
- Source: bbr0n, ribbanya, werewolf.zip (2024-09-22, 2024-12-13)

### Total Codebase Size
- ~200,000 lines of code at 25% match
- Estimated 800,000+ lines for the entire game
- Source: werewolf.zip (2024-11-17)

## Function-Specific Insights

### GET_FIGHTER/GET_ITEM Macros
- Evidence suggests these may have been static inlines rather than macros
- Assert string found: `"ftGetImmItem item_gobj is NULL!!\n"` in ftpickupitem.c
- Indicates a particular coding style was used
- Source: werewolf.zip (2024-08-17)

### SDK Function Differences
- Some functions have different signatures between SDK versions
- Example: GX functions taking `GXColor` vs `GXColor*`
- Source: werewolf.zip (2024-09-19)

### Trophy Unlock Function
- `0x8030562c` is the trophy unlock function
- Takes r3 (short, trophy ID) and r4 (bool, usually 1)
- Trophy ID 165 has special handling
- Source: werewolf.zip (2024-09-04)

## Tool Tips

### objdiff Usage
- Opens with `python configure.py && ninja` then run objdiff
- Look at files that aren't green to find work
- Can generate function match percentages with `objdiff-cli`
- Supports hot reload when saving source files
- `-sym on` flag shows line numbers but may require passing to configure.py
- Source: werewolf.zip, ribbanya (2024-08-09, 2024-08-24)

### m2c Local Flags
- Useful flags for local m2c usage:
```sh
python 'tools/decomp.py' "$1" -- "${@:2}" \
    --valid-syntax \
    --unk-underscore \
    --no-casts
```
- `--gotos-only` or `--stack-structs` can help with specific cases
- Source: ribbanya (2024-08-12, 2024-08-24)

### decomp.me Tips
- Turn on line numbers: Options -> sym on
- Link scratches rather than posting screenshots for help
- The decompile button output often doesn't compile - use as starting point
- Valid syntax mode (`--valid-syntax`) makes compiler never generate non-compiling code
- Source: foxcam (2024-08-01)

### Context Generation
- Online context updates automatically on each commit: https://doldecomp.github.io/melee/ctx.html
- Local context can be generated but the online one is preferred
- Missing includes can cause context generation failures
- Source: werewolf.zip, ribbanya (2024-08-24, 2024-09-19)

### ASM Generation
- Build asm is in `build/GALE01/asm/` - generated by dtk during split process
- Use `python tools/decomp.py <function_name>` to decompile a specific function
- This version already has relocations fixed (vs raw asm)
- `build/tools/dtk elf disasm -h` to disassemble built objects
- Source: ribbanya, encounter (2024-10-07, 2024-09-19)

### Symbol Renaming
- Use `tools/replace-symbols` (Rust tool) for proper renames
- Updates symbols.txt, asm files, and all references
- Currently needs Rust installed; download may be automated later
- Source: ribbanya (2024-09-24)

### Building on Different Platforms
- WSL1 doesn't work - need WSL2 or native Windows
- WSL2: uname should show "Linux" not "Microsoft" kernel
- Native Windows works best since we use Win32 compilers
- `WINE='' ninja` or `--wrapper ""` if wine issues occur
- Source: swinginman, encounter (2024-09-25)

### Wiki for File Claims
- Use https://github.com/doldecomp/melee/wiki/Translation-Units to claim files
- Tool exists: `tools/wiki_tu.py` to update wiki from configure.py
- Source: ribbanya (2024-08-10)

## Pitfalls and Gotchas

### decomp.me Cast Errors
- When using specific GObj types (Item_GObj, Fighter_GObj), decomp.me requires casts
- The local build doesn't need these casts due to ifdef magic
- Workaround: Edit context to remove Item_/Fighter_ struct definitions
- Source: foxcam, altafen (2024-08-23, 2024-09-18)

### Inlined Functions Cause Extra Stack
- Using `GET_MENU` or similar macros can cause unexpected stack allocation
- Sometimes removing the macro and using direct access fixes the issue
- Source: werewolf.zip (2024-08-17)

### Clang Format Reordering Breaks Code
- Clang format reorders includes, which can break files that depend on include order
- Files may need explicit type includes instead of relying on ordering
- Source: werewolf.zip (2024-09-16, 2024-09-19)

### Incomplete Target ASM
- Invalid/incomplete target ASM causes cryptic errors like `unknown relocation type 'R_PPC_REL14'`
- Functions extend to the `blr` instruction, not just the first local label
- Source: werewolf.zip (2024-11-17)

### M2C_FIELD Indicates Missing Struct Fields
- When m2c outputs `M2C_FIELD(fp, u8*, 0x2223)`, the field doesn't exist in context
- Usually means there's a bitfield that needs to be accessed differently (e.g., `fp->x2223_b0`)
- Source: foxcam (2024-10-11)

### Version Differences
- K7 (Kirby Air Ride) source from 4 years later has small differences
- Some Melee code has constructs not present in later SDK versions
- May lead to "fake matching" where code structure differs from original
- Source: werewolf.zip, .cuyler (2024-09-05)

## Community Resources

### Documentation Sites
- Progress: https://decomp.dev/doldecomp/melee
- Doxygen: https://doldecomp.github.io/melee/index.html
- Getting Started: https://doldecomp.github.io/melee/getting_started.html
- Wiki Intro: https://github.com/doldecomp/melee/wiki/Decomp-Intro
- Decomp Glossary: https://wiki.decomp.dev/en/resources/decomp-glossary
- DAT attribute dumps: http://melee.theshoemaker.de/?dir=dat-dumps
- Source: foxcam, ribbanya (2024-10-04, 2024-11-08)

### Ghidra Database
- Available via Discord link (1056368962373435484)
- Source: altafen (2024-11-21)

### PowerPC Reference
- ELF spec with register usage: http://refspecs.linux-foundation.org/elf/elfspec_ppc.pdf (page 3-14)
- Registers >r13 are saved/restored per function; r1, r2, r13 have special purposes
- Source: foxcam (2024-09-25)

## AI/Automation Efforts

### ChatGPT Experiments
- Stephen Jayakar documented attempts using ChatGPT for decompilation
- Article: https://stephenjayakar.com/posts/chatgpt-not-compiler/
- Got from "doesn't compile" to 94% match with 59k token prompt
- Conclusion: ChatGPT not trained on mwcc, generic approaches don't work well
- Source: stephenjayakar (2024-09-16, 2024-12-10)

### Training Data Ideas
- Train on mwcc specifically by compiling random code and observing output
- Use RL since automated scoring/diffing exists
- Teaching a model to fix compiler errors and iterate with m2c could be effective
- Might need to fork m2c to output ASTs or internal representations
- Source: cortex420, ribbanya, renakunisaki (2024-09-17, 2024-10-02)

### Custom Decompiler Development
- foxcam working on a Melee-centric decompiler with:
  - Known inline identification (scanning for patterns like int-to-float)
  - Better union matching
  - GObj type guessing
  - 64-bit integer support
  - Item table generation with function signature matching
- Written in C with ImGui frontend
- Source: foxcam (2024-10-16, 2024-12-21)

## Project Milestones (Aug-Dec 2024)

- 19% files fully matched (2024-09-04)
- 56 trophies (progress metric) (2024-09-09)
- Broke 25% matched code (2024-09-29)
- 73 trophies by end of September
- 25.17% perfectly matched by November
