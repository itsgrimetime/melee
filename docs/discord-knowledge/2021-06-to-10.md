# Decompilation Knowledge: June-October 2021

This document distills technical insights from 263 messages across the #smash-bros-melee Discord channel from June through October 2021.

## Compiler Patterns

### EPPC 4 Prologue/Epilogue Bug (Critical)
The Melee decompilation project is blocked by a missing compiler version (EPPC 4). Key findings:

- **The Bug**: EPPC 4 has a prologue/epilogue scheduling bug that affects instruction ordering
- **Symptom**: The `addi` instruction in function epilogues appears in the wrong position relative to `lwz` and `mtlr`
- **Expected (Melee target)**:
  ```asm
  addi    r1, r1, 8
  lwz     r0, 4(r1)
  mtlr    r0
  blr
  ```
- **Produced by available compilers**:
  ```asm
  lwz     r0, 12(r1)
  addi    r1, r1, 8
  mtlr    r0
  blr
  ```
- **Fix timeline**: The bug was fixed in compiler release 2.3
- **Evidence**: Mac MWCC 2.2 exhibits the same bug when scheduling is enabled, suggesting EPPC inherited it from the Mac compiler
- Source: werewolf.zip, revosucks (2021-10-03)

### Addi Swap Bug
- A separate (but related) bug causes `addi` instructions to be ordered incorrectly under certain instruction sequences
- This is mentioned in the CodeWarrior release page as a pre-1.3 bug
- Combined with the EPPC4 scheduling bug, creates the "perfect storm" for both issues to manifest
- Source: werewolf.zip (2021-10-03)

### MetroTRK as Heuristic Test
- `TRKHandleRequestEvent` can be used as a quick test for compiler version identification
- MetroTRK is linked into all GameCube games as part of the compiler toolchain
- However, MetroTRK is **precompiled**, so it doesn't tell you what compiler was used for the game itself
- `lbvector` (part of Melee's main code) demonstrates the same epilogue bug and is a better test
- Source: revosucks, werewolf.zip, epochflame (2021-10-03)

### Mac Compiler Testing
- Mac MWCC 2.2 was tested to verify bug inheritance
- With scheduling turned off vs on, the difference is visible
- This provides evidence that the bug existed in Mac 2.2 and was inherited by EPPC
- Opens possibility of static recompilation to introduce EPPC differences
- Source: revosucks (2021-10-03)

## Matching Techniques

### COMPILER_NONMATCHING Strategy
- When stack ordering differences are caused by the compiler (not the decompiler), functions can be treated as "tentatively matching"
- Proposed `COMPILER_NONMATCHING` define to separate functions that are correct but don't byte-match due to compiler bugs
- This allows progress toward a shiftable build while waiting for the matching compiler
- Source: werewolf.zip (2021-09-14)

### Pragmatic Decompilation Approach
- The majority of code matches with current compilers
- Non-matching functions can include inline ASM while continuing decompilation
- Goal: shiftable game that compiles with any compiler, even if hash doesn't match
- Source: camthesaxman (2021-08-25)

## Type Information

### GObj and Proc Naming Conventions
- Actor/entity callbacks are called "Procs" (from GObjProc in the library)
- Proc = Procedure, referring to registered callbacks in running processes
- When used as simple callees (not callbacks), use generic name `gobj`
- Class defines: `4` for players, `2` for stages
- Source: werewolf.zip (2021-08-29)

### Component/Track System (Kirby Heritage)
- HAL games use a component system with arrays for individual values (like X position)
- Each actor reserves a "track" (index into arrays)
- Track number stored in `some_GObj->id`
- Melee appears to follow similar patterns from Kirby
- Source: someone2639, werewolf.zip (2021-08-29)

### types.h Standard Definition
```c
typedef signed char         s8;
typedef signed short        s16;
typedef signed long         s32;
typedef signed long long    s64;
typedef unsigned char       u8;
typedef unsigned short      u16;
typedef unsigned long       u32;
typedef unsigned long long  u64;

typedef volatile u8         vu8;
typedef volatile u16        vu16;
typedef volatile u32        vu32;
typedef volatile u64        vu64;
typedef volatile s8         vs8;
typedef volatile s16        vs16;
typedef volatile s32        vs32;
typedef volatile s64        vs64;

typedef float               f32;
typedef double              f64;
typedef volatile f32        vf32;
typedef volatile f64        vf64;

typedef int                 BOOL;

#define TRUE 1
#define FALSE 0

#define NULL ((void*)0)
```
- Taken from SDK headers for matching purposes
- Note: `NULL` as `0` (not `((void*)0)`) may be better for some contexts
- Source: werewolf.zip (2021-10-03)

## Function-Specific Insights

### File Layout Documentation
- eigenform's ASSERT.md documents file boundaries based on assert strings
- Available at: https://github.com/eigenform/melee-re/blob/master/docs/ASSERT.md
- Addresses in doc are not exact boundaries but layout is accurate
- Source: eigenform (2021-06-10)

### amcstubs Usage
- Melee uses `amcexi2stub.o` (stub version, not amcnotstub)
- Interesting because this wasn't part of pre-1.0 CodeWarrior Dolphin
- MW 1.0 release notes mention adding support for this to prebuilt project configs
- Source: werewolf.zip (2021-10-03)

## Language and Library Information

### C vs C++ in Melee
- All of Melee's game code is written in C
- Exception: C++ exception handler from EABI (`__init_cpp_exceptions`)
- This C++ code is from linked library stuff, not game code
- The developers likely just forgot to turn off C++ exceptions in the build
- The C++ runtime init may be mandatory because it's called from Nintendo start code
- Source: werewolf.zip, revosucks, gamemasterplc (2021-08-25)

### Modeling Tools
- HAL used **SoftImage** for modeling (not Maya)
- Known from Killer7 documentation complaining about HSD lacking Maya conversion support
- Custom model format (HSD) required tools/pipeline to match
- Source: werewolf.zip (2021-08-25)

### Collision System
- Melee likely uses BSP (Binary Space Partitioning) for collision
- Collision debugger shows larger squares surrounding stage elements
- Indicates scene partitioning similar to other HAL games (Kirby)
- Level collision data is separate from model data
- Source: werewolf.zip, someone2639, amber_0714 (2021-08-25)

## Build System

### Makefile Link Order Fix
If encountering `CWParserSetOutputFileDirectory [3]` error:
- **Problem**: Link order issue with `-o $@` flag position
- **Fix**: Change line 106 in Makefile from:
  ```makefile
  $(LD) $(LDFLAGS) -o $@ -lcf $(LDSCRIPT) $(O_FILES)
  ```
  to:
  ```makefile
  $(LD) $(LDFLAGS) -lcf $(LDSCRIPT) $(O_FILES) -o $@
  ```
- Fix originated from Twilight Princess project
- Source: wowjinxy, werewolf.zip (2021-08-14)

### Build Environment Requirements
- Use MSYS2 (not Windows CMD) for building
- Fresh devkitpro install with `pacman -S msys/python3` and `pacman -S gcc`
- Path issues are common cause of build failures
- Source: werewolf.zip, wowjinxy (2021-08-14)

## Tool Tips

### Shiftability Progress Script
- Script to extract `.4byte` from offset with specific length
- Useful for dealing with data sections during shiftability work
- Jump tables and pointer lookup tables are pervasive in Melee
- Source: werewolf.zip (2021-09-27)

### SDA Handling
- Use `@sda21` with `@h/@ha/@l` for r2/r13 offsets
- Standard approach used in Pikmin and other GC decomps
- Source: epochflame (2021-09-27)

## Project Status (October 2021)

### File Splitting Progress
- Nearly all .sdata done
- Most .data sections addressed (many are jump tables)
- General understanding of entire Melee layout achieved
- Goal: shiftable build within the month
- Source: werewolf.zip (2021-09-27, 2021-08-25)

### Ongoing Compiler Search
- Team actively searching for EPPC 4 compiler
- Considering Mac compiler hacking as alternative
- Research ongoing for 13+ months at this point
- Changelog documentation matches observed issues exactly
- Source: revosucks (2021-10-03)
