# Decompilation Knowledge: 2022-03

## Compiler Patterns

### Forcing Inlines with Pragma
- When decomp.me is not using an inline and generates a `bl nameofMyInlineFunc` call instead, use `#pragma always_inline on` to force inlining.
- Source: werewolf.zip (2022-03-07)

### Register Allocation Sensitive to Code Volume
- The location of `mr` (move register) instructions is directly correlated with the number of ASM lines between certain code regions.
- Adding lines of code moves `mr` upward; removing lines moves it downward.
- Deep nested inlines (multiple levels) can change register allocation (e.g., r27 to r26).
- Source: snuffysasa, werewolf.zip (2022-03-08)

### Code Reordering by Compiler
- The mwcc compiler reorders code in ways that seem arbitrary. Moving struct field assignments in different orders affects instruction placement.
- Commenting out any lines that set bitfields can shift instruction positions.
- Source: snuffysasa (2022-03-08)

### Inline ASM for Stubborn Instructions
- When a single instruction placement cannot be matched through normal C code, inline ASM can be used as a "fake match":
```c
asm {
  mr tmp, ft
}
```
- The placement of inline ASM within the function matters - it must be positioned where the instruction should appear.
- Source: werewolf.zip (2022-03-11)

### addi vs mr Generation
- `addi rX, rY, 0` and `mr rX, rY` produce different bytes even though functionally equivalent.
- Using a temporary variable assignment can sometimes force `mr` instead of `addi`:
```c
tmp = r27;
func_800C88A0(r27 = tmp);
```
- Source: snuffysasa, revosucks (2022-03-08)

### Struct Access Patterns Affect Codegen
- Substruct assignments can move `mr` instructions.
- Arrays vs individual non-struct members can produce different register allocation.
- Single members vs arrays have sensitivity that can affect edge cases.
- C99 features for dynamic struct initialization may be relevant.
- Source: revosucks (2022-03-12)

### Multiple blr Instructions in Functions
- Functions can have multiple `blr` (branch-link-return) instructions, especially when the stack isn't used.
- This is common in check functions that return bools.
- Frank (the epilogue scheduler patch) has special handling for this.
- Source: gibhaltmannkill, epochflame, moester_ (2022-03-14)

### Tail Calls End with b Instead of blr
- Functions with tail calls end with a `b` (branch) instruction instead of `blr`.
- Source: ninji (2022-03-14)

## Matching Techniques

### Permuter for Line Reordering
- A brute-force permuter can try all orderings of lines to find matches.
- 10! (3,628,800) permutations took ~8 hours on 32 cores at 40 iterations/second.
- Useful for struct initialization functions where line order affects codegen.
- Source: snuffysasa (2022-03-08)

Simple JavaScript permuter:
```js
const make_permutations = arr => {
    if (arr.length <= 2) return arr.length === 2 ? [arr, [arr[1], arr[0]]] : arr;
    return arr.reduce(
        (acc, item, i) =>
        acc.concat(
            make_permutations([...arr.slice(0, i), ...arr.slice(i + 1)]).map(val => [
            item,
            ...val,
            ])
        ),
        []
    );
};
```

### Splitting Functions into Inlines
- Splitting a large function into multiple top-level inlines (not deeply nested) can affect instruction scheduling.
- This approach is suggested when `mr` placement doesn't match and seems to start a new logical block.
- Source: werewolf.zip (2022-03-08)

### Repeating Expressions for Register Allocation
- Repeating an expression twice can change register allocation or convert `addi` to `mr`.
- Example scratch: https://decomp.me/scratch/Wx1iY
- Source: altafen (2022-03-08)

### Address vs Value Loading
- When assertion strings reference struct fields, ensure you're loading the address (`&fighter->field`) rather than the value.
- Wrong: `fighter_r30->x20A4` (loads value)
- Correct: `&fighter_r30->x20A4` (loads address)
- Source: rtburns (2022-03-26)

### Array Indexing for Struct Access
- When accessing via `lwzx` (indexed load), the pattern is typically array of structs indexed by a value:
```c
// Instead of using a flag directly as index:
fighter->x5E8_fighterBones[costume_id].x0_joint
```
- Source: rtburns (2022-03-16)

### Minimizing Code to Isolate Diffs
- Delete as much function code as possible while retaining the diff to narrow down the problem area.
- Try the opposite too: comment out as much as possible while still having the diff appear.
- Source: epochflame (2022-03-08)

## Type Information

### ftCommonData Struct
- Located at `lbl_804D6554`, points to data in PiCo.dat
- Known offsets:
  - 0x98: shieldHealthInit (f32)
  - 0x200: unknown (f32)
  - 0x204: knockbackFrameDecay (f32)
  - 0x260: unknown (f32)
  - 0x294: unknown (f32)
  - 0x3E8: shieldKnockbackFrameDecay (f32)
  - 0x3EC: shieldGroundFrictionMultiplier (f32)
  - 0x480: unknown (f32)
  - 0x498: ledgeCooldownTime (u32)
  - 0x5F0: unknown (u32)
  - 0x768-0x774: various floats and s32
- Source: snuffysasa (2022-03-08)

### FighterBone Struct
- x0 and x4 are HSD_JObj pointers (initially typed as u8* by mistake)
- Some functions treat them as JObjs, others as raw pointers passed to conversion functions
- May be a union in some cases
- Source: snuffysasa, rtburns, werewolf.zip (2022-03-18)

### Fighter Struct Unions
- Later parts of the Fighter struct (special attributes) are unions per-fighter.
- Different fighters have different field layouts in the same data range.
- Source: revosucks, werewolf.zip (2022-03-17)

### Fighter Field: x619 is costume_id
- The field at offset 0x619 in the Fighter struct is `costume_id`, not a flag.
- Source: werewolf.zip (2022-03-17)

### Fighter Assertion Reveals Variable Names
- Assertion: `HSD_ASSERT(721, !fp->no_normal_motion)` reveals:
  - The local variable was named `fp` (fighter pointer)
  - The field was named `no_normal_motion`
- `fp` naming convention: first letter of object type + `p` for pointer (common in Sysdolphin code)
- Other examples: `jp` (JObj pointer), `mp` (Map pointer), `dp`, `gp` (Ground pointer)
- Source: gibhaltmannkill, werewolf.zip (2022-03-26)

### Bitfield Usage Patterns
- HSD code tends to use manual bit fiddling with masks and defines
- Melee code tends to use C bitfields
- GObj has bitfield examples from matches
- Manual approach was used for portability (bitfield order is compiler-defined)
- May use anonymous structs (MWCC extension) or macros expanding to bitfield access
- Source: revosucks, gibhaltmannkill, rtburns (2022-03-26)

## Function-Specific Insights

### File Organization: Character Specials Split by Move
- Standard character file structure:
  - ftFox.c (general)
  - ftFoxSpecialN.c (neutral B)
  - ftFoxSpecialS.c (side B)
  - ftFoxSpecialHi.c (up B)
  - ftFoxSpecialLw.c (down B)
- Source: werewolf.zip (2022-03-10)

### Clone Characters Share Code
- Clone characters (Dr. Mario, etc.) primarily use the original character's code with character ID checks.
- Source: werewolf.zip (2022-03-10)

### Donkey Kong Code Split
- Donkey Kong's code is physically split by Mario, Falcon, Fox, Link, and Kirby's code in the binary.
- This happened because they didn't reorder his code when adding him to the game.
- Source: werewolf.zip (2022-03-10)

### HSD_JObjLoadJoint Takes a Pointer
- Despite one commit showing otherwise, `HSD_JObjLoadJoint` takes a pointer to struct, not a struct by value.
- Source: werewolf.zip (2022-03-13)

### func_8000C420 Parameter Type
- Takes what appears to be u8* but passes it to func_80371C68 which treats it as HSD_JObj*.
- Likely the FighterBone fields should be HSD_JObj* (not u8*).
- Source: rtburns (2022-03-18)

## Tool Tips

### decomp.me API Usage
- Search for scratches: `GET https://decomp.me/api/scratch?page_size=5&search={func}`
- Get scratch details: `GET https://decomp.me/api/scratch/{id}`
- Export endpoint: `/export` downloads code, object files, etc.
- Rate limiting is generous - don't hit hundreds of times per day or multiple times per second.
- Source: ethteck (2022-03-16, 2022-03-18)

### calcprogress Script with devkitPPC r40
- devkitPPC r40 changes linker map format, breaking older calcprogress scripts.
- Fix available in pikmin2 repo: commits 78a53d07 and f859e7d5
- Inline ASM counts as decompiled progress (not excluded).
- Source: epochflame, kiwidev (2022-03-16, 2022-03-21)

### File Splitting via Float Deduplication
- Split files based on sdata2 (const float) deduplication.
- sdata2 is always const; sdata and data floats can be duplicated.
- Tools being developed to automate this process.
- Source: altafen, epochflame (2022-03-14)

### Address Types in Melee
- In-file offset: literal bytes in the .dol (used by asmdiff.sh, hxd/cmp)
- Starting address: map file only, offset from section start
- Virtual address: used by map file, objdump.elf
- Source: altafen (2022-03-16)

### Grep for Interesting Code Snippets
- `grep -r '\\->' asm/` reveals struct access patterns and naming conventions from assertion strings.
- Source: rtburns (2022-03-26)

### Finding ASCII Strings in ASM
- Converting hex data to .asciz literals reveals .c filenames and assert expressions.
- Shift-JIS strings may need special handling.
- Source: rtburns (2022-03-17)

## Pitfalls and Gotchas

### Extern Usage Patterns
- Using `extern lbl_XXXXXXXX` for local data is quick and dirty but generally fine for scratches.
- Extern floats and strings instead of literals can cause issues.
- `extern []` and `extern *` do not mean the same thing.
- Header declarations with extern are cleaner for multi-file usage.
- Source: epochflame, seekyct (2022-03-08)

### Akaneia Context Warning
- Scratches marked "OLD VERSION -- uses the Akaneia context" use non-canonical types.
- Akaneia is a custom Melee build with guessed types - not verified for matching.
- Do not trust these types without verification.
- Source: revosucks, cortex420 (2022-03-20)

### Context Changes Can Break Old Scratches
- Changing a struct member type (e.g., u32 to f32) may fix one function but break others.
- Consider unions when fields appear to have different types in different functions.
- Source: altafen (2022-03-18)

### Fake Matching Caveats
- Inline ASM fake matches count toward progress but are not truly matched.
- Easy to grep for: search for inline asm patterns to find functions needing real matches.
- Source: rtburns, valorzard (2022-03-31)

### Progress vs Completion
- "100% progress" is not the end - continued refactoring needed after matching.
- Inline ASM functions, structure improvements, and type corrections remain.
- Source: rtburns (2022-03-31)

## Historical Notes

### The Frank Patch Mystery
- Melee uses a patched version of mwcc (mwcc_233_163n) believed to be from a "CWUpdate.zip" hotfix.
- Known games using this patch: Pikmin 1, Melee, possibly Sonic Adventure 2.
- The patch affects epilogue scheduling.
- Archive.org link to patch notes: https://web.archive.org/web/20011121032509/http://www.metrowerks.com:80/games/gamecube/update/
- The actual CWUpdate.zip file has never been found despite extensive searching.
- Multiple former Metrowerks employees contacted, including MWRon, with no success.
- Source: revosucks, epochflame (2022-03-31)

### Progress Milestones (March 2022)
- Started ~2.1% code
- After Marth: 2.49% code
- End of month: 3.38% code, 2.65% data
- Trophies: 7 -> 9 (of 290)
- Event Matches: 1 (of 51)
