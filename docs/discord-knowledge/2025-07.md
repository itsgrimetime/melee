# Decompilation Knowledge: 2025-07

This month saw significant progress with the project reaching 36% matching (up from ~26% in May). Key discussions covered GET_FIGHTER macro issues, dat_attrs getters, splitting strategies, file organization, and tooling improvements.

## Compiler Patterns

### GET_FIGHTER Macro and HSD_GObjGetUserData Cast Issue
- The cast `(HSD_GObj*)gobj` inside `GET_FIGHTER` causes stack and codegen issues
- **Problem**: `#define GET_FIGHTER(gobj) ((Fighter*) HSD_GObjGetUserData((HSD_GObj*) gobj))` is wrong
- **Correct**: `#define GET_FIGHTER(gobj) ((Fighter*) HSD_GObjGetUserData(gobj))`
- This cast was added for m2c (decompiler) to understand the user_data type, but it breaks real matching
- On decomp.me, the cast cannot be removed due to #ifdef not being supported
- Workaround for decomp.me: define a separate inline `HSD_FGObjGetUserData` that takes `Fighter_GObj*`
- Source: revosucks, altafen, ribbanya (2025-07-03)

```c
// Broken decomp.me version
#define GET_FIGHTER(gobj) ((Fighter*) HSD_FGObjGetUserData((HSD_GObj*) gobj))

// Fixed version for local builds
#define GET_FIGHTER(gobj) ((Fighter*) HSD_FGObjGetUserData(gobj))
static inline void* HSD_FGObjGetUserData(Fighter_GObj* gobj)
{
    return gobj->user_data;
}
```

### dat_attrs Getter Pattern
- There appears to be a getter inline for `fp->dat_attrs` similar to GET_FIGHTER
- Using `getFtSpecialAttrsD(fp)` with a cast fixes stack issues in some functions
- Example: `ftKb_DatAttrs* dat_attr = (ftKb_DatAttrs*)getFtSpecialAttrsD(fp);`
- This may explain extra stack padding in many fighter functions
- Source: revosucks (2025-07-25, 2025-07-29)

### Loop Unrolling Conditions
The compiler "likes" to unroll loops when:
- `i` is an int
- Fixed number of iterations, or 0 to some scalar iteration bound
- No function calls in the body of the for loop
- u8 cast on index can trigger unrolling (e.g., `HSD_PadCopyStatus[(u8)i]`)
- Source: rtburns (2025-07-26)

### Stack Allocation Behavior
- Stack usage increases in "pairs" - 64-bit amounts internally
- PAD_STACK only changes asm in increments of 4, then stays same for next 8
- GET_FIGHTER macro uses stack space, but won't increase overall stack until stack is "used again"
- Source: revosucks, bbr0n (2025-07-24, 2025-07-28)

### Inline Depth Limit
- Melee's inline depth is approximately 3 levels
- To prevent inlining, nest the function in other inlines until compiler stops
- Static functions without calls can become inlines within the same TU
- Source: ribbanya (2025-07-25)

### Function Size and Inlining
- Bigger functions won't inline (max inlined function size is compiler-dependent)
- Moving assignments into conditionals can make a function "smaller":
```c
// "Bigger" version
foo = bar;
if (foo < foobar && otherThing() == blah) { ... }

// "Smaller" version - may inline when above won't
if ((foo = bar) < foobar && otherThing() == blah) { ... }
```
- Source: revosucks (2025-07-25)

### Int to Float Conversion Assembly
- `xoris` and `fsubs` instructions appear for int-to-float conversions
- Compiler uses bitwise operations to move bits to correct float representation
- No int->float register move opcodes exist, so values go through stack
- Source: rtburns (2025-07-28)

### Debug Symbols (-sym on)
- Use `#pragma sym on` at top of file for line numbers in objdiff
- Or run `python configure.py --debug` to enable `-sym on` projectwide
- WARNING: `-sym on` changes codegen slightly in edge cases - not for matching builds
- Source: rtburns, kooshnoo (2025-07-15)

## Matching Techniques

### ABS vs fabs_inline
- `fabs_inline` is likely NOT real - prefer using `ABS` macro instead
- Replacing `fabs_inline` with `ABS` treewide improves matches
- The `nested_sum_fabs` inline was overly complicated - code recomputed absolute value multiple times due to using ABS macro inside itself
- Source: ribbanya, rtburns (2025-07-28)

```c
// Before (overly complicated)
float final_y_pos = nested_sum_fabs(
    fp->cur_pos.y, pika_attr->xBC, fabs_inline(pika_attr->xBC), vec.y);

// After (cleaner)
float final_y_pos = ABS(fp->cur_pos.y + ABS(pika_attr->xBC) - vec.y);
```

### Avoiding Temps for Instruction Order
- Don't use temporary variables when trying to flip instruction order
- Direct struct access often produces better instruction ordering
- Source: altafen (2025-07-11)

### Vec3 Chained Assignment
- When you see z, y, x stores in reverse order, it's usually chained assignment:
```c
// This produces z, y, x order in asm
fp->self_vel.x = fp->self_vel.y = fp->self_vel.z = 0.0f;
```
- Value on right travels left until it reaches start
- Source: revosucks (2025-07-25)

### Register Usage and Missing Arguments
- If r3 is not being used after a function call setup, it was passed to that function
- r3 is the first argument - if code uses r4 where r3 expected, you're missing an argument
- Volatile registers are r3-r8 and f1-f8
- Read from r3, r4, or f1 following a function callsite means that function returns something
- Source: chippy__, revosucks, foxcam (2025-07-19, 2025-07-22)

### Struct Copy vs Individual Stores
- `lwz` sequences loading Vec3 components are often struct copies:
```c
fp->mv.kb.speciallw.x18 = fp->coll_data.floor.normal;  // struct copy
```
- Source: revosucks (2025-07-25)

### Fighter Parts Array Access
- When you see offset like 0x2B0 from FighterBone, it's array indexing:
```c
// Wrong: Adding field to FighterBone struct
// Right: Index into parts array
fp->parts[FtPart_YRotN].joint  // Use enum for correct index
```
- FighterBone size is well understood - don't modify it
- Source: rtburns, ribbanya (2025-07-12)

### Ternary for Facing Direction
```c
// Common pattern for facing direction checks
var_r4 = (fp->facing_dir == 1.0f) ? 1 : -1;
```
- Source: revosucks (2025-07-25)

### PAD_STACK Usage
- PAD_STACK is "fake" but not harmful if it doesn't affect functionality
- Organic match using inlines is better, but PAD_STACK is acceptable
- **Harmful case**: When passing pointers to stack data that reads/writes to padding
- This triggers UB - better compiler would optimize out padding
- Source: rtburns (2025-07-24)

### GET_JOBJ May Be Fake
- Evidence suggests `GET_JOBJ` macro may not be real
- Direct access `gobj->hsd_obj` sometimes works better than the macro
- Functions with `HSD_JObjGetNext(HSD_JObjGetChild(...))` chains may not use the macro
- Source: revosucks, ribbanya (2025-07-29, 2025-07-30)

### Common Kirby Inline Pattern
```c
inline void ftKirbyDmgInline(Fighter_GObj* gobj) {
    Fighter* fp = GET_FIGHTER(gobj);
    fp->death2_cb = (void (*)(HSD_GObj*)) ftKb_Init_800EE74C;
    fp->take_dmg_cb = (void (*)(HSD_GObj*)) ftKb_Init_800EE7B8;
}
```
- Used to reset Kirby's copied ability on damage/death
- When you see `temp_r4 = gobj->user_data;` followed by callback assignments, it's likely inline start
- Source: theplayerrolo, rtburns (2025-07-24)

### HSD_PadCopyStatus Access Inline
```c
inline u32 Get_HSD_PadCopyStatus(u8 i) {
    return HSD_PadCopyStatus[i].button;
}
```
- The u8 parameter eliminates need for explicit casts
- May explain unrolled pad status loops
- Source: rtburns, revosucks (2025-07-26)

## Type Information

### Fighter_GObj and ftKb_GObj
- `Fighter_GObj` is kept because it helps m2c understand user_data type
- Character-specific GObj types (`ftKb_GObj`, `ftYs_GObj`) were placeholders never finished
- These should just be `typedef struct HSD_GObj ftKb_GObj;`
- The per-fighter types are being removed as they cause confusion
- Source: ribbanya, altafen (2025-07-24)

### VsModeData and MatchExitInfo Structs
- MatchEnd struct appears correct but may need padding at end
- MatchExitInfo needs to be split into multiple structs containing MatchEnd at different offsets
- Source: rtburns (2025-07-16)

### Section Data Access Patterns
- mwcc places pointer to .data or .rodata, then offsets to grab actual symbol
- Large offset in codegen means you're referencing within a large unsplit TU
- Example: Kirby's ftKb_Init is ~20 unsplit files, causing large data offsets
- Don't trust objdiff on section offsets - verify in Dolphin manually if needed
- Source: revosucks, ribbanya (2025-07-25)

### Bitfield Union Portability Issues
- Accessing same data with different union members is UB
- Byte order differs on big-endian (PPC) vs little-endian (x86/ARM)
- Bit order/packing is implementation-defined
- Need to unify bitfield unions for future PC port
- Source: rtburns (2025-07-28)

```c
// This union structure will be problematic for porting
/* fp+221C */ union {
    /* fp+221C */ struct { u8 x221C; u8 x221D; };
    /* fp+221C */ struct { u8 x221C_b0 : 1; ... };
    /* fp+221C */ struct { u16 x221C_u16_x : 7; ... };
};
```

### Scene Organization
- Major scenes = "modes" (e.g., VS Mode, Classic Mode)
- Minor scenes = "scenes" within modes (e.g., character select, stage select)
- Kirby Air Ride osreport errors use "gmmode" and "gmscene"
- Source: gamemasterplc (2025-07-27)

## Function-Specific Insights

### Fighter Callbacks
- `fp->accessory4_cb` is commonly used for character-specific state callbacks
- `fp->death2_cb` and `fp->take_dmg_cb` reset copied abilities (Kirby)
- HAL tends to start almost every function with setting the fp variable
- Seeing a second GET_FIGHTER suggests an inline function
- Source: revosucks (2025-07-24, 2025-07-25)

### mn_8022DDA8_OnEnter Varargs
- Calls `lbArchive_LoadSymbols` with ~168 arguments
- Takes list of {pointer, symbol name} tuples for loading from dat files
- Terminating zero argument pushed to sp + 0x284
- Source: rtburns (2025-07-25)

### THPDec Differences
- Melee's THPDec passes decoder state as struct to each function
- Other projects use globals for decoder state
- Source: rtburns (2025-07-30)

### Static Functions and Inlining
- Every static function could turn into inlines within the TU
- If previous function in file hit inline limit, it exposes the inline at end of TU
- Source: revosucks (2025-07-29)

## Tool Tips

### decomp.py
- Run `python3 tools/decomp.py <function name>` for local decompilation
- Uses all headers in context automatically
- Context generated to `build/ctx.c` by ninja
- Can run m2c directly for entire files: `python -m m2c.main -t ppc-mwcc-c --context build/ctx.c file`
- Source: altafen, foxcam (2025-07-13)

### objdiff
- VSCode extension available: `decomp-dev.objdiff`
- CLI usage: `build/tools/objdiff-cli diff -p . <function_name>`
- Run `python configure.py && ninja` before using
- Export symbols from Dolphin: load .elf and export, works for shifted addresses
- Source: encounter, ribbanya, foxcam (2025-07-13, 2025-07-30)

### Checking for Regressions
```bash
# Check out known good commit (like master)
ninja baseline
# Check out your commit
ninja changes_all  # Shows all changes
ninja changes      # Shows only regressions
```
- Function renames will count as broken
- Source: ribbanya, altafen (2025-07-27)

### split_suggester.py
- Fixed to work again (was bitrotted)
- Shows possible file split arrangements
- Doesn't know about dtk's asm macros
- Source: altafen (2025-07-02)

### Branch Watch Tool (Dolphin)
Workflow to find functions needed for a specific path:
1. Start branch watch, start game
2. Navigate to starting point (e.g., title screen)
3. Hit "code path not taken" - ignores everything that ran before
4. Perform action (e.g., press start to go to main menu)
5. Hit "code path was taken" - saves calls between the two points
6. File > save branch watch as
- Output: `origin, destination, instr, total_hits, hits_snapshot, flags`
- Source: altafen (2025-07-31)

### decomp-permuter
- Useful for functions with many floats where reordering declarations changes regalloc
- Import from decomp.me PR: https://github.com/simonlindholm/decomp-permuter/pull/134
- Source: rtburns (2025-07-29)

### enter-the-fray Branch
- rtburns' src-only branch for bootable builds
- Run `./configure.py --demo` to enable nonmatching builds and stub functions
- Boots to title screen, can modify starting scene in `gm_801BF9A8`
- Stubs print function name on panic
- Required asm objects for title screen: `particle.o, math.o, OSSerial.o, texpdag.o, dolphin/mtx/mtx.o, lb_0192.o`
- Source: rtburns (2025-07-28, 2025-07-29)

### clang-format for Cleanup
- Run `git-clang-format upstream/master` to reformat
- Fixes trailing whitespace
- Use editorconfig plugin to prevent trailing whitespace
- Source: rtburns (2025-07-28)

## Pitfalls and Gotchas

### M2CTX Macros on decomp.me
- decomp.me cannot use #ifdef directives
- m2c doesn't support directives: `Syntax error when parsing C context. Directives not supported yet`
- This is why GET_FIGHTER has the extra cast on decomp.me
- Source: rtburns (2025-07-03)

### Include Path Issues
- MWCC has broken quote-include behavior (issue #1565)
- Prefer angle-bracket includes: `<melee/gm/types.h>` over `"melee/gm/types.h"`
- Quote includes check PWD first, then -I directories
- Angle-bracket includes only check -I directories
- Source: rtburns (2025-07-25)

### func_XXXXXXXX Addresses Can Be Wrong
- Address in function name can get mangled (e.g., by AI comments)
- Always verify against symbols.txt
- `func_80081A24` wasn't even in symbols.txt
- Source: ribbanya (2025-07-24)

### Float Literals vs Extern Floats
- Externed floats like `ftYs_Init_804D9A38` are just literals
- Check asm to find value (e.g., `.float 0`) and replace with `0.0F`
- Don't commit extern float declarations - inline the values
- Source: rtburns (2025-07-21)

### Missing Header Causes lfs/lfd Issues
- Getting `lfs` instead of `lfd` (or vice versa) often means missing include
- Example: Including fighter.h fixed float load mismatch
- Example: Missing atan2f header caused different codegen
- Source: gelatart, gamemasterplc (2025-07-09, 2025-07-24)

### efSync_Spawn Variadic
- `efSync_Spawn` is variadic - missing include causes different codegen
- Include `ef/efsync.h` to fix
- Source: gamemasterplc, rtburns (2025-07-12)

### Splitting Considerations
- Float constants get deduplicated within a file but not between files
- If target sdata2 has multiple copies of same float (e.g., 13 copies of 1.0F), need multiple files
- Section boundaries rounded to 16 bytes by compiler
- Split boundaries can be identified by repeated float patterns in sdata2
- Don't split unless necessary - objdiff workflow makes splitting an afterthought
- Source: altafen, ribbanya (2025-07-02, 2025-07-25)

### .static.h Files
- Temporary files for m2c/decomp.py to see struct definitions
- Contents should move into .c file once matching
- Source: altafen, rtburns (2025-07-19)

### Build Failures After Branch Switch
- Delete `build/GALE01` to fix mysterious build failures after switching branches
- `ninja -t clean` doesn't always work
- Old split objects don't get removed when splits change
- Source: altafen, encounter (2025-07-30)

### Symbol Shifts in Demo Build
- Demo/nonmatching builds have shifted addresses
- Load .elf into Dolphin and export symbols for correct addresses
- Or use `powerpc-eabi-objdump -d --section=.text build/GALE01/main.elf | less`
- Source: rtburns, foxcam (2025-07-30)

### Struct Size Changes with Anonymous Structs
- Removing anonymous struct wrapper around bitfields can change Fighter size in mwcc
- But not in clangd - implementation difference
- Source: ribbanya, rtburns (2025-07-28)

## Project Progress

### Milestone: 36% Matched
```
Progress:
  All: 36.18% matched, 24.59% linked (557 / 903 files)
    Code: 1405160 / 3883984 bytes (12535 / 19891 functions)
    Data: 175769 / 1211496 bytes (14.51%)
```
- 10% increase in 2 months (from ~26% in late May)
- Source: werewolf.zip (2025-07-28)

### Trophy Tracking
- 72 trophies at 36% progress
- F pool (72 trophies) -> E pool (12) -> D pool (23) -> C pool (17) -> B pool (10) -> A pool (4)
- 133 total through lottery
- Remainder need matches/special circumstances
- Source: werewolf.zip, revosucks (2025-07-28)

### Compiler Versions Used
- 1.2.5n for most things
- 1.2.5 for some things
- 1.1p1 for TRK
- Source: ribbanya (2025-07-25)
