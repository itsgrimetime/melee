# Decompilation Knowledge: February 2022

A very active month with 5,049 messages. Major milestones included reaching 2% code decompilation, fixing r40 compatibility, and extensive fighter struct work.

## Compiler Patterns

### Frank and Epilogue Patching
- Melee was compiled with a patched version of mwcc 1.2.5 that reorders epilogue instructions
- The patch was distributed via a Nintendo FTP (now lost) and has never leaked
- `frank` is a tool that attempts to replicate this patching behavior
- Using explicit `-inline auto` with Frank can break non-inline functions by introducing 2 extra instructions after prologue
- Source: werewolf.zip (2022-02-02)

### Frank vs FrankLite
- `franklite.py` (Pikmin 2) handles only the mtlr shift case, doesn't need the 1.2.5e compiler
- Full Frank requires both vanilla 1.2.5 and the edited 1.2.5e compiler
- If only one function in a file needs epilogue fix, use FrankLite approach
- Source: epochflame (2022-02-02)

### Static Leaf Functions and Inline Auto
- Static leaf functions get promoted to inlines by `-inline auto`
- This has different behavior vs. normal inlines (see lbvector for examples)
- Can affect float register allocation
- Source: revosucks (2022-02-02)

### Float Register Sensitivity
- Float register allocation is extremely sensitive to:
  - Inline functions
  - Static return values
  - Static variables
  - Code at the end of a function can alter register allocation at the beginning
- Source: revosucks (2022-02-02)

### Loop Unrolling Rules
Discovered heuristics for when mwcc will unroll loops (under -O4,p):
- If loop contains a non-inlined function call: will NOT unroll
- If loop counter is not int/long: will NOT unroll
- In C, maximum 9 iterations (1.2.5) or 12 iterations (2.6) will unroll
- In C++, maximum 16 iterations will unroll
- Inlined function calls do NOT prevent unrolling
- Source: epochflame (2022-02-27)

```c
// This WILL unroll (inline function doesn't count as function call):
inline void piss(void){return;}
void example(void) {
    int i;
    for (i = 0; i < 9; i++)
        piss();
}

// This will NOT unroll (10+ iterations in 1.2.5):
for (i = 0; i < 10; i++)
    piss();
```

### Pragma Peephole
- Some functions require `#pragma peephole on` to match
- Important to add after inline asm functions
- Source: rtburns (2022-02-18)

### C99 Features (c9x pragma)
- `#pragma c9x on` enables partial C99 support
- Enables compound literals: `(MyStruct){0, 1, 2, 3}`
- Does NOT enable `offsetof` in mwcc 1.2.5 (only 1.3x+)
- SMB decomp uses compound literals to match
- Source: revosucks, werewolf.zip (2022-02-20)

### Enum Size
- Enums are always 32-bit due to `-enum int` compiler flag
- Source: kalua (2022-02-20)

## Matching Techniques

### sdata2 Float Literal Technique
To match functions that use shared float literals while only partially decompiling a file:

1. Split the .sdata2 section into a separate .s file containing data BEFORE your function's floats
2. Place your .c file after that .s file in obj_files.mk
3. Place the remainder of the original .s file after your .c file
4. Comment out the float definitions in the .s file that your .c file now provides

Alternative approach using linker symbols:
```asm
/* In your .s file, replace: */
lfs f2, lbl_80123468@sda21(r2)
/* With: */
lfs f2, lbl_80123468-_SDA2_BASE_(r2)
```
Then define the addresses in the linker script.
Source: camthesaxman (2022-02-19)

### Inline ASM with Negative Floats
- Negative float literals don't work directly in inline asm: `lfs f5, -2.0f` fails
- Hex literals also don't work (become 0.0f)
- Solution: Use hardcoded SDA2 offsets:
```c
#define SDA2_BASE_LD 0x804DF9E0
#define asm_lbl_804D7FAC (0x804D7FAC - SDA2_BASE_LD)

// Then in inline asm:
lfs f5, asm_lbl_804D7FAC(r2)
```
Source: rtburns (2022-02-23)

### String Literal Alignment in decomp.me
- Strings go to .sdata if small enough, .data if too large
- "fighter sub color num over!" goes to .data (too large)
- "jobj" goes to .sdata
- Use fake char* declarations to align .data offsets in decomp.me:
```c
// Incorrect strings here to get offset from data start to align
char* x = "PlCo.dat";
char* y = "ftLoadCommonData";
```
Source: snuffysasa, epochflame (2022-02-22)

### File Ordering in obj_files.mk
- Objects must be in exact linker order
- When moving functions from .s to .c: src/.../file.o must come BEFORE asm/.../file.o
- Functions in .c are placed in order they appear; putting them out of order breaks matching
- Source: tri_wing_, altatwo (2022-02-19)

### Inline ASM Requirements
- `nofralloc` must be first directive in inline asm functions
- Use `#pragma peephole on` after inline asm functions
- Source: kalua (2022-02-14)

### fctiwz Instruction
- `fctiwz` is float-to-int conversion with truncation toward zero
- Converts 32-bit float to 32-bit signed integer
- Appears when casting float to int
- Source: tri_wing_, kalua (2022-02-21)

### memcpy for Struct Assignment
- `__memcpy` calls often indicate struct assignment
- Original programmers likely used direct struct assignment, not explicit memcpy
- Source: altatwo (2022-02-22)

### Const Variables and Stack
- Declaring something `const` allocates stack space but compiler puts value in-place
- Results in unused stack space in the final code
- Source: werewolf.zip (2022-02-20)

## Type Information

### Fighter Struct Key Offsets
- `x2200-x2240`: Union/array area used differently per character
  - Sheik uses as array of 0xC sized structs
  - Bowser uses x2230, x2234 as floats
  - Other fighters may use as u32 flags
- `x914`: First hitbox struct
- `0x138`: Hitbox struct size
- `x960, x96C`: Vec3 floats (position-related)
- `x6F0`: CollData pointer (`ft->x6F0_collData`)
- Source: werewolf.zip, cortex420, rtburns (various dates)

### FighterBone Joint Elements
- Joint elements are byte-sized (u8), not 32-bit
- Source: rtburns (2022-02-21)

### HSD_GObj Classifier Values
```c
#define GOBJ_KIND_MENU_COBJ 1
#define GOBJ_KIND_LIGHT 2
#define GOBJ_KIND_JOBJ 3
#define GOBJ_KIND_FOG 4

#define GOBJ_CLASS_STAGE 0x2
#define GOBJ_CLASS_CAMERA_RUMBLE 0x3
#define GOBJ_CLASS_PLAYER 0x4
#define GOBJ_CLASS_ITEM 0x6
#define GOBJ_CLASS_GFX 0x8
#define GOBJ_CLASS_TEXT 0x9
#define GOBJ_CLASS_HSD_FOG 0xA
#define GOBJ_CLASS_HSD_LOBJ 0xB
#define GOBJ_CLASS_HSD_COBJ_TITLE 0x13
```
Source: werewolf.zip (2022-02-25)

### HSD_ObjAllocData
- Some instances have 4 extra bytes at end (0x30 vs 0x2C size)
- Related to BSS alignment requirements
- Extra bytes appear unused but needed for alignment
- Source: werewolf.zip, epochflame (2022-02-20)

### Abbreviations/Naming
- HSD = HAL SysDolphin
- GObj = Game Object (or Global Object)
- JObj = Joint Object
- gr = Ground (stages)
- ft = Fighter
- pl = Player
- mn = Menu
- it = Item
- grTMars = Marth Target Test
- grLast = Final Destination
- grGarden = Fountain of Dreams
- grOldPupupu = Dream Land
- Source: werewolf.zip (various dates)

### Fighter File Organization
- Each fighter has: ftFox.c, ftFoxSpecialN.c, ftFoxSpecialS.c, ftFoxSpecialHi.c, ftFoxSpecialLw.c
- Located under ft/chara/fox/
- Action state tables determine split points
- Special attacks are sequential after basic fighter setup code
- Source: werewolf.zip (2022-02-02)

## Function-Specific Insights

### HSD_Rumble (rumble.c)
- Function names from K7's ELF dump
- Completely decompiled by camthesaxman (2022-02-21)
- Uses HSD_PadCopyStatus struct
- Source: camthesaxman

### lbArchive_InitializeDAT
- Part of file loading system
- Source: werewolf.zip

### Clone Fighter Functions
- Many clone fighters have nearly identical code
- Dr. Mario, Falco, Young Link, etc. have very short base files
- Item-related and loading functions are copy-paste between characters
- Source: rtburns (2022-02-19)

### Bytecode.s
- Giant state machine function
- Extremely difficult to decompile
- Source: werewolf.zip (2022-02-21)

## Tool Tips

### decomp.me
- Use scratch context that avoids `sizeof()` to make mips_to_c work properly
- Can rerun decompilation after updating context
- Data offset differences may require fake string declarations to align
- Does NOT handle string literal offsets correctly (shows (0) instead of (r2)/(r13))
- String literals will match in real build if const settings are correct
- Source: tri_wing_, seekyct (various dates)

### Map File Generation
- `GENERATE_MAP=1 make` generates map file
- Requires linker to run; touch a source file if map not regenerating
- Map generation is slow
- Source: altatwo, revosucks (2022-02-20)

### r40 DevkitPPC Compatibility
- Requires `.balign 8` at start of data/sdata/sbss/sdata2 sections at file boundaries
- Remove `.4byte NULL` padding that was faking alignment
- BSS sections may need special handling (moved to different files)
- calcprogress.py counts balign as decompiled code, inflating percentages
- Source: epochflame, werewolf.zip (2022-02-20)

### calcprogress Script Issues
- Object files with same name (e.g., dolphin/mtx.s.o and baselib/mtx.s.o) can confuse scripts
- Kiwi's script looks up by obj_name without full path
- Solution: Use `.c.o` and `.s.o` file extensions to distinguish decompiled vs asm
- Source: camthesaxman, kiwidev, werewolf.zip (2022-02-21)

### Ghidra Setup
- PPC support works out of box
- For GameCube: need Ghidra-GameCube-Loader plugin
- Bitfield support exists but tricky to configure
- Source: epochflame, werewolf.zip (2022-02-26)

### Checking Struct Offsets
- Use decomp.me: Write function accessing struct members, check generated offsets
- GCC struct packing differs; use `#pragma pack(push, 1)` and `#pragma pack(pop)`
- Can use newer mwcc compiler with `#pragma c9x on` for offsetof if just checking
- Source: kalua, cortex420, revosucks (2022-02-20)

### asmdiff.py Usage
- Extract boot.dol from ISO (Dolphin File System -> sys/main.dol) as baserom.dol
- Provide function offset (e.g., 0x0014BAA8) for targeted diff
- Source: werewolf.zip (2022-02-19)

## Pitfalls and Gotchas

### Trust No One's Work
- Akaneia struct definitions often have errors:
  - x2200 area is array of 0xC structs for Sheik, not individual flags
  - Many field types and names are wrong
- Always verify against matching assembly
- Source: werewolf.zip (2022-02-02, 2022-02-17)

### Unsigned vs Signed Types
- Can produce identical code in many cases
- PPC comparison instructions give more info than other architectures
- Must reconcile across all functions using a type
- Source: revosucks (2022-02-20)

### Static vs Global Functions
- Static functions aren't visible outside their file
- When using inline asm, may need to make static functions global temporarily
- Comment out `static` with `/* static */` until function is fully matched
- Source: werewolf.zip (2022-02-14)

### Function Label Detection
- Original doldisasm only marked functions if `bl`-ed to
- Callbacks passed as pointers got labeled as `lbl_` instead of `func_`
- Must manually fix these by adding `.global` and renaming to `func_`
- Source: camthesaxman, werewolf.zip (2022-02-14)

### ble vs blt Errors
- `<=` vs `<` comparison differences are subtle
- Double-check loop bounds: array[33] with `i <= 33` iterates 34 times
- Source: epochflame, kalua (2022-02-15)

### e_files.mk for Epilogue Fixes
- Add files to e_files.mk to enable Frank epilogue patching
- Run `make clean` after adding to ensure rebuild
- Source: kalua (2022-02-15)

### Multiple Functions Under One Label
- The disassembly has many instances of multiple functions under single label
- Not an error, just incomplete manual function splitting
- Look for `blr` instructions but note some functions have multiple returns
- Source: rtburns, snuffysasa (2022-02-22)

### Extern Floats Change Register Allocation
- `extern float` declarations can change register allocation
- May need to keep going until file is complete to use proper literals
- Source: altatwo (2022-02-02)

### Linker Cannot Be Changed
- GCC linker cannot link MWCC .o files due to EABI differences
- Stuck with MWLD even after full decompilation
- Source: werewolf.zip, revosucks (2022-02-26)

## Build System Notes

### Compiler Toolchain
- Main compiler: mwcc 1.2.5e (epochflame's edited version)
- Linker: mwld 1.1 (faster) or 1.2.5 (more compatible)
- Linker 1.1 has issues on Wine/MSYS2 for some users
- 1.2.5 linker is ~30-45 seconds slower
- Source: werewolf.zip (2022-02-02)

### Object File Naming for r40
```makefile
# Use .c.o and .s.o extensions:
# example.c compiles to example.c.o
# example.s assembles to example.s.o
```
This allows calcprogress to distinguish decompiled from assembly code.
Source: camthesaxman (2022-02-21)

## Sysdolphin Knowledge

### K7 (Killer 7) Reference
- Killer 7 source code partially leaked years ago
- Contains debug ELFs with sysdolphin symbols
- Useful for struct definitions, but version differs from Melee
- Newer versions have error checking Melee lacks
- Source: werewolf.zip (2022-02-21)

### HAL "C with Classes" Pattern
- Sysdolphin uses pseudo-classes in C
- Class-based objects have Info struct with callbacks:
  - Alloc, Init, Release, Destroy, Amnesia
  - Extended callbacks in later versions include Update
- Also has Object type: Class + reference counting
- Source: werewolf.zip (2022-02-25)

### GObj System
- GObj allocated for anything with per-frame changes
- Covers: Menus, Stages, Cameras, Items, Stage Hazards, Adventure mobs, Fighters
- user_data is void* - can be anything
- 64-bit gxlink_prios bitflag for priority levels
- Source: werewolf.zip (2022-02-25)

## Progress Notes

### Key Milestones This Month
- Started at ~1.5% code decompiled
- Reached 2% code decompiled (2022-02-22)
- Trophy count: 4 -> 6
- r40 DevkitPPC compatibility achieved
- Rumble.c fully decompiled
- Many clone fighters completed (Falco, Young Link, Dr. Mario, Ganondorf, etc.)

### File Completion Status
- ftSandbag: Complete
- rumble.c: Complete
- Most clone fighters: Complete (short files)
- fighter.c: 15% (kalua working)
- player.c: Complete (mostly)
