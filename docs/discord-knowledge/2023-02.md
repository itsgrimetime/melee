# Decompilation Knowledge: 2023-02

Distilled from 128 messages in #smash-bros-melee during February 2023.

Note: This was a quieter month, with January and March having significantly more activity.

## Compiler Patterns

### Int-to-Float Conversion Magic Numbers
- When converting an `int` to a `float`, the compiler generates a reference to a double constant (e.g., `lbl_804D9648`)
- This double is a compiler-generated magic number used for accurate conversion
- Must be a double to accurately represent any 32-bit integer
- The assembler keeps/creates a reference to this constant because runtime generation alone cannot handle all cases
- If you see a reference to an unexplained double in sdata2, check for int-to-float conversions
- Source: chippy__, gamemasterplc (2023-02-14)

## Type Information

### m-ex Types vs Decomp Types
- Some types in m-ex (https://github.com/akaneia/m-ex) are more thoroughly named than in the decomp
- Decision was made to start the decomp from scratch to avoid propagating spurious assumptions
- It's acceptable to reference m-ex for naming hints, but names should be validated before use
- When uncertain about a struct member with an m-ex name, keep the hex offset name and put the m-ex name in a comment
- Source: rtburns, vetroidmania (2023-02-15)

### Mario Kart GP Uses HSD
- Mario Kart Arcade GP uses HSD (HAL SysDolphin), potentially useful for cross-referencing HSD behavior
- Source: amber_0714 (2023-02-12)

## Matching Techniques

### Array Access with Constant Offsets
- A label like `lbl_804D6554[275]` pointing to `804D69A0` indicates array access with a computed offset
- The index 275 times the element size plus base address equals the target
- Useful for identifying array types and element sizes
- Source: .durgan (2023-02-26)

## Tool Tips

### Windows Build Without MSYS2/DevKitPro
- The build can work on Windows using only Git for Windows and MinGW (plus Python3)
- Key dependency is `powerpc-eabi-as.exe` from https://github.com/JLaferri/gecko
- Build command:
  ```
  make GENERATE_MAP=1 WINDOWS=1 AS=../gecko/powerpc-eabi-as.exe
  ```
- Can install MinGW via `choco install mingw` or from https://www.mingw-w64.org/
- This simplifies newcomer onboarding significantly
- Source: ribbanya, .durgan (2023-02-25)

### DevKitPro Still Needed for Gekko Instructions
- Generic PowerPC embedded binutils don't support all instructions used in Melee
- DevKitPro's patches add support for Gekko-specific PS vector instructions
- Patch reference: https://github.com/devkitPro/buildscripts/blob/b5de354a1ef989df7f76f9faec723e780e75e9d3/dkppc/patches/binutils-2.37.patch#L25
- Source: rtburns (2023-02-25)

### DTK Model Build System
- Discussion of moving to dtk-based build with ninja over make
- Would help eliminate devkit/msys dependencies on Windows
- Source: altafen (2023-02-25)

### Avoiding Binaries in Git
- Don't add binary executables directly to the git repo - "slippery slope"
- Alternative: Create a smaller compilers zip that includes necessary binaries
- Or submodule an external repo containing the binaries
- Source: rtburns (2023-02-25)

## Infrastructure Notes

### GitHub Actions CI Debugging
- `github.head_ref` is for getting the PR branch in workflows triggered by `pull_request`
- `github.ref` for PR workflows is the merge branch: `refs/pull/<number>/merge`
- EditorConfig action may fail on files added by a PR if checkout doesn't get the right ref
- When debugging CI, checking out `${{github.event.pull_request.head.ref}}` may help
- ChatGPT suggestions for CI fixes can work but may be overly verbose
- Local testing with https://github.com/nektos/act recommended but doesn't always work properly
- Source: ribbanya, rtburns (2023-02-28)

### GitHub Actions Branch Protection
- Build check names must match exactly for branch protection rules
- Renaming jobs (e.g., `build` to `build-ubuntu` and `build-windows`) requires updating repo settings
- PRs won't affect workflows until merged for security reasons
- Source: ribbanya, rtburns (2023-02-28)

## Terminology

### Subaction Scripts as Bytecode
- Melee's subaction script system resembles bytecode:
  - Opcode is 6 bits
  - Remaining bits are operands
  - Has GOTOs and maintains a state machine
- More accurately described as "binarized data" that functions like bytecode
- Bytecode usually implies a state machine (Turing complete or not)
- Bytecode typically runs on a virtual machine, not a real machine architecture
- Reference for subaction syntax: https://smashboards.com/threads/melee-syntax-and-guide-lets-make-super-characters.363714/
- Source: vetroidmania, clownssbm, gibhaltmannkill, werewolf.zip, mrb0nk500 (2023-02-18)

## Cross-Project References

### Smash 64 Code Similarity
- Some Melee functions have recognizable equivalents in Smash 64
- Example: https://decomp.me/scratch/6sKb8 resembles Smash 64 code
- Melee equivalent identified at `0x80008688`
- Source: vetroidmania (2023-02-17)
