# Decompilation Knowledge: 2023-06

## Compiler Patterns

### Inline Function Linkage Behavior (rtburns, 2023-06-29)
A significant discovery about how mwcc handles inline functions:
- **`static inline`** = LOCAL linkage - functions get duplicated into each Translation Unit (TU)
- **`inline`** (without static) = WEAK linkage - functions get ODR (One Definition Rule) deduplicated at link time

This explains functions like `lbColl_JObjSetupMatrix` appearing in melee code when it "should" be in HSD - it's actually `HSD_JObjSetupMatrix` as an `inline` function that got deduplicated into lbcoll.

Proof: https://decomp.me/scratch/Sff2V

Practical implication: Once lbcoll is fully matching, `lbColl_JObjSetupMatrix` can be renamed back to `HSD_JObjSetupMatrix` and unmatched asm will still link to it correctly.

### Inline Auto Depth Limits (Revo, 2023-06-29)
The `-inline auto` flag has heuristic-based limits:
- Usually stops inlining at depth 3 or 4
- Function length affects the decision - larger functions stop inlining sooner
- Smaller functions are more likely to be inlined at deeper levels
- If a "true inline" (defined in header) is called after the limit, it gets promoted to a standalone function in that TU

### Autoinlined Functions and Linker Behavior (rtburns, 2023-06-29)
Ordinary global functions (`void foo() { ... }`) used only locally:
- Have GLOBAL linkage in the object file
- If autoinlined, they will be stripped by the linker
- Otherwise they persist in the DOL

### Register Allocation and Type Casts (multiple contributors, 2023-06-05)
- Registers behave differently depending on types used and free register count
- Redundant casts (e.g., f32 to f32) are visual noise and should be removed
- Casting to/from `long <-> int` can produce unexpected codegen

### Optimization Level Confirmation (Revo, 2023-06-24)
Melee is firmly established as using `-O4,p` optimization level.

## Matching Techniques

### GET_FIGHTER Macro Validation (ribbanya, 2023-06-01)
Strong evidence for `GET_FIGHTER` macro correctness: https://decomp.me/scratch/CLSmu
- Works correctly with two fighters in an otherwise simple function

### Inline Patterns in Animation Functions (Revo, 2023-06-04)
Animation callback functions often call an inline/static function rather than the actual implementation directly:
```c
void ftCo_CaptureDamageKoopa_Anim(ftCo_GObj* gobj)
{
    inlineA0(gobj, ftCo_800BCC20);
}

void ftCo_CaptureDamageKoopaAir_Anim(ftCo_GObj* gobj)
{
    inlineA0(gobj, ftCo_800BCD00);
}
```
This pattern reduces code duplication when callbacks differ.

### JObj Inline Patterns (ribbanya, 2023-06-03)
Complex JObj access patterns involving ABS macro:
```c
if (ABS(fp_x1A50 + HSD_JObjGetTranslationZ(jobj)) <= fp->mv.co.capturekoopa.x10) {
    HSD_ASSERT2("jobj.h", 1126, "jobj", jobj);
    jobj->translate.z += fp_x1A50;
    if (!(jobj->flags & JOBJ_MTX_INDEP_SRT)) {
        HSD_JObjSetMtxDirty(jobj);
    }
}
```
The ABS macro is commonly used across many games - not unique to Melee.

### M2C Output Cleanup (Revo, 2023-06-24)
When working with m2c decompiler output:
- Remove as many temporaries as possible during initial cleanup
- Look at already-matched similar code for patterns
- Enable `-sym on` in compiler options to see line numbers for everything

### Item Code Patterns (rtburns, 2023-06-25-26)
Item code follows similar patterns to fighter code but uses `Item` instead of `Fighter`:
- `GET_ITEM` macro handles stack weirdness (similar to `GET_FIGHTER`)
- First function in each item's text section is typically an initialization function called from character animation code
- Item code includes not just throwables but also character animations, models, and NPC enemies
- Callbacks follow predictable patterns - good for farming percent

### Special Attributes in Items (rtburns, 2023-06-28)
When decompiling item functions with `void*` special attributes:
1. Identify the item type being worked on
2. Modify context so `x4_specialAttributes` is the correct type (e.g., `itChainSegment*`)
3. Rerun m2c/Decompile to get correct member access inference
4. For new items, define your own struct with members at the correct offsets

## Type Information

### Item Flags at xDC8 (Revo/vetroidmania, 2023-06-24)
Item struct has a word-sized flags field at offset 0xDC8:
```c
void it_80293D94(Item_GObj* arg0) {
    Item* item = GET_ITEM((HSD_GObj*)arg0);
    if (!item->xDC8_word.flags.xB && item->xDC8_word.flags.xA) {
        it_8026BC14(arg0);
    }
}
```
Contains u8-sized flag structs within.

### ftCo_GObj Typedef (ribbanya, 2023-06-02)
`ftCo_GObj` vs `HSD_GObj` - the fighter-specific typedef is just for M2C and readability:
https://discord.com/channels/727908905392275526/1105997646381981706

### Item_GObj Structure (ItzSwirlz, 2023-06-27)
```c
struct Item_GObj {
    /*  +0 */ u16 classifier;
    /*  +2 */ u8 p_link;
    /*  +3 */ u8 gx_link;
    /*  +4 */ u8 p_priority;
    /*  +5 */ u8 render_priority;
    /*  +6 */ u8 obj_kind;
    /*  +7 */ u8 user_data_kind;
    /*  +8 */ Item_GObj* next;
    /*  +C */ Item_GObj* prev;
    /* +10 */ Item_GObj* next_gx;
    /* +14 */ Item_GObj* prev_gx;
    /* +18 */ HSD_GObjProc* proc;
    /* +1C */ void (*render_cb)(Item_GObj* gobj, s32 code);
    /* +20 */ u64 gxlink_prios;
    /* +28 */ HSD_JObj* hsd_obj;
    /* +2C */ Item* user_data;
    /* +30 */ void (*user_data_remove_func)(Item* data);
    /* +34 */ void* x34_unk;
};
```

### It_Kind_Unk1 Discovery (rtburns, 2023-06-25)
`It_Kind_Unk1`'s initialization function is only called from Kirby SpecialN functions - related to suck/spit animation or copy star (when losing copy ability).

### Module Naming (kapedani, 2023-06-30)
`if` module stands for "info" (confirmed from Brawl) - HUD overlay stuff during matches. Contains iftime, ifstock, ifmagnify for on-screen overlays.

## Function-Specific Insights

### Super Yoyo Glitch Investigation (vetroidmania, 2023-06-26)
There is no "super yoyo glitch" in the original game code:
- Investigation confirmed no mechanism for hit target record to clear automatically
- 20XX mod uses an onframe function that constantly refreshes the hitbox to simulate it

### ftColl_8007A06C (ribbanya, 2023-06-02)
Large function with 0% initial match:
```
Function            Size   Score     Max      %
ftColl_8007A06C  2.78 KB  69,500  69,500  0.00%
```

### it_802ADA1C (rtburns, 2023-06-25)
Start of itunk1's text section - first function is initialization for Kirby's copy star item.

## Tool Tips

### Context Generation for decomp.me (rtburns, 2023-06-15)
To speed up m2c processing:
- Edit the `files` list in m2ctx `write_header` to only use needed headers
- Omitting unused function declarations speeds up pycparser
- For HSD work, you often only need a couple of HSD structs without any melee code

Auto-generated context available at: https://doldecomp.github.io/melee/ctx.html (altafen, 2023-06-22)

### __FILE__ Macro Behavior (rtburns, 2023-06-03)
Important considerations for assertion macros:
- `__FILE__` and a hardcoded string like `"foo.c"` are NOT merged by the compiler - treated as different
- `__FILE__` can affect ordering of string literals
- For scratches, check what `__FILE__` evaluates to in the context (e.g., `ctx.c`)
- Using `__FILE__` in HSD code serves as a sanity check for file structure

### Assertion Filename Format (rtburns, 2023-06-03)
Assertion filenames must match exactly:
- Wrong: `__assert("src/sysdolphin/baselib/jobj.h", ...)`
- Right: `__assert("jobj.h", ...)`

### Sorting ASM Files for Productivity (rtburns/ribbanya, 2023-06-30)
Sort item asm files by line count (or byte count) and start with smallest:
- Learn patterns on simpler functions first
- By the time you reach larger files, patterns are familiar

### Build Environment Notes (various, 2023-06-27)
- Running make with sudo causes more problems than it fixes
- If builds fail, try `rm -rf build/` and rebuild fresh
- Docker works when native build has issues
- WSL can have very slow startup times (5 minutes before compiling starts)

### GitHub Actions and Docker Images (ribbanya/rtburns, 2023-06-14)
Discussion about reproducibility vs. maintainability:
- GHCR images only last 90 days
- Base runner images may not persist long-term
- Manual pinning provides reproducibility but requires maintenance
- Current approach: let images update and recreate based on latest ubuntu/packages

## Pitfalls and Gotchas

### sdata Mismatches (ribbanya, 2023-06-03)
When context assertions have wrong filenames, it can cause sdata ordering issues that look like `-sdata 32` problems but are actually just wrong strings.

### Pointer Arithmetic (kiwidev, 2023-06-22)
`+ 3` becomes `0xc` in assembly when incrementing a pointer to a 4-byte type (pointer arithmetic multiplies by element size).

### Refactoring Impact on Contributors (werewolf.zip, 2023-06-11)
Constant refactors discourage contributors:
> "When my limited time to work on it comes back to 'Ah yes, time to fix everything again' - it makes me less than enthused."

### Linker Address vs Virtual Address Confusion (ribbanya, 2023-06-03)
Map file addresses should match function names if DOL matches. Any discrepancy is usually from reading wrong map file (e.g., `build/wip/.../GALE01.map` vs `expected/.../GALE01.map`).

### Item Struct User Data Access (various, 2023-06-24)
When m2c generates code like:
```c
temp_r4 = arg0->user_data->unkDC9;
```
Don't comment out lines with uninitialized variables - find the correct field in the Item struct (context line 11966 for user_data definition).

## Project Status and Estimates

### Progress as of June 2023
- Code sections: 663,077 / 3,882,272 bytes (17.08%)
- Data sections: 167,049 / 1,223,369 bytes (13.65%)
- 50 trophies collected

### Completion Estimates (various, 2023-06-01)
Discussion about which GC decomp might reach 100% first:
- Pikmin and Melee have good shots
- Ty the Tasmanian Tiger also mentioned (just one contributor: chippy)
- Super Monkey Ball was furthest (>50%) but cam left
- Libraries need to be decompiled for true 100%

At current rate: estimated late 2028 completion (ryankoop, 2023-06-08)
Alternative calc: ~8.66 years at 1 KiB/day (ribbanya, 2023-06-04)

## Naming Conventions

### File Naming Discussion (ribbanya/rtburns, 2023-06-03)
- Two-letter character codes (ft, it, etc.) received mild negative feedback
- Options discussed: `ftGameWatch_SpecialS`, `ftgamewatchspecials`, `ftgamewatch_specials`
- Lowercase with underscores has word boundaries without conflicting with assert filenames
- Internal JP names recommended for code/filenames with English names in comments

### Variable Naming (durgan/ribbanya, 2023-06-04)
- Very short names (2 letters) decrease readability for newcomers
- `fp` = fighter pointer (from asserts), used extensively throughout codebase
- Glossary available: https://doldecomp.github.io/melee/glossary.html
- 80 column limit necessitates some terseness
- `it` for item looks like English pronoun - problematic

## Architecture Notes

### Brawl vs Melee Code Relationship (various, 2023-06-01)
- Brawl was a complete C++ rewrite by Sora Ltd (not HAL)
- No source code shared between Melee and Brawl
- Dat files are basically the same format
- PM used same floats and got same engine results
- Brawl uses Havok only for clothing physics, not core collision/physics

### HAL's Code Architecture (Revo, 2023-06-02)
HAL was inconsistent about inline/function usage for fetching objects between layers:
- `HSD_JObj* jobj1 = gobj->hsd_obj;` - direct access instead of macro in some places
- Different GObj typedefs exist but are for readability/M2C, not different types
- Inline usage changes register allocation, indicating original code may not have used inlines in all places
