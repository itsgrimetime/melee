# Decompilation Knowledge: 2022-04

This month saw significant progress including reaching 5% code decompilation, the completion of `fighter.c`, and major work on MasterHand. Key discoveries include the fighter special attributes union structure and critical frank.py fixes.

## Compiler Patterns

### Integer Type Codegen Differences
- There's an edge case where `long` vs `s32` (or `u32`) produces different codegen despite being equivalent types.
- LibOGC type definitions may differ from the Dolphin SDK; pay attention to types marked as `u32`, `s32` vs `enum` or `typedef'd` types.
- Source: werewolf.zip, revosucks (2022-04-01)

### Inline Auto Behavior
- Changing global inlining settings causes non-matches across the project.
- Use `#pragma always_inline on` inside a `push/pop` to force inlining without affecting the entire compilation unit.
- decomp.me doesn't compile the same way as full compilation - things in separate compilation units may inline with `-auto` but not if in the same file.
- Source: werewolf.zip (2022-04-04)

### The FTP Patch Mystery
- The original compiler is believed to be MWCC 1.2.5 + a missing FTP (file transfer protocol) patch from Metrowerks.
- The patch notes said: "The scheduler may, with certain instruction patterns, decide to move code below the de-allocation of the current stack frame."
- This patch has not been archived or leaked. Metrowerks employees contacted don't have backups.
- The frank.py workaround merges vanilla (1.2.5) and profiler (1.2.5e) compiler outputs to approximate the original.
- Source: altafen, revosucks (2022-04-25)

### Inline Deferred vs Inline Auto
- Inline deferred reverses function order in the output - functions are processed then written in reverse order.
- This affects link order and requires reordering functions if used project-wide.
- Testing suggests Melee does NOT use `-inline deferred`, it likely uses `-inline auto`.
- The workaround for specific inlining issues is `#pragma auto_inline off` around specific functions.
- Source: antidote6212, snuffysasa, epochflame (2022-04-20)

### sqrtf Mangling with C++
- `sqrtf` appears as `sqrtf__Ff` (C++ mangled) in some assembly.
- This is because `math_ppc.h` uses `#pragma cplusplus on`, causing name mangling.
- The function itself is an external inline in the PPC EABI headers.
- Source: revosucks, epochflame (2022-04-24)

### Volatile Trick for Stack Variables
- Using `volatile` forces variables onto the stack, which can fix certain matching issues.
- However, it shifts register allocation by one.
- Source: rtburns, snuffysasa (2022-04-12)

### Volatile to Prevent Inlining
- Declaring any variable in a function as `volatile` makes the function impossible to inline due to context (in most cases).
- Edge cases exist where the compiler will inline anyway.
- Source: antidote6212 (2022-04-20)

## Matching Techniques

### Chain Assignments Fix Register Order
- Chain assignments like `a = b = c = d = 1;` produce different codegen than separate assignments.
- This can fix `lwz` instruction positioning issues.
- The nested structure `a = (b = (c = (d = 1)));` makes the code generator do different things.
- Source: snuffysasa, revosucks (2022-04-15)

```c
// This produces different asm than separate assignments:
fighter->x2340 = fighter->x2344 = fighter->x2348 = fighter->x234C = 0;
```

### Ternary for bne/b Pattern
- A `bne` immediately followed by `b` suggests a ternary expression or specific inline pattern.
- Source: epochflame, snuffysasa (2022-04-12)

```c
// Creates bne/b pattern:
inline f32 get_value(s32 condition) {
    return condition ? value1 : value2;
}
```

### cntlzw Pattern (Count Leading Zeros)
- The `cntlzw` instruction appears in `== 0` comparisons without branches.
- Pattern: if value is zero, `cntlzw` returns 32; shifting right by 5 gives 1.
- Use `bool result = (thing == 0);` to generate this pattern.
- Source: ninji, epochflame (2022-04-18)

```c
// This generates cntlzw:
bool is_zero = (some_value == 0);
```

### beqlr and bnelr
- These are "branch if equal/not-equal to link register" - conditional early returns.
- Equivalent to `if (condition) return;` with the return jumping to lr.
- Source: revosucks, antidote6212 (2022-04-15)

### Struct Copy vs Element Copy
- `lwz/stw` instructions on Vecs usually means struct copy, not individual element access.
- Copy entire Vec as struct: `dest_vec = src_vec;` instead of `dest_vec.x = src_vec.x;` etc.
- Source: rtburns (2022-04-12)

### Assignment in if Statement
- `if (ptr = some_func())` is valid C that both assigns and checks.
- Parentheses tell the compiler "I know what I'm doing" and suppress warnings.
- This pattern generates different code than separate assignment + check.
- Source: antidote6212, camthesaxman (2022-04-18)

### Float/Int Conversion Pattern
- `lfd` instructions involving stack and `lbl_804D8278` (or similar) are float/int conversions.
- `xoris` indicates signed (s32) to float conversion.
- Unsigned (u32) to float is the same but without xoris (and different magic constant).
- Source: rtburns, altafen, moester_ (2022-04-12)

### Regalloc Fix: GObj->hsd_obj Inline
- If having regalloc trouble with `jobj = gobj->hsd_obj`, try using an inline getter:
```c
inline HSD_JObj* get_jobj(HSD_GObj* gobj) {
    return gobj->hsd_obj;
}
```
- This fixed multiple trouble functions.
- Source: altafen (2022-04-24)

### fabsf (Float Absolute Value)
- Use the `__fabs` intrinsic for float absolute value, not the `fabs` function call.
- `fabs()` will generate a `bl fabs` call; the intrinsic generates inline code.
- Source: epochflame, revosucks (2022-04-16)

### Inline Asm with @sda21
- For inline asm, you don't need `@sda21(r2)` - that's only for standalone assembly.
- Remember to `#pragma peephole on` after inline asm blocks.
- Source: seekyct, altafen (2022-04-15)

## Type Information

### Fighter Struct - Special Attributes Union
- The Fighter struct contains a union for character-specific data starting at offset 0x222C.
- Union ends around 0x2340, with common state variables after.
- Named `sa` (special attributes), accessed as `ft->sa.mario.x222C`.
- Source: werewolf.zip, revosucks, rtburns (2022-04-02)

```c
union {
    struct SpecialAttrs_Mario mario;
    struct SpecialAttrs_Fox fox;
    // ... one struct per fighter kind
} sa;
/* 0x2340 */ u32 x2340_stateVar1;  // Common vars after union
```

### Fighter Special Attributes Range
- 0x222C to 0x2340 is the union range
- 0x2420 is "Start of Per Character Article Floating Points"
- Clone characters reuse base character's attr struct (DrMario uses Mario's, Falco uses Fox's, etc.)
- Source: werewolf.zip, revosucks (2022-04-02)

### Stage Map Struct Union
- Stage Map (gp) struct contains a union named `u` with stage-specific data.
- Discovered via assertions: `gp->u.map.parts`, `gp->u.taru.keep`, `gp->u.car.car_info`, etc.
- Source: rtburns (2022-04-02)

### HSD_ObjAllocData Size
- Size is 0x2C bytes
- Defined in .bss section with `.skip 0x2C`
- Source: snuffysasa (2022-04-20)

### FtState (Action State) Structure
```c
struct FtState {
    int action_id;
    int flags;
    char move_id;
    char bitflags1;
    void *animation_callback;
    void *iasa_callback;
    void *physics_callback;
    void *collision_callback;
    void *camera_callback;
};
```
- There are 320+ common states, character-specific states start at 0x140.
- Source: werewolf.zip (2022-04-23)

### Controller nml_ Fields
- `nml_` prefix means "normalized" - values scaled to 0.0-1.0 range.
- Raw pad values are s8, then divided by scale factors (stick: 80, analogLR: 140).
- Source: werewolf.zip (2022-04-23)

### Bitfield on Half (lhz)
- Can use bitfields on 16-bit values loaded with `lhz`.
- Example struct with union for different access patterns:
```c
union {
    struct {
        UnkFlagStruct x594_animCurrFlags1;
        struct {
            u8 x0: 7;
            u16 x7: 3;
        } x596_bits;
    };
    s32 x594_s32;
};
```
- Source: snuffysasa (2022-04-12)

## Function-Specific Insights

### Fighter_ActionStateChange (func_800693AC)
- Critical function called from "literally everywhere"
- Named ActionStateChange based on UnclePunch map
- Nearly 1000 lines of assembly, matched through extensive work
- Source: snuffysasa, altafen (2022-04-12)

### func_8006DABC - File Boundary Issue
- This function appears at the end of fighter.c but may belong to a different TU.
- Takes `Fighter*` as argument while other fighter.c functions take `HSD_GObj*`.
- Moved to ftanim.s as workaround until proper matching solution found.
- Source: snuffysasa, epochflame (2022-04-22)

### Trophy Award Function
- Located at 0x801BFA08 in melee/text_2.s
- Takes trophy ID as argument.
- Source: epochflame (2022-04-12)

## Tool Tips

### decomp.me Context Issues
- Adding full function definitions to context causes them to be auto-inlined (treated as header includes).
- Use `-ffile-prefix-map=src/sysdolphin/baselib/=` when preprocessing to fix `__FILE__` paths.
- Strings in `.data` vs `.sdata` is determined by string size.
- Source: epochflame, rtburns (2022-04-12, 2022-04-20)

### Creating Context with MWCC Directly
```bash
tools/mwcc_compiler/1.2.5e/mwcceppc.exe -EP -Cpp_exceptions off -proc gekko -fp hard -fp_contract on -O4,p -enum int -nodefaults -inline auto -I- -i include -i include/dolphin/ -i include/dolphin/mtx/ -i src -E src/file.h > context.txt
```
- Source: altafen (2022-04-15)

### Using -S Flag
- Compile with `-S` to output assembly (.s) files instead of objects (.o).
- Useful for verification without needing frank.py.
- Source: epochflame (2022-04-12)

### Frank.py Operation Summary
1. Vanilla epilogue scheduling is wrong; use profiler code as base
2. Profiler header asks for `_PROFILE_EXIT`; use header from vanilla
3. Delete all "bl 1; nop" sequences
4. Replace `b 0xXXXX` with `blr` where vanilla has `blr`
5. Fix `mtlr` position relative to epilogue
6. Apply instruction reordering fixes for specific patterns
- Source: altafen (2022-04-25)

### Frank.py Patches (April 2022)
- rtburns' patch: Handle `lwz; li/lfs` and `lwz; lmw` patterns with `bl; nop` in profile
- altafen's patch: Handle `lmw; lwz` in profile vs `lwz; lmw` in vanilla (epilogue specific)
- Patches target only instructions immediately before `addi r1,r1,X; mtlr r0; blr`
- Source: altafen (2022-04-25)

### Makefile Override for Frank
```makefile
$(BUILD_DIR)/src/melee/ft/fighter.c.o: CC_EPI := $(CC)
```
- This uses vanilla (1.2.5) for both compilers, essentially just doing postprocessing.
- Needed when frank's merging produces incorrect results for specific files.
- Source: snuffysasa (2022-04-21)

### Wine Issues on WSL
- Wine 5 may have stack overflow issues with MWCC compilers.
- Wine 3.0 confirmed working.
- Direct Windows compilation via MSYS2 may be easier than WSL -> Wine -> Windows.
- Source: snuffysasa, squatchthegiant (2022-04-27)

## Pitfalls and Gotchas

### Assert Line Numbers with Inlines
- Inline functions from headers have fixed line numbers in their asserts.
- However, asserts can be optimized out if the value is known at compile time.
- Stack addresses are known non-null, so asserts on them are removed.
- Function call results are not known, so asserts on them remain.
- Source: rtburns, antidote6212 (2022-04-11)

### Data Section Alignment (.balign)
- Missing `.balign` directives when moving data to C can cause offset mismatches.
- Check symbol map carefully when data offsets are wrong.
- An extra space in a string can cause 4-byte alignment shift.
- Source: snuffysasa (2022-04-20)

### Strings in .data vs .sdata
- Small strings go to `.sdata`, larger strings to `.data`.
- Inline functions with string literals (like assert filenames) put their strings in the compilation unit's data section, not in the header file's section.
- Source: epochflame, snuffysasa (2022-04-21)

### Clone Fighters Share Attr Structs
- Dr. Mario uses Mario's special attributes struct.
- Falco uses Fox's, Ganondorf uses Falcon's, Young Link uses Link's, Roy uses Marth's.
- Pichu uses Pikachu's, GigaBowser uses Bowser's.
- Source: rtburns, revosucks (2022-04-02)

### Japanese Internal Names
- Use internal/JP names for structs: Koopa (Bowser), Purin (Jigglypuff), Mars (Marth), Emblem (Roy), CLink (Young Link), GKoopa (Giga Bowser).
- Source: werewolf.zip (2022-04-02)

### External Array Loading Issues
- Some external array access patterns don't match on decomp.me but do locally (or vice versa).
- May be related to static initialization or data pooling differences.
- Source: snuffysasa, revosucks, kiwidev (2022-04-20)

### Permuter Limitations for PPC
- No C++ support (templates are computationally undecidable)
- No PPC support currently
- MWCC via Wine is slow compared to native recompiled IDO/agbcc
- Source: revosucks (2022-04-22)

## Project Milestones

### Progress: 5.07% Code (April 25, 2022)
```
Code sections: 196852 / 3882272 bytes in src (5.070536%)
Data sections: 35677 / 1211849 bytes in src (2.944014%)
15 of 290 Trophies, 1 of 51 Event Matches
```

### Key Files Completed This Month
- fighter.c - Major completion by snuffysasa
- ftMasterHand - Completed by altafen
- ftcommon - Major progress by rtburns

### Community Notes
- UnclePunch map: https://github.com/UnclePunch/Training-Mode/blob/master/GTME01.map
- Akaneia/m-ex fighter structs: https://github.com/akaneia/m-ex/blob/master/MexTK/include/fighter.h
- Missing FTP patch archive link: https://web.archive.org/web/20011121032509/http://www.metrowerks.com:80/games/gamecube/update/
