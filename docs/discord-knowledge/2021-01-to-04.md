# Decompilation Knowledge: January-April 2021

## Compiler Investigation

### The 2.2.x Compiler Hunt

This period was dominated by the search for the correct MWCC 2.2.x compiler needed to match Melee's assembly output.

**Key findings:**
- Melee uses a pre-release MWCC 2.2.x compiler, not the publicly available 2.3.3 versions
- The compiler produces scheduling differences in epilogues compared to 2.3.3
- HAL Laboratory likely grabbed an early "release 4" (circa 1998-1999) of the embedded PowerPC compiler before GameCube toolchains were finalized
- Source: revosucks (2021-01-30, 2021-02-01)

**Compiler versions tested:**
```
Version 2.3.3 build 159 (GC CW 1.1) [Runtime Built: Feb 7 2001 12:08:38]
Version 2.3.3 build 144 (GC CW 1.0) [Runtime Built: Apr 13 2000 14:30:41]
```
Neither matched, but 1.0 has the "fixed epilogue scheduling" per release notes.
- Source: werewolf.zip (2021-01-31)

**Search progress (as of 2021-02-11):**
- Mac PPC 2.2 discovered to have strong codegen body similarity (differences only in prologue/epilogue EABI)
- Bob Campbell (Metrowerks) contacted
- Official NXP support ticket opened
- Multiple routes to a working 2.2 compiler identified
- Source: revosucks (2021-02-11)

### Paired Singles Instructions (psq)

**Key insight:** Paired singles instructions (`psq_l`, `psq_st`, etc.) in Melee appear ONLY in:
1. Prologue/epilogue code
2. Inline ASM
3. SDK library code

The `-proc gekko` flag enables these instructions for mass float operations and optimization, but they are NOT generated in normal function bodies by MWCC.
- Source: gibhaltmannkill (2021-01-31), revosucks (2021-01-30)

**Implication:** If a pre-GameCube embedded PPC compiler is found, the lack of `psq` support can be worked around since these instructions are limited to specific contexts.

## Type Information

### GObj Structure

GObj is a core HAL engine object used across multiple games. Key information:

**Cross-game lineage:**
- Same basic structure appears in Smash 64, Kirby 64, Pokemon Stadium 64, Kirby Air Ride, and Melee
- Part of HAL's "sysdolphin" library (NOT the Nintendo Dolphin SDK)
- Source: unclepunch, someone2639, revosucks (2021-01-20, 2021-03-23)

**GObj fields discovered through cross-game comparison:**
- Melee has a `gx_link` field
- N64 equivalent uses a `dl_link` field (display list link)
- Source: someone2639 (2021-03-25)

**Reference:** Melee GObj header at `src/sysdolphin/gobj.h`

### Shared Code Between Kirby 64 and Melee

- Melee uses the **exact same hard RNG algorithm** as N64 HAL games (Kirby 64, etc.)
- Engine code reuse goes beyond just RNG - significant structural similarities
- Assets were also reused between games
- Source: someone2639, dansalvato (2021-03-18, 2021-03-23)

**Reference:** Kirby 64 RNG implementation: `https://github.com/farisawan-2000/kirby64/blob/master/src/ovl0/ovl0_4.c#L5334`

## Matching Challenges

### Known Difficult Areas

**GObj functions:**
- Even "easy" GObj functions are hard to match
- Likely due to either:
  1. Not having the correct 2.2.x compiler
  2. MWCC being sensitive to minor source changes
  3. Both factors combined
- Source: werewolf.zip, revosucks (2021-01-18)

**Float register allocation (lbvector):**
- Some float-heavy functions have register allocation issues
- GC CW 1.0 was hoped to have more favorable regalloc
- Can potentially be worked around with patches
- Source: revosucks (2021-01-31)

## Tool Information

### Debug Visualizer

A hitbox visualizer tool exists for Melee debugging/analysis.
- Source: theo3, camthesaxman (2021-04-05, 2021-04-06)

## Project Context

### HAL's Development Timeline

- Melee development: ~13 months from November 2001
- HAL used MWCC 2.2.x despite 2.3.3 being available
- Theory: HAL grabbed an early compiler (release 4, ~1998) at project start and never upgraded
- Melee may have been used to help Nintendo test GameCube HW1/HW2 hardware
- Source: revosucks, gamemasterplc (2021-02-01)

### SysDolphin History

- Melee was likely the first game to use the "sysdolphin" library
- The library represents essentially the entirety of HAL's GC engine framework
- Source: unclepunch (2021-01-20)
