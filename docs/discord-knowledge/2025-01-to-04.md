# Decompilation Knowledge: January-April 2025

## Compiler Patterns

### Small Data Area (SDA) for Constants
- The PowerPC compiler places small read-only constants (floats, doubles, strings) in `.rodata` sections
- These are loaded via SDA-relative addressing (`@sda21(0)` notation) for single-instruction loads
- Contrast with absolute addressing which requires two instructions (hi/lo parts)
- Constants are placed in top-down file order as the compiler reads them
- Source: revosucks, rtburns, savestate (2025-04-29)

### 64-bit Stores
- 64-bit writes (like `u64 gxlink_prios` in `HSD_GObj`) generate two 32-bit stores
- Example: writing 9 to offset 0x24 and 0 to offset 0x20 is a single 64-bit write
- Source: gamemasterplc, werewolf.zip (2025-03-16)

### Casting and User Data Access
- Casting when passing to `HSD_GObjGetUserData` affects stack/codegen
- `(Fighter*)HSD_GObjGetUserData(gobj)` - correct
- `(Fighter*)HSD_GObjGetUserData((cast here)gobj)` - incorrect, causes stack issues
- The GET_FIGHTER macro shouldn't have a cast on the input, only on the return
- Source: revosucks (2025-04-29)

## Matching Techniques

### Union Member Selection
- M2C cannot determine which union member to use - it picks the first that works
- For `fp->mv` (motion vars), M2C picks `ca` (Captain Falcon) because it's alphabetically first
- You must determine the correct union member from context (e.g., if using `ftCo_MS_KneeBend`, use `mv.co`)
- Source: ribbanya, savestate (2025-04-29)

### Stack Padding Tricks
- When stack doesn't match, `PAD_STACK` macro marks it as a known fake
- Alternative: Use `UNUSED` local variables to pad stack
- These are grep-able later for correction
- Source: ribbanya (2025-04-29)

### Variable Scope for Finding Inlines
- Moving variable declarations to limited scope helps identify inline functions
- Use scope braces to push declarations down:
```c
{
    Fighter* fp;
    // ...
}
```
- Source: ribbanya (2025-04-30)

### Literal vs External Constants
- `extern const f32` labels can often be replaced with literal values
- The compiler automatically places literals in `.rodata`
- Order matters - constants must be declared where originally located
- Source: revosucks (2025-04-29)

### Assignment Inside Conditionals
- Assignments inside if conditions are "definitely fake" - rarely needed
- Source: ribbanya (2025-04-30)

## Type Information

### Controller Button Bits (HSD_PadStatus)
- Button bit definitions available in `src/common_structs.h` lines 24-45
- Source: ribbanya (2025-04-07)

### Fighter Motion Vars Union
- `fp->mv` is a union containing per-character motion state variables
- Members include `mv.co` (common), `mv.ca` (Captain), etc.
- KneeBend motion state uses `ftCommon_MotionVars` shared by all characters
- Source: rtburns, ribbanya, savestate (2025-04-29)

### Jump Check Thresholds (from PlCo.dat)
- Tap jump Y-stick threshold: 0.6625
- Tap jump tilt timer: 4 frames
- If you've been in tilt zone longer than threshold frames, tap jump won't trigger
- Source: savestate (2025-04-29)

### RGB5A3 Pixel Format
- Screenshot code converts RGB565 to RGB5A3
- `(r25 >> 1) & 0x7FE0` removes extra green channel bit
- `r25 & 0x1F` preserves lost blue channel bit
- `0x8000` OR makes fully opaque RGB5A3 color
- Source: .cuyler, altafen (2025-04-21)

### Fighter_GObj Type
- `Fighter_GObj` is NOT a distinct struct - it's just `HSD_GObj`
- The typedef exists only to help M2C and provide self-documentation
- Under `M2CTX` guard, it's a fake struct; otherwise `typedef struct HSD_GObj Fighter_GObj`
- The game passes `HSD_GObj` around and casts `user_data` as needed
- Source: revosucks, rtburns, ribbanya (2025-04-29)

## Function-Specific Insights

### vi/ Directory (Video/Cutscenes)
- Contains Adventure Mode cutscenes (in-game, not pre-rendered)
- NOT the pre-title screen CG movie
- Numbers correspond to Adventure mode stage numbers
- Contains setup for GObjs: characters, cameras, etc.
- Character IDs reveal which cutscene (e.g., Luigi/Mario/Peach = Peach's Castle footstool)
- Source: werewolf.zip, revosucks (2025-03-16)

### gr/ vs st/ Naming
- Project uses `gr` prefix for stages (from "ground", "groundparam")
- `st` (stage) is colloquial but not used in codebase
- Naming based on file prefixes and assert strings
- Source: werewolf.zip (2025-02-26)

### Screenshot GCI Files
- Screenshot files are variably sized - extremely rare for GCI files
- Only PSO quest files share this characteristic
- Source: __louis (2025-01-23)

### Slippi/Rollback Architecture
- Slippi uses fake EXI device for Dolphin-to-memory communication
- Records large memory regions since they don't know all region purposes
- Ideal rollback only records necessary state
- Melee has built-in animation interpolation to higher frame rates
- Faster Melee changed frame timing + CPU speed
- Source: werewolf.zip (2025-01-02)

## Tool Tips

### Context Generation
- Use https://doldecomp.github.io/melee/ctx.html for up-to-date context
- Old contexts cause matching issues (wrong types/functions)
- Source: werewolf.zip, cortex420 (2025-03-24)

### objdiff Padding Issues
- Trailing zeros in objdiff are usually just padding
- Fix by trimming data object sizes in `config/GALE01/splits.txt` and `symbols.txt`
- Example: change `size:0x18` to `size:0x12` if extra bytes are padding
- Source: altafen, gamemasterplc (2025-03-13)

### Linking Decompiled Files
- Run `tools/link.py src/melee/path/to/file.c` to make build system use C file
- This also toggles the green filename indicator in objdiff
- Source: altafen (2025-03-13)

### decompctx.py Issues
- Only understands `-I` includes, not `-i` (or vice versa)
- Can cause "file cannot be opened" errors
- Source: encounter, max_pwr (2025-02-05)

### PR Workflow
- Can contribute by opening issue with matching decomp.me scratch
- Or build locally and open PR
- Functions need to go in same order as original for linking
- Source: rtburns (2025-04-29)

## Pitfalls and Gotchas

### Struct Field Order in Unions
- Getting x/y order wrong in vector structs is common mistake
- "maybe this is a dev that likes to do y then x"
- Source: revosucks (2025-04-29)

### Decompiled Code Order
- Constants and functions must be in original order
- "the code sandwich has gotta be in the same order or its not the same sandwich"
- Working at file level is standard practice
- Source: revosucks (2025-04-29)

### cror Instructions in Decompiler
- `M2C_ERROR(/* unknown instruction: cror eq, gt, eq */)` indicates compound comparison
- Delete the error and replace nearby `==` with `>=`
- Source: ribbanya (2025-04-29)

### AI/LLM for Decomp
- ChatGPT trained on existing decomp code, recognizes struct names
- Can get ~90% matches but often uses hardcoded offsets instead of proper types
- Missing context is major limitation
- Still needs human "piloting" to provide relevant context
- Gemini's 2M token context could fit entire context file
- Source: tsanummy, werewolf.zip, altafen (2025-02-13)

### GX Macros
- GX macros are actually inline functions, not preprocessor macros
- Source: gamemasterplc (2025-02-15)

## Historical Notes

### Compiler Recovery
- Melee used CodeWarrior 1.2.5 with a Metrowerks hotfix for scheduler bug with epilogues
- Fix discovered via Wayback Machine documentation
- Ninji applied the fix to binary - marked one instruction as "volatile" in scheduler
- Before fix, Python script achieved ~95% same results
- Source: revosucks, cortex420 (2025-04-29)

### Akaneia Stage
- Confirmed no Gr file exists for it
- Stage code has most asserts, all labeled
- No leftover hazard code found
- Source: werewolf.zip (2025-02-22)

## Community Notes

### Learning Decomp
- No strict prerequisites - determination most important factor
- Pattern recognition more valuable than formal CS background
- M2C/decomp.me dramatically lowers barrier to entry
- Simple functions in `it/items` are good starting points
- Multiple contributors started with zero programming experience
- Source: ribbanya, werewolf.zip, encounter, vimescarrot (2025-01-29-30)

### Recommended Learning Projects
- CHIP-8 emulator (simple, teaches CPU instruction basics)
- Flappy Bird clone
- Simple game with raylib
- "Ray Tracing in One Weekend" tutorial
- Source: encounter, mrkol, robojumper (2025-01-30)

### Decomp Guide
- Available at https://wiki.decomp.dev/en/resources/decomp-intro
- Melee-specific intro at https://wiki.decomp.dev/en/resources/decomp-intro-melee
- Source: foxcam (2025-04-30)
