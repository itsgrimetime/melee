# Decompilation Knowledge: December 2021

This was a foundational month for the Melee decompilation project with approximately 6,700 messages. The project was at its early stages (around 0.7% code progress by month end), and contributors were establishing workflows, tooling, and discovering key patterns.

## Compiler Patterns

### Compiler Version Selection
- **SDK/MSL libraries use plain 1.2.5**, not the 1.2.5e patch ("frank")
- **Game code uses 1.2.5e** for proper epilogue scheduling
- If you see `addi` between `mtlr` and `blr`, the function is using older 1.2.5 codegen and frank will NOT help
- Source: epochflame (2021-12-16)

```c
// For SDK/MSL functions, do NOT add to e_files.mk
// These use plain 1.2.5 compiler
```

### Epilogue Behavior
- Frank (1.2.5e) fixes game codegen by reordering epilogues to put `mtlr` beside `blr`
- Pre-compiled libraries in SDK/MSL have different codegen patterns
- If you see epilogue differences, check which compiler version the function should use
- Source: epochflame (2021-12-16)

### Variable Declaration Scope
- mwcc requires variable declarations at the start of blocks (pre-C99 behavior)
- Variables can be declared at the start of ANY block/compound statement, not just function start
- Using internal brackets `{ }` within functions allows declaring variables mid-function

```c
HSD_InitComponent() {
    OSInit();
    {
         HSD_VIStatus vi_status;  // Valid - at start of block
         GXColor black = { 0, 0, 0, 0 };
        ...
    }
    ...
}
```
- Source: werewolf.zip (2021-12-15)

### Variable Declaration Location Affects Regalloc
- The location of variable declarations affects register allocation
- Moving declarations can cause register swaps
- Keep variables in same order and scope as original when trying to match
- Source: seekyct (2021-12-14)

### Float/Integer Constant Generation
- Int-to-float constants only get generated once per file
- This means splitting files incorrectly can cause data mismatches
- Source: epochflame (2021-12-16)

### Extern vs File-Local Data
- Extern vs file-local matters for matching in some cases
- Using extern can cause different register allocation than file-local
- Some functions cannot match if you extern the data
- Source: camthesaxman (2021-12-13)

### Section Offset Trick
- The compiler loads file-scope variables using an offset from the start of the section
- If you see code loading `var1` then adding 0x80 to get `var3`, it indicates:
  - `var1` is the start of data in that file
  - `var1` and `var3` belong in the same file
- Source: camthesaxman (2021-12-14)

```asm
# Example: var1, var2, var3 are consecutive
# Code loads &var1 and adds 0x80 to get &var3
# This reveals file boundaries
```

### C99 Support
- Older mwcc compilers don't support `-lang c99`
- Use `#pragma c9x on` instead for limited C99 features
- `-lang c99` was added after CW 1.3+
- Source: revosucks (2021-12-14)

## Matching Techniques

### Inline Function Matching
- Duplicated code pieces that cause codegen problems should be tried as inlines
- Source: revosucks (2021-12-13)

### Loop Detection
- The `bdnz` instruction indicates a counted loop
- Source: epochflame (2021-12-14)

### Float Bit Manipulation Pattern
- Storing a float to stack, then loading as both u32 and float indicates either:
  - Pointer cast: `*(int *)&floatVar`
  - Union type punning

```c
// Pattern seen in MSL math functions:
// stfs f1, 8(r1)   - store float
// lwz  r0, 8(r1)   - load as int (bit manipulation)
// lfs  f6, 8(r1)   - load as float again
```
- The `lwz` loading a stored float is intentional for bit manipulation (like 1.0f -> 0x3f800000)
- Source: seekyct (2021-12-16)

### __HI and __LO Macros
- Sun Microsystems fdlibm uses macros that can appear on the left side of assignment:
```c
#define __HI(x) *(1+(int*)&x)
#define __LO(x) *(int*)&x

// Usage:
__HI(x) = hx;  // Expands to: *(1+(int*)&x) = hx;
```
- Source: fluentcoding (2021-12-15)

### Unused Arguments
- Some functions compile with matching even without the unused parameter
- If m2c shows a parameter that isn't used, try removing it
- Source: chrisnonyminus (2021-12-12)

### Implicit Parameter Passing
- The compiler often doesn't set up parameters if they're already in place
- Example: if r3 already contains the right value from a previous operation, the compiler won't explicitly set it again before a function call
- Source: seekyct (2021-12-12)

### Float Parameters Start from f1
- Float parameters use f1, f2, etc. - NOT f0
- f0 is not used for parameter passing
- Source: seekyct (2021-12-30)

## Type Information

### Fighter Struct
- Size: 0x23EC bytes
- Key offsets:
  - 0x10C: ftData
  - 0x2D4: Second pointer to special attributes (may involve union)
  - First argument (r3) in ft functions is always `GObj*`
  - Access pattern: `gobj->2C` gets fighter data
- Don't name padding fields "padding" - use offset names like `unk2D8`
- Source: werewolf.zip (2021-12-12)

```c
struct Fighter {
    u8 unk0[0x10C];
    void* ftData;           // 0x10C
    u8 unk110[0x1C4];
    void* x2D4;             // 0x2D4 - special attributes ptr (union involved)
    // ... more fields up to 0x23EC
};
```

### HSD_GObj
- This is the standard game object type
- Fighter functions receive `HSD_GObj*` as first parameter
- Access fighter data via `gobj->data` cast
- Source: werewolf.zip (2021-12-12)

### Fighter Files Structure
- Each `ft[Character]` file is actually 4+ files (one per special move)
- Pattern: `ftNessSpecialN`, `ftNessSpecialS`, etc.
- Only special moves are separate - common moves are shared
- ftKirby needs a subdirectory for all the hats
- Source: werewolf.zip (2021-12-12)

### Hitbox Structure (m-ex reference)
- Community documentation in m-ex project has hitbox structures
- Source: werewolf.zip (2021-12-13)

## Function-Specific Insights

### OSReport
- Signature: `void OSReport(const char *, ...)`
- Variadic function - must declare with `...`
- Source: progenitor9339, seekyct (2021-12-14)

### fabs
- Inline function calling intrinsic: `inline double fabs(double x) { return __fabs(x); }`
- Some functions that just call fabs may be failed inline attempts
- Source: camthesaxman (2021-12-15)

### frexp (MSL)
- Sun Microsystems open source implementation matches
- Uses `__HI` and `__LO` macros for bit manipulation
- Source: fluentcoding (2021-12-16)

### trigf.s (MSL)
- Contains: tanf, cosf, sinf
- Same structure between Pikmin 1 and Melee
- tanf = sin/cos pattern
- Source: epochflame (2021-12-16)

### k_cos (MSL)
- Particularly difficult to match
- Source: epochflame (2021-12-15)

### HSD_Archive Functions
- Handle file loading and pointer setup
- K7 debug info available for reference
- Source: werewolf.zip (2021-12-13)

### lbarchive
- Handles returning file data to game and heap management
- Separate from HSD_Archive
- Source: werewolf.zip (2021-12-12)

### Stage Functions
- Naming convention uses `st` prefix
- Example: `stGetPlayerDeadUp()` calculates blast zones
- Some official function names don't match Sysdolphin convention (`HSD_ObjDoThings`)
- Source: werewolf.zip (2021-12-13)

### Test Stage Debug Code
- Has controller input that controls platform existence
- Runs in production builds
- Kraid stage has P2 debug triggers for effects
- Corneria has Smash Taunt dialogue testing
- Source: werewolf.zip (2021-12-21)

## Tool Tips

### decomp.me Usage
- Works with one function at a time
- Copy ASM from melee repo, not Ghidra (Ghidra output won't assemble correctly)
- When extern data shows as `(0)` instead of `(r2)`, that's expected - linker resolves it
- Source: camthesaxman (2021-12-14)

### Context in decomp.me
- Copy header contents and paste into context field
- For math functions, add fabs inline if not present:
```c
inline double fabs(double x) { return __fabs(x); }
```
- Source: camthesaxman (2021-12-15)

### Ghidra Tips
- Highlighting ASM in Ghidra highlights corresponding decompiled code
- Works both ways - highlight decomp to see corresponding ASM
- `undefined4` means 4-byte value of unknown type (could be int, pointer, etc.)
- DON'T trust Ghidra as gospel - use it as a starting point only
- Source: epochflame, revosucks (2021-12-14, 2021-12-19)

### Manual Compilation
- When manually compiling with mwcc, include paths matter:
```bash
mwcceppc.exe -S -Cpp_exceptions off -proc gekko -fp hard -O4,p -enum int -nodefaults \
    -i src/melee/pl -I- -i include -i include/dolphin -i include/dolphin/mtx -i src \
    src/file.c
```
- If linker errors about `mwldnr2` occur, the linker executable needs to be findable
- Use `-S` for assembly output, `-c` for object files
- Source: kiwidev, epochflame (2021-12-12)

### Build System
- Use `make -j` for parallel compilation (significant speedup)
- `make clean` needed when switching commits to ensure header changes rebuild
- Linkage is single-threaded regardless of `-j` flag
- Source: epochflame (2021-12-13)

### Cross-Referencing Pikmin
- Pikmin 1 and 2 share MSL/SDK code with Melee
- Pikmin has a symbol map - use it to identify/label shared functions
- Same function in Pikmin can be used as reference for Melee
- Some minor variations exist between games
- Source: epochflame (2021-12-16)

### fdlibm (Sun Microsystems)
- Math library functions are open source: https://www.netlib.org/fdlibm/
- Many match directly or with minor modifications
- Preserve the Sun Microsystems copyright notice
- Source: epochflame (2021-12-14)

## Pitfalls and Gotchas

### Data Splitting is Critical
- Using extern for everything is "cringe and nonmatching"
- vtables cannot be extern'd - must be split first
- Split data BEFORE decompiling, not after
- Three approaches (in order of quality):
  1. Extern everything (bad - often doesn't match)
  2. Split files as needed (better but annoying)
  3. Split everything in advance (best)
- Source: epochflame (2021-12-14)

### Link Order Matters
- Files must link in correct order for data to match
- `obj_files.mk` controls link order
- Order: data before .c file, data after .c file must be separate

```makefile
# In obj_files.mk:
data_0.s      # Data before thing.c
thing.c       # Your decompiled code
data_1.s      # Data after thing.c
```
- Source: epochflame (2021-12-14)

### Global Labels Required for Cross-File References
- When splitting ASM, functions called from other files need `.global` directive
- Missing `.global` causes link errors
- Source: epochflame, camthesaxman (2021-12-14)

### Inline ASM Limitations
- Remove `@sda21` from inline ASM - use extern for those labels
- `@ha` and `@l` are fine in inline ASM
- Remove `(r2)` from inline ASM
- Better approach: avoid inline ASM entirely
- Source: werewolf.zip (2021-12-14)

### Stack Frame Instructions
- Instructions involving r1 (stack pointer) at function start/end are auto-generated
- `stwu r1, -0x28(r1)` - sets up stack frame
- Focus on the middle of the function, not prologue/epilogue
- Source: epochflame, gibhaltmannkill (2021-12-16)

### Register Conventions
- r1: Stack pointer
- r2: Pointer to .sdata2 section (constants)
- r13: Pointer to .sdata and .sbss sections
- Both r2 and r13 are set at startup and never change
- Source: camthesaxman (2021-12-15)

### Relocation Errors
- Usually mean something isn't in the right section
- Check that data is in correct section (.data, .sdata, .sdata2, .rodata)
- Source: camthesaxman (2021-12-14)

### Non-Matching Macros
- Functions using macros that reference data may be non-matching until data is split
- Example: `Player_CheckSlot` macro - any function using it may need `#ifdef NON_MATCHING`
- Source: tri_wing_ (2021-12-31)

### Trusting Decompiler Output
- Ghidra function names may be `lbl_` instead of `func_` - doesn't mean it's not a function
- Decompiler may show wrong types (undefined4 = unknown 4-byte type)
- Always verify against actual ASM
- Source: camthesaxman (2021-12-14)

## Project Organization

### File Naming Convention
- Unsplit files: `code_[address].s`
- Split files: named by functionality (e.g., `ftNess.s`, `lbfile.s`)
- When a file is fully decompiled, the .s file is deleted
- Non-matching/inlined code stays in .c with ASM in comments
- Source: werewolf.zip (2021-12-12)

### Code vs Data Sections
- .text: Code
- .data: Initialized global data
- .bss: Uninitialized global data
- .sdata/.sbss: Small data (accessed via r13)
- .sdata2: Small read-only data (accessed via r2)
- .rodata: Read-only data
- Source: camthesaxman (2021-12-15)

### Shiftability
- A shiftable repo allows adding/removing code freely - linker relocates everything
- No more hardcoded pointers or freespace concerns
- Enables treating decomp like traditional source code (GitHub collaboration)
- Current shiftable repos: sunshine, pikmin 2, melee
- Source: revosucks, gamemasterplc (2021-12-26)

### Data Shiftability Limitation
- On GameCube, data shiftability only works with fully decompiled files
- Due to section offset trick with 16-bit references
- Source: gamemasterplc, camthesaxman (2021-12-26)

## Historical Context

### Progress at Month End
- Code: ~0.76% (29,588 / 3,882,272 bytes)
- Data: ~0.15% (1,840 / 1,211,849 bytes)
- Total DOL size: ~4MB code
- SDK/TRK/MSL probably account for ~800KB
- Source: werewolf.zip (2021-12-19)

### Key Contributors
- werewolf.zip (psiLupan): Project lead, architecture knowledge, struct information
- revosucks (Revo): Toolchain, build system, pushing for matching decomps
- camthesaxman: Compiler behavior expertise, SMB decomp crossover
- epochflame: Pikmin decomp, Frank epilogue patch, MSL/SDK experience
- kiwidev: HSD/baselib work
- fluentcoding: Progress website, MSL math functions

### Undefined Behavior Discoveries
- Some Melee behaviors may be caused by undefined behavior in the original code
- Example: V-canceling took years to discover
- TExp (TEV wrapper) has documented UB that doesn't affect display
- GXColor Alpha sometimes unset - UB but harmless due to Tev settings
- Similar to SM64 where "firsties" work due to UB (supposed to be 3 frames, is 1)
- Source: werewolf.zip, revosucks (2021-12-26)
