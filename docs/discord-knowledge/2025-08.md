# Decompilation Knowledge: August 2025

This document distills valuable decompilation insights from the #smash-bros-melee Discord channel during August 2025.

## Compiler Patterns

### cmplwi vs cmpwi for Switch Statements

- Switch statements typically use `cmpwi` (signed compare), even on u32 values
- If you see `cmplwi` (unsigned compare), it's likely an optimization of an if-statement, not a switch
- The pattern `addi r0, rX, -N` followed by `cmplwi` is a common mwcc optimization for range checks like `if (n == 6 || n == 7)`
- No sane dev would write `if ((u32)(n - 6) <= 1)` but that's what the optimizer produces
- Source: .cuyler (2025-08-01)

### Int-to-Float Conversion Pattern

The sequence `xoris stw stw lfd` indicates an int-to-float/double conversion:
- The `xoris` flips the sign bit, so the source type could be s32, s16, or s8
- Source: roeming (2025-08-02)

### sqrt Inline Pattern

The following pattern is the `sqrtf` inline using Newton-Raphson iteration:
```c
f1 = __frsqrte(mag_sq);
f0 = f1*f1;
f1 = f3*f1;
f0 = -(mag_sq*f0 - f2);
f1 *= f0;
// ... repeated 2 more times
```
There are approximately 11 different copies of `my_sqrtf` in the codebase due to copy-paste.
- Source: alex_aitch, roeming (2025-08-02)

### MTXDegToRad Macro

The constant `0.017453292f` comes from the macro:
```c
#define MTXDegToRad(a) ((a)*0.017453292f)
```
Found in `mtx.h`. The constant is pre-computed (PI/180) even at O0.
- Source: gamemasterplc (2025-08-09)

### Enum Min Consideration

The project may have been built with `-enum min` instead of `-enum int`:
- This shrinks enums from 4 bytes to 1 byte when possible
- Evidence: Many slot_type or ckind values are passed as u8/s8
- Switching requires padding enums with `PAD = S32_MAX` to maintain size
- ~2883 functions break when switching to `-enum min`
- Source: ribbanya, rtburns (2025-08-30)

### addi/mr Swap Issues

- Passing the result of `GObj_Create` or `LoadJoint` directly into a function instead of creating a temp variable can switch between `addi`/`mr`
- This is a common source of near-matches
- Source: rtburns (2025-08-23)

## Matching Techniques

### GET_FIGHTER Macro Issues

The `GET_FIGHTER` macro causes frequent issues on decomp.me:
```c
#ifdef M2C
struct Fighter_GObj {
  Fighter* user_data;
}
#define GET_FIGHTER(g) ((Fighter*) HSD_GObjGetUserData((HSD_GObj*) g))
#else
typedef HSD_GObj Fighter_GObj;
#define GET_FIGHTER(g) ((Fighter*) HSD_GObjGetUserData(g))
#endif
```
- The extra `(HSD_GObj*)` cast in the decomp.me version can cause codegen differences
- On decomp.me, try removing the cast from context or using `gobj->user_data` directly
- Always prefer objdiff locally as it uses the correct context
- Source: revosucks, altafen (2025-08-02, 2025-08-08)

### Duplicate Condition Check

Sometimes the original developers checked the same condition twice:
```c
if ((fp->x2000_flags & 0x200) != 0) {
    if ((fp->x2000_flags & 0x200) != 0) {
        // code
    }
}
```
This can fix branch ordering issues.
- Source: .cuyler (2025-08-02)

### Stack Space via PAD_STACK

If you're missing stack space but have a match otherwise, use:
```c
PAD_STACK(n)  // where n is number of bytes to reserve
```
Or the older trick: `u8 _[20];`
- Source: werewolf.zip, alex_aitch (2025-08-01)

### Vec3 Initialization Order

When initializing multiple Vec3 variables to zero, the order matters:
```c
Vec3 a, b, c;
c = zero_c;  // Written first
b = zero_b;
a = zero_a;
```
Using `Vec3 a = {0}, b = {0}, c = {0};` writes them in wrong order.
- Source: muff1n1634, altafen (2025-08-20)

### Inline Detection Clues

Signs that code should be inlined:
- Stack space discrepancies
- Register swaps between code sections
- Duplicated code patterns
- Code after `GObj_Create` calls often starts an inline
- Variables in inlined functions tend to have reversed regalloc vs parent function
- Source: ribbanya, rtburns (2025-08-02, 2025-08-04)

### Flexible Inline Patterns

Inlines can be very flexible - the same inline can match different code patterns depending on how it's used. See ftYs_SpecialN.c for examples:
https://decomp.me/scratch/7wQik
- Source: ribbanya (2025-08-18)

### Bitfield Matching

For bitfield struct matching, use rlwinm decoder:
- https://celestialamber.github.io/rlwinm-clrlwi-decoder/
- Also built into objdiff now
- Fix one rlwinm at a time - target `(r4 << 23) & 0xFF00000000` tells you bit positions
- Source: altafen (2025-08-28)

## Type Information

### Fighter Command Union

The `ftCmd` (actually `CommandInfo`) struct uses a hellish union with bitfields:
```c
struct {
    u32 code : 6;
    u32 b : 1;
    s32 i0 : 7;
    s32 i1 : 7;
    s32 f : 11;
} unk30;
```
Used by ftaction and it_2725 modules.
- Source: altafen, ribbanya (2025-08-28)

### ItemStateTable Structure

```c
struct ItemStateTable {
    enum_t anim_id;
    HSD_GObjPredicate animated; // *_Anim suffix
    HSD_GObjEvent physics_updated; // *_Phys suffix
    HSD_GObjPredicate collided; // *_Coll suffix
};
```
Naming convention: `itFoo_StateN_(Anim|Phys|Coll)`
- Source: ribbanya (2025-08-07)

### MotionState Structure (Fighters)

```c
struct MotionState {
    enum_t anim_id;
    enum_t x4_flags;
    union { /* bitfield stuff */ };
    HSD_GObjEvent anim_cb;   // *_Anim
    HSD_GObjEvent input_cb;  // *_Input
    HSD_GObjEvent phys_cb;   // *_Phys
    HSD_GObjEvent coll_cb;   // *_Coll
    HSD_GObjEvent cam_cb;    // *_Cam
};
```
- Source: ribbanya (2025-08-07)

### Data Sections

| Section | Characteristics |
|---------|-----------------|
| .rodata | const, initialized, >8 bytes |
| .data | initialized (including `= {0}`) |
| .bss | uninitialized (runtime zeroed) |
| .sdata2 | small const data, but NOT short strings |

Note: `= {0}` goes to .data not .bss despite being zero.
- Source: ribbanya, altafen (2025-08-12)

### MinorScene BSS Order

Non-static structs in .bss appear in reverse declaration order:
- Character select -> stage select -> start melee -> end melee -> results screen
- Declared in that order, but appear reversed in memory
- Source: rtburns (2025-08-08)

## Function-Specific Insights

### Falcon Down-B Double Jump

Falcon's aerial down-B restores his double jump on the last frame:
- `ftCa_SpecialAirLw_Anim` checks `!framesRemaining`
- Calls `ftCommon_8007D5D4` (the "restore airjump" function)
- Possibly copied from grounded down-B code path
- Source: altafen (2025-08-30)

### CPU Behavior Logic

- ftCo_0A01 contains CPU behavior/AI logic
- ftCo_0B3E possibly related
- CPU command bytecode interpreter decompiled - CPUs use virtual controllers
- Commands include: press/release buttons, move stick toward enemy/stage
- Source: rtburns (2025-08-25-26)

### HSD_JObjSetMtxDirty

Confirmed to be a function, not a macro:
https://github.com/ribbanya/melee/commit/fcccad97b418241b5c4c79f3dd8ae4bf4e281a8e
- Source: ribbanya (2025-08-16)

### Brawl Function Names (Korean Brawl Symbols)

Zebes stage functions matched to Melee:
```
grZebesMapProc       -> grZebes_801d881c
grZebesWaterProc     -> grZebes_801d99e0
grZebesBGProc        -> grZebes_801d9f84
grZebesShaftUpdate   -> grZebes_801da528
grZebesCellAdd       -> grZebes_801dae70
grZebesCellUpdateOne -> grZebes_801db088
grZebesCellUpdate    -> grZebes_801db3cc
grZebesCellRebirth   -> grZebes_801dc408
grZebesCellInit      -> grZebes_801dc9DC + grZebes_801dc744
```
Korean Brawl has symbols; matched by comparing function patterns in Ghidra.
- Source: mariolover64 (2025-08-29)

## Tool Tips

### Useful Ninja Targets

```bash
ninja              # Standard build
ninja diff         # Build and diff against original (CI uses this)
ninja baseline     # Set baseline for changes check
ninja changes      # Check for broken functions
ninja changes_all  # Check for ALL regressed functions
ninja all_source   # Build all objects without linking
ninja -t clean     # Clean build (or rm -rf build/GALE01)
```
- Source: ribbanya (2025-08-05)

### decomp.py Usage

```bash
python tools/decomp.py --format --colorize func_name --valid-syntax --no-casts --stack-structs
```
Dependencies: `pip install -r reqs/decomp.txt`
- Source: altafen (2025-08-12)

### Other Useful Scripts

| Script | Purpose |
|--------|---------|
| `tools/scaffold.py` | Fill in function declarations in c/h files |
| `tools/easy_funcs.py` | Find small functions to match (requires Python 3.12) |
| `tools/m2ctx/m2ctx.py` | Generate m2c context |

Scripts requiring Python 3.12: `easy_funcs.py` (uses PEP 695 type syntax)
- Source: altafen (2025-08-05)

### Testing Context Locally

```bash
tools/m2ctx/m2ctx.py -pqx && melee-mwcc -nofail build/ctx.c -v -o build/ctx.c.o
```
- Source: ribbanya (2025-08-13)

### objdiff Enhancements

Altafen's fork has useful modifications:
- `bl` instruction anchoring for better diffs: https://github.com/encounter/objdiff/compare/main...BR-:objdiff:bl_anchor
- Symbol size display: https://github.com/encounter/objdiff/compare/main...BR-:objdiff:show_symbol_size
- Source: altafen (2025-08-02, 2025-08-12)

### Branch Watch Tool

Located in Dolphin's debugging UI (not Dolphin Memory Engine):
- DME is separate: https://github.com/aldelaro5/dolphin-memory-engine
- Branch watch scans code execution for taken branches (ifs, whiles)
- Useful for dynamic analysis and gecko code debugging
- Source: altafen, sephdebusser (2025-08-14-15)

### symbols.txt Data Types

To change how dtk interprets symbol data:
- Remove `data:byte` or set `data:4byte` in `config/GALE01/symbols.txt`
- dtk guesses `byte` by default, sometimes incorrectly
- Source: rtburns (2025-08-05)

### VSCode Format-on-Save

To avoid massive diffs from auto-formatting:
```json
"editor.formatOnSaveMode": "modificationsIfAvailable"
```
- Source: altafen (2025-08-04)

## Pitfalls and Gotchas

### decomp.me vs Local Builds

decomp.me context differs from local builds:
- `Item_GObj` on decomp.me has `Item* user_data` but locally has `void* user_data`
- `GET_ITEM` on decomp.me has extra `(HSD_GObj*)` cast
- Always verify matches locally with objdiff before committing
- Code that matches on decomp.me may need adjustments locally
- Source: altafen (2025-08-12)

### M2C_FIELD Anti-Pattern

While `M2C_FIELD` can force matches, it defeats the purpose of matching:
- Doesn't help flesh out structs and function signatures
- Acceptable for bulk matching but not ideal
- Source: ribbanya (2025-08-12)

### CI Build Failures

The error `Data mismatch for [function]` means your changes broke that function:
- Replicate with `ninja diff` locally
- The "os error 2" is a CI bug, ignore it
- Source: ribbanya (2025-08-05)

### Include Conventions

Header include priorities exist but are being simplified:
- `forward.h` for type forward declarations
- `gobj.h` needed for struct definitions (non-m2c)
- Many .c files missing their corresponding .h include - oversight to be fixed
- iwyu is set up but hasn't been run in ~1 year
- Source: ribbanya (2025-08-06)

### Float Constants

Don't use named float constants (like `THREE_F`), just use literals:
```c
// Bad
float x = THREE_F;
// Good
float x = 3.0f;
```
- Source: ribbanya (2025-08-02)

### Struct Disambiguation

When matching reveals a new struct, create it locally until it clashes with existing:
- Happens all the time
- Can merge identical structs later
- Source: ribbanya (2025-08-15)

## Progress Milestones

- August 8: Hit 38% completion
- August 27: Hit 40% completion
- Growth from ~33.33% to 40% in approximately one month

## New Contributors Welcome

The Melee Decomp Dashboard tool (https://github.com/Bootstrings/decomp-dashboard) was introduced to help newcomers:
- Automates project setup and dependency installation
- Shows list of incomplete functions
- Integrates with decomp.me
- Windows only currently
- Source: bootstrings (2025-08-03)

Tips for new contributors:
- Start with ft/ (fighters) or it/ (items) - better understood than mn/ (menus)
- Use `tools/easy_funcs.py` to find small functions
- ASM files are in `build/GALE01/asm` after building
- Ask in Discord - the community is helpful
