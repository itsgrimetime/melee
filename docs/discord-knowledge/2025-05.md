# Decompilation Knowledge: 2025-05

## Compiler Patterns

### Duplicate Floating-Point Constants and File Boundaries
- The compiler merges duplicate floating-point constants (0.0F, 1.0F) within a single file but NOT across files
- Seeing duplicate constants in `.sdata2` indicates a file boundary between them
- This is one way to figure out what objects belong in which file
- Source: gamemasterplc, renakunisaki (2025-05-01)

### s32 vs int Codegen Differences
- Using `s32` vs `int` can change code generation in subtle ways
- General consensus is to use `int` in `src/melee/` and SDK types (`s32`, `f32`) in `src/dolphin/`
- Preference varies; some resigned to using `int` due to codegen differences
- Source: altafen, ribbanya (2025-05-29, 2025-05-31)

### `u8` to `int` Parameter Translation
- The compiler often translates `int` to `u8` when used as a function argument
- Common in `Player` functions when passing in the player slot
- If a function takes a `u8` and forwards it to a function taking `int`, you may see an extra instruction for the cast
- Changing the signature to `int` may be correct if all call sites match
- Source: ribbanya (2025-05-12)

### `#pragma peephole off` and Inline ASM
- The `crclr` instruction can appear unexpectedly due to inline ASM earlier in a file affecting peephole optimization
- Adding `#pragma peephole off` can fix this
- Source: cadmic, werewolf.zip (2025-05-21)

### Ternary Operators and Stack Size
- Ternary operators often inflate stack size unexpectedly
- Replacing a ternary with an inline function or separate if/else can sometimes fix stack mismatches
- Source: ribbanya (2025-05-29)

## Matching Techniques

### Stack Size Mismatches (8 bytes)
- An 8-byte stack difference often indicates a missing inline function
- Use `PAD_STACK(8);` to force match if needed
- Alternatively, look for missing variable declarations or compound expression temps
- Source: ribbanya (2025-05-25)

### Register Swaps via Variable Order
- Register allocation is influenced by the order variables are declared
- Reordering variable declarations can fix r30/r31 register swaps
- Source: altafen (2025-05-25)

### Using Accessor Macros (GET_COBJ, GET_FIGHTER)
- Using macros like `GET_COBJ` instead of raw pointer access can fix stack size issues
- Example: Adding `GET_COBJ` for `main_cam` fixed stack size, but adding for both cameras made stack too big - balance is needed
- Source: altafen (2025-05-25)

### RETURN_IF Macro for Useless cmpwi
- Seemingly useless `cmpwi` instructions can be matched by adding `RETURN_IF` like other similar functions
- Source: chippy__ (2025-05-31)

### Inline Callback Pattern
- Inlines can take function pointers as callbacks, and the callback itself gets inlined as a normal `bl`
- This is advanced inline alchemy that produces surprising codegen
```c
static inline void foo(void (*cb)(void)) {
   cb();
}

void bar(void);

void lbl_DEADBEEF() {
  foo(bar);
}
// Compiles to just: bar();
```
- Source: ribbanya (2025-05-29)

### Dash/Run Movement Inline Pattern
- Functions like `ftCo_TurnRun_Phys`, `ftCo_Dash_Phys`, `ftCo_Run_Phys` share a common inline for acceleration calculation
- The inline handles `accel`, `flat_accel`, `max_vel` calculations
- Search pattern: `lfs f\d+, 0x24\(r\d+\)\n.*fneg f\d+, f\d+\n.*:\n.*lfs f\d+, 0x28\(r\d+\)`
- Source: ribbanya, gigabowser (2025-05-29)

## Type Information

### HurtCapsule Size Discrepancy
- Fighter-specific `HurtCapsule` has size 0x4C
- Internal generic `HurtCapsule` (used by Item and lb code) has size 0x44
- This explains mismatches in Item code that appears to read wrong types from end of HurtCapsule array
- Refactoring needed to separate these types
- Source: rtburns (2025-05-29)

### Motion Variables (fp->mv)
- `fp->mv.co.common.xC` and similar are motion variables (state in finite state machine)
- Each state has its own union member: `fp->mv.co.turnrun.accel_mul`
- Unknown state variables should get new union members, not use `common.xC`
- Source: ribbanya (2025-05-28)

### Static Data Section Layout
- Sections ordered: `.text` -> `.data` (big, initialized) -> `.rodata` (big, const) -> `.bss` (big, uninitialized) -> `.sdata` (small, initialized) -> `.sdata2` (small, const) -> `.sbss` (small, uninitialized)
- "Big" threshold is ~8 bytes
- `static Vec3 x;` (12 bytes, uninitialized) goes to `.bss`, not `.rodata`
- Constants in code like `float x = 1.5;` go to `.sdata2`, Vec3 literals go to `.rodata`
- Source: altafen (2025-05-25)

### HSD_CObjDesc Union Initialization
- In C99, you can only initialize the first union member
- If you need to initialize a different member, define as that type instead (e.g., `HSD_CameraDescPerspective` instead of `HSD_CObjDesc`)
- Source: gamemasterplc, altafen (2025-05-25)

## Tool Tips

### objdiff Usage
- Use `ninja baseline` (on master) then `ninja changes` (on working branch) to see changes
- `ninja changes_all` shows if changes affect unlinked/fuzzy code too
- `ninja all_source && ninja` only checks errors + linked code match
- Source: ribbanya, altafen (2025-05-25, 2025-05-26)

### Function Relocation Diffs in objdiff
- Set "Diff Options > None" to ignore function relocation differences when working on incomplete files
- Use "Diff Options > Data value" for stricter checking of actual values
- Issue: objdiff marks local vs extern symbols as mismatch even when names match
- Patch available to fix this behavior:
```diff
--- a/objdiff-core/src/diff/code.rs
+++ b/objdiff-core/src/diff/code.rs
@@ -325,7 +325,7 @@ fn reloc_eq(
                     || display_ins_data_literals(left_obj, left_ins)
                         == display_ins_data_literals(right_obj, right_ins))
         }
-        (Some(_), None) => false,
+        (Some(_), None) => symbol_name_addend_matches,
```
- Source: rtburns (2025-05-27, 2025-05-30)

### decomp.me Button in objdiff
- The scratch button works but creates scratches from object files, not ASM
- You cannot run m2c on object-file-based scratches
- Workaround: Copy ASM from `build/GALE01/asm/src/.../*.s`
- Source: rtburns, werewolf.zip (2025-05-28)

### Useful Tools
- `tools/scaffold.py <path>` - Generate function name comments for partially matched files
- `tools/sort-declarations.sh` - Sort declarations by symbols.txt order (vim integration)
- `tools/easy_funcs.py -a -S 24 -M 99.999` - Find small, nearly-matched functions for quick wins
- `tools/decomp.py` - Run m2c locally with auto-generated context
- `ninja apply` - Update symbols.txt from built ELF (only works on linked files)
- Source: ribbanya, altafen (2025-05-25)

### Deprecated Tools
- `asm-differ` - Completely deprecated, use objdiff
- `report_score` - Replaced by decomp-dev-bot
- `calcprogress` - Deprecated
- `Makefile` - Deprecated, use ninja/dtk
- Source: ribbanya (2025-05-25)

### Context Generation
- Global context (`ctx.html`) includes all `.static.h` files which can break data sections
- `.static.h` files should NOT be included in global context; only the one for the current file
- Workaround: Filter out `.static.h` or wrap in `#ifdef` block
- Source: rtburns (2025-05-28)

### Getting Started Without Local Setup
- Copy function ASM from: https://github.com/doldecomp/melee/tree/master/asm
- Copy context from: https://doldecomp.github.io/melee/ctx.html
- Paste into: https://decomp.me/new (preset SSBM, diff label blank)
- Source: altafen (2025-05-26)

## Build System

### dtk-template Updates
- `ninja baseline` + `ninja changes` for comparing branches
- `configure.py --non-matching` for non-matching builds
- decomp.dev integration pulls `report.json` artifact automatically
- dtk 1.5.0+ no longer updates anonymous `@` symbols, reducing merge conflicts
- Source: encounter, werewolf.zip (2025-05-21)

### CI and Progress Tracking
- GitHub bot comments on PRs with function percent changes
- `diff` step generates `report.json` artifact for decomp.dev
- Diff step disabled as requirement; runs progress update regardless of pass/fail
- Frogress deprecated; data migrating to decomp.dev
- Source: werewolf.zip (2025-05-21, 2025-05-22)

### New Compiler for TRK
- Compiler `mwcc_233_163n` (1.1p1) now available for TRK matches
- decomp.me has this compiler available
- Source: werewolf.zip, cadmic (2025-05-21)

### Nix Build Issues
- Magic Nix Cache service deprecated (April 2025)
- Migration to cachix required for caching
- Nix builds can be slow (~9 minutes) without proper caching
- devkitppc no longer needed with dtk
- Source: rtburns, werewolf.zip (2025-05-22)

## Pitfalls and Gotchas

### Slippi ISO Issues
- Using Slippi-modified DOL will cause hash mismatch
- Ensure you extract from vanilla NTSC 1.02 ISO, not Slippi version
- Source: soulctf (2025-05-26)

### .static.h and BSS Ordering
- Reordering items in `.static.h` can break BSS ordering
- Data section items (`gm_803DD2C0`) should be externed if not initialized in file
- Moving static data around can shift offsets and break partially-matched functions
- Source: rtburns, altafen, ribbanya (2025-05-25, 2025-05-28)

### Function Renaming and CI
- Function renaming causes diff step to fail (shows 100% -> 0 for renamed functions)
- This is expected behavior; CI diff step is now non-blocking
- decomp.dev bot handles actual regression checking
- Source: werewolf.zip, altafen (2025-05-25)

### Data Matching Advice
- Don't work on data sections until file is done
- Most static data are literals used in functions that m2c will auto-insert
- Data ordering only matters at final linking stage
- Source: ribbanya (2025-05-25)

### clang Warning Pragmas
- Use clang push/pop pragmas to ignore warnings for specific functions
- `-Wsign-compare` often needs suppression; can also cast `(signed)` or `(unsigned)`
- `-Wreturn-type` may need suppression when missing return is intentional for match
- Source: werewolf.zip, rtburns (2025-05-29, 2025-05-30)

### PAD_STACK Limitations
- `PAD_STACK(n)` cannot be placed between declarations
- For padding between stack variables, use scope blocks or manual array allocation
- Source: rtburns, ribbanya (2025-05-30, 2025-05-31)

## Workflow Tips

### Contributing
- Make a PR; progress is progress regardless of file vs function scope
- Functions at 70%+ can be committed if difficult; come back later with fresh eyes
- As long as it compiles and doesn't break other functions, it can be PRd
- Link decomp.me scratch in issue if not ready for full PR
- Source: ribbanya, werewolf.zip (2025-05-22)

### Finding Work
- decomp.dev for browsing TUs and functions
- objdiff for exploring objects locally
- Translation Units wiki page for tracking who's working on what
- `tools/easy_funcs.py` for finding small, high-percentage functions
- Look at allocator callsites to find initializers
- Source: encounter, werewolf.zip, ribbanya (2025-05-21, 2025-05-25)
