# Decompilation Knowledge: September-December 2020

This document distills technical knowledge from the #smash-bros-melee channel during the early months of the project (177 messages total across Sept-Dec 2020). This was a quiet period with foundational discussions about project setup, compiler issues, and early matching attempts.

## Compiler Patterns

### MWCC 2.2 vs 2.3 Compiler Version Issue
- The project was using an incorrect compiler version with a workaround hack
- **Key difference**: Prologue and epilogue are not subject to instruction scheduling before version 2.3.x
- Melee relies on a bug present in 2.2.x that was fixed in 2.3.x
- A $1000 bounty was considered for finding a working mwcceppc 2.2 version
- Source: revosucks (2020-12-02, 2020-12-03)

### Stack Frame Bloat with Temp Variables
- Using a temp variable for floating-point conversion can cause unexpected stack frame expansion:
```c
// This pattern caused stack bloat:
f32 HSD_Randf(void)
{
  f32 temp;
  *RAND_SEED_PTR = *RAND_SEED_PTR * 214013 + 2531011;
  temp = (f32)(*RAND_SEED_PTR >> 0x10);
  return (temp) / USHRT_MAX;
}
```
- Result: Stack frame grew from 16 bytes (`stwu r1,-16(r1)`) to 40 bytes (`stwu r1,-40(r1)`)
- Source: werewolf.zip (2020-11-19)

### Static Float Inside Function Affects Codegen
- Declaring a static float inside a function vs outside affects code generation
- This behavior is also seen in IDO (SGI compiler)
```c
// Inside function - different codegen
s32 myFunc() {
   static f32 foo;
   //...
}

// vs outside function
static f32 foo;
s32 myFunc() {
   //...
}
```
- Source: revosucks (2020-11-19)

### force_active Pragma for Preventing Shifts
- Missing `force_active` on a function can cause shifts in the object file
- When experiencing unexpected shifts, check if force_active is needed
- Source: werewolf.zip (2020-10-22)

## Matching Techniques

### SDA2 Label Adjustments for Inline ASM
- When converting functions to inline assembly, SDA2 (r2) labels may need adjustment
- The next function in sequence can shift r2 references
- Example: Labels `lbl_804DE798` and `lbl_804DE790` needed to become `lbl_804DE790` and `lbl_804DE788` in inline version
- Source: werewolf.zip (2020-11-19)

### NON_MATCHING Macro Usage
- `NON_MATCHING` was used when functions couldn't be matched, not just as a workaround for SDATA2 splitting
- Example: `random.c` had functions marked non-matching because the assembly showed a variable (`lbl_804DE790`) that wasn't used in the non-matching Randf
- Source: werewolf.zip (2020-12-30)

## Type Information

### Assert Function Format
- HAL's debug library assert format:
```c
assert("filename.c", 0x28 /* line number */, "reason");
```
- Condition is always the opposite of the reason string
```c
if (x != -1)
   assert("filename.c", 0x28, "x == -1");
```
- Likely expands from macro using `__FILE__` and `__LINE__`:
```c
#define assert(EXP) (void)((EXP) || (__assert(__FILE__, __LINE__, #EXP),0))
#define assertmsg(MSG, EXP) (void)((EXP) || (__assert(__FILE__, __LINE__, MSG),0))
```
- The function should be named `__assert` (not `assert`) since assert is the macro name
- Line numbers can be hardcoded for matching (done in Fire Red decomp)
- Source: werewolf.zip, gibhaltmannkill, revosucks (2020-09-27)

### RNG Algorithm
- Melee's RNG uses the same Linear Congruential Generator as CodeWarrior's standard library
- Magic numbers: multiplier 214013, increment 2531011
- **Important**: The RNG used by game code is in `sysdolphin/random.c`, NOT in `MSL/rand.c`
- MSL files are from the CodeWarrior SDK standard library
- Source: werewolf.zip, amber_0714 (2020-12-26, 2020-12-27)

### OSPanic
- `OSPanic` is the underlying handler that asserts call
- It's a weak symbol, so it can be overridden (Hudson did this in Mario Party)
- Source: gamemasterplc (2020-09-27)

## Project Structure

### DOL Sections
- Text section 0 is the `.init` section
- Source: gibhaltmannkill (2020-12-01)

### Symbol Naming Convention
- Preferred convention: `filename_address` or `filename_functionality` if not in an assert
- Avoid using public symbol maps (Achilles' sysdolphin symbols have errors)
- SDK functions (like `AXInitEx`) may use original names but accuracy wasn't verified
- Source: werewolf.zip (2020-11-30)

### File Organization
- Functions are done in order and inlined
- If something isn't defined in a .c file at the top, it isn't part of that file
- Don't skip functions and leave them in .s files
- Source: werewolf.zip (2020-12-01)

## Tool Tips

### Build and Verification
- The DOL should be 100% identical when rebuilt
- Rebuilt ISO with compiled DOL produces perfectly functional game
- Target version: 1.02
- Non-decompiled code is kept in assembly files
- Source: gamemasterplc (2020-11-29)

### Ghidra Setup
- Gekko/Broadway language extension for Ghidra: https://github.com/aldelaro5/ghidra-gekko-broadway-lang
- Was recommended and in use as of 2020
- Source: kiwidev, ed_ (2020-11-29)

### Progress Tracking
- GitHub's C percentage is inaccurate due to inlined assembly
- At 1.1% C according to GitHub metrics at the time
- Source: werewolf.zip (2020-12-01)

## Historical Notes

### Early Project State (Late 2020)
- Project was very early stage (~1.1% C)
- werewolf.zip's prior work in the FRAY repository was being used as reference
- Not all work was transferred from FRAY to doldecomp/melee
- Missing: tons of sysdolphin, Player struct/functions, Character struct
- Source: werewolf.zip (2020-11-29)

### Reference Projects
- melee-re (https://github.com/hosaka-corp/melee-re) - reverse engineering docs
- FRAY (https://github.com/PsiLupan/FRAY) - werewolf.zip's prior matching work
- GNT4 - has matching versions of some functions (like HSD_Randf/HSD_Randi) that differ slightly from Melee
- Source: werewolf.zip, ed_ (2020-11-19, 2020-11-29)

## Pitfalls and Gotchas

### Assert String Typos
- Original assert strings contain typos like "dont't" (Engrish)
- These must be preserved exactly for matching
- Source: werewolf.zip (2020-09-27)

### PR Workflow
- Maintainer (werewolf.zip) preferred PRs over manual copy of changes
- Cross-platform testing recommended (Mac vs Windows)
- Source: werewolf.zip, amber_0714 (2020-12-30)

### C vs C++ Compilation
- When working with cstring functions, can use C mode directly instead of `extern "C"`
- Source: werewolf.zip (2020-12-30)
