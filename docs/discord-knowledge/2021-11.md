# Decompilation Knowledge: November 2021

This month marks a significant milestone: Melee achieved full shiftability on November 19th, 2021 (coincidentally the day after the game's anniversary). The conversations cover shiftability work, compiler investigations, and early decompilation infrastructure.

## Compiler Patterns

### EPPC4 vs 1.0 Compiler Scheduling
- **Key finding**: The main game code and sysdolphin/SDK use EPPC4 compiler, which has a known scheduling bug in prologues/epilogues
- **Scheduling behavior**: In scheduled code, instructions from the main body get relocated INTO the prologue territory, but the prologue instructions themselves remain in the same order
- **Testing insight**: `#pragma scheduling off` disables scheduling entirely, but this changes regalloc as well as scheduling
- Source: epochflame, revosucks (2021-11-07, 2021-11-29)

### Stack Frame Differences Between Compilers
- **lbvector mystery**: The first function of `lbvector.c` requires Mac 2.2 compiler for correct stack offsets (0x8 instead of 0x10)
- CW 1.0 (2.3) places variables at different stack offsets than Mac 2.2
- The issue manifests in `lfs`/`stfs` instructions using incorrect offsets
- Source: revosucks (2021-11-19)

```
// Mac 2.2 - Correct (matches original):
lfs/stfs use offset 0x8

// CW 1.0 (2.3) - Incorrect:
lfs/stfs use offset 0x10 (16-bit aligned instead of 8-bit)
```

### Prologue/Epilogue Scheduling Fix
- A postprocessor script (`postprocess.py`) can fix some scheduling issues
- Some functions without `mtlr` have `addi` instructions ordered incorrectly in the epilogue
- The postprocessor checks for specific `addi` stack sizes to detect and fix these cases
- Source: werewolf.zip (2021-11-28)

Example of scheduled vs expected epilogue:
```
// Scheduled (incorrect):     // Expected:
addi r1,r1,0x18              // [moved to end]
fsubs f0,f0,f1               fsubs f0,f0,f1
fadds f0,f2,f0               fadds f0,f2,f0
stfs f0,0(r3)                stfs f0,0(r3)
lwz r4,8(r3)                 lwz r4,8(r3)
addi r0,r4,4                 addi r0,r4,4
stw r0,8(r3)                 stw r0,8(r3)
// [missing]                 addi r1,r1,0x18
blr                          blr
```

### Compiler Stack Frame Generation
- epochflame identified the stack frame generation function in the 1.0 compiler at address `0x433ff2`
- NOPing calls to this function produces "frameless" output (no prologue/epilogue)
- Prologue and epilogue can be disabled separately
- This could enable writing C code with manually constructed stack frames via inline asm
- Source: epochflame (2021-11-22)

### Linker Version Effects
- Linker versions 1.0 to 1.2.5 work correctly; avoid 1.0 because it's slow
- Linker 2.7 produces different padding behavior
- Melee uses linker 1.3.2 (last version before ctors/dtors changes)
- Linking takes ~15 seconds with 1.3.2
- Source: werewolf.zip, camthesaxman (2021-11-22)

### Lost Compiler Patch
- A patch existed for EPPC4 that fixed an `addu` bug: https://web.archive.org/web/20011121032509/http://www.metrowerks.com:80/games/gamecube/update/
- At least one function in TRK requires this patch (see: mainloop.s)
- The patch is considered "lost media" - nobody has a copy
- Source: revosucks (2021-11-29)

## Matching Techniques

### Loop Unrolling Prevention via Struct Copy
- Metrowerks compiler unrolls normal loops in certain cases
- Workaround: Use manually casted pointer struct copy instead of a loop

```c
// Copy the attributes using the specified type, and set
// the pointer appropriately. We have to use a manually
// casted pointer struct copy since Metrowerks seems to
// be unable to avoid unrolling with a normal loop.
#define SET_ATTRIBUTES(type)                         \
{                                                    \
    type *dest =                                     \
        (type *)player->special_attributes2;         \
    type *src =                                      \
        (type *)player->ftDataInfo->charAttributes;  \
    u32 *attr =                                      \
        (u32 *)&player->special_attributes1;         \
    *dest = *src;                                    \
    *attr = (u32)dest;                               \
}
```
Source: werewolf.zip (2021-11-07)

### Inline ASM Jump Table Labels
- Problem: Jump tables in inline ASM functions can't use global labels for case addresses
- Solution: Use offset from function start label instead of direct labels

```asm
// Instead of direct address:
.4byte 0x803652E4

// Use label + offset (makes function shiftable as a unit):
.4byte lbl_80001234+20
```
Source: epochflame (2021-11-06)

## Type Information

### HSD_GObj Structure
```c
typedef struct _HSD_GObj {
    u16 classifier;
    s8 p_link;
    s8 gx_link;
    u8 p_priority;
    u8 render_priority;
    s8 obj_kind;
    s8 user_data_kind;
    struct _HSD_GObj* next;         // 0x08
    struct _HSD_GObj* prev;         // 0x0C
    struct _HSD_GObj* next_gx;      // 0x10
    struct _HSD_GObj* prev_gx;      // 0x14
    struct _HSD_GObjProc* proc;     // 0x18
    void (*render_cb)(struct _HSD_GObj* gobj, int code); // 0x1C
    u64 gxlink_prios;
    void* hsd_obj;
    void* data;                     // 0x2C - Fighter functions access ftData here
    void (*user_data_remove_func)(void* data);
    void* x34_unk;
} HSD_GObj;
```
Source: werewolf.zip (2021-11-08)

### Stage IDs
- `0x1B` = Flat Zone (internal stage ID)
- Stage info accessed via `stInfo` struct at `8049E6C8`
- Source: werewolf.zip (2021-11-08)

### TOC/SDA References
- TOC (Table of Contents) is loaded in init functions
- `SDA2_BASE` is at `0x804DF9E0`
- `SDA_BASE` (r13) is at `0x804DB6A0`
- Stack end at `0x804EEC00`
Source: werewolf.zip (2021-11-10)

## Function-Specific Insights

### TRK Functions
- Melee has two instances of memcpy: regular `memcpy` and `TRK_memcpy`
- Similarly two `TRK_fill_mem` variants exist
- TRK version string in pikmin1: "TRK v0.8"
- Source: werewolf.zip, camthesaxman (2021-11-08)

### Fighter OnLoad Functions
- Fighter functions access `ftData` struct via GObj offset 0x2C
- `FighterOnLoad_Peach` matched without scheduling pragma changes to prologue/epilogue
- This was used as evidence that not all Melee code has EPPC4 scheduling issues
- Source: revosucks (2021-11-07)

### lb (Library) Functions
- `lb` prefix functions (like `lbvector`) are NOT part of sysdolphin
- They appear to be separate .a library files with different compilation settings
- The `lbvector` stack offset issue suggests different compiler version/settings
- Source: revosucks, werewolf.zip (2021-11-07, 2021-11-19)

## Tool Tips

### File Splitting Techniques
1. **Panic strings**: Filenames in panic messages indicate compilation unit boundaries
2. **Float-to-int constants**: `0x43300000` (for int-to-float conversion) appears once per compilation unit
3. **Call trees**: Functions only called by nearby functions are likely in the same file
4. **8-byte alignment**: Data sections align to 8 bytes at file boundaries
5. **Pointer tables**: Item pointer tables can help identify `it_*` file boundaries
Source: epochflame, werewolf.zip (2021-11-22)

### elf2dol Improvements
- Old elf2dol had issues with:
  - DOL header section sizes
  - BSS overlap calculations
  - Missing objcopy header fix
- Cam's update fixed DOL header generation but broke some projects
- Combined fix removes need for objcopy post-processing
- BSS size in DOL header = (end of last BSS section) - (start of first BSS section)
- This range intentionally overlaps some data sections
Source: werewolf.zip, camthesaxman, kiwidev (2021-11-22)

### _rom_copy_info Section Sizes
- Section sizes in `_rom_copy_info` must match ELF sizes, NOT padded DOL sizes
- Use `readelf -S` to verify section sizes match
- extab and extabindex sections often need manual padding adjustment
- Source: camthesaxman (2021-11-22)

### Ghidra for Compiler Analysis
- epochflame created a Ghidra project for the 1.0 compiler
- Technique: NOP function calls or make functions return immediately to identify purpose
- Bookmarked functions: `StackFrameGen`, `Scheduler`, related subfunctions
- Stack frame generation at `0x433ff2`
- Source: epochflame (2021-11-22)

## Shiftability

### Achieving Full Shiftability (November 19, 2021)
Steps taken:
1. **Script automation**: Used progenitor9339's script for jump tables (got all but inline ASM ones)
2. **Regex for pointers**: werewolf.zip wrote regex to find pointer patterns in ASM
3. **Manual labeling**: ~16k pointers needed cleanup initially
4. **lwzu fixups**: Critical fix for `lwzu` with preceding `lis @ha`

### lwzu/lis Pattern Fix
Common disassembly error where `lwzu` address not properly resolved:
```asm
// INCORRECT (as disassembled):
lis r4, lbl_803C0004@ha
...
lwzu r3, -0x7c60(r4)      // Actually loads from 803B83A0
lwz r0, lbl_803C0004@l(r4) // This lwz is NOT using a label

// CORRECT:
lis r4, lbl_803B83A0@ha
...
lwzu r3, lbl_803B83A0@l(r4)
lwz r0, 0x4(r4)           // Just offset, no label
```
The `lwzu` and `lis` are the real `@ha`/`@l` pair; the following `lwz` just loads at offset +4.
Source: epochflame, camthesaxman, werewolf.zip (2021-11-19)

### addic. Pattern
Similar to lwzu, `lis` + `addic.` needs proper label resolution:
```asm
lis r3, lbl_80458EB0@ha
addic. r3, r3, lbl_80458EB0@l
```
Source: werewolf.zip (2021-11-20)

### OSReport/Dolphin Quirks
- Putting NOPs in OSReport causes infinite loop in Dolphin emulator
- Dolphin patches OSReport, OSPanic, and similar functions
- Shifting Dolphin SDK functions before OSReport causes game freeze
- Dolphin uses function signatures to locate these functions
Source: werewolf.zip, joshuamk, gamemasterplc (2021-11-20)

## Pitfalls and Gotchas

### False Positive Pointers
- Floats surrounded by other floats are usually not pointers
- Use blacklists for known false positives when scripting pointer detection
- Search for `0x80N` pattern to find potential pointer values
Source: epochflame, werewolf.zip (2021-11-06, 2021-11-20)

### Section Padding Issues
- Different tools (elf2dol, makedol) handle padding differently
- Natural section size vs padded size: only the last variable's true size matters
- Example: Two 32-bit variables with 64-bit alignment = 96 bits natural, not 128
Source: revosucks (2021-11-22)

### Scheduling Pragma Side Effects
- `#pragma scheduling off` affects BOTH scheduling AND register allocation
- Cannot be used to isolate scheduling changes only
- For testing, compare scheduled vs unscheduled output from same compiler
Source: camthesaxman (2021-11-29)

### sdata2 Shift Issues
- sdata2 pointers may not update correctly during shifts
- Caused graphical glitches when shifting code
- Reset Dolphin if seeing wrong DOL loaded
Source: werewolf.zip (2021-11-28)

### Debug Menu Strings
- Huge number of debug menu strings require manual labeling
- werewolf.zip noted "there's so fucking many" - started with ~800, worked down to ~500
Source: werewolf.zip (2021-11-19)

## Progress Tracking

### Melee Progress (as of November 28, 2021)
```
Progress:
    Code sections: 12152 / 3882272 bytes in src (0.313013%)
    Data sections: 0 / 1211849 bytes in src (0.000000%)

You have 0 of 290 Trophies and 0 of 51 Event Matches.
```
Source: werewolf.zip (2021-11-28)

## Key Contributors This Month
- **werewolf.zip (psiLupan)**: Led shiftability effort, postprocessor fixes, struct documentation
- **epochflame**: Compiler research, prologue/epilogue analysis, cross-project tooling
- **revosucks**: Compiler version expertise, lbvector investigation
- **camthesaxman**: elf2dol fixes, TRK analysis, file splitting techniques
- **progenitor9339**: Jump table cleanup scripts
- **kiwidev**: elf2dol padding insights

## References
- Melee Symbol Spreadsheet: https://docs.google.com/spreadsheets/d/1JX2w-r2fuvWuNgGb6D3Cs4wHQKLFegZe2jhbBuIhCG8/edit#gid=20
- Metrowerks EPPC4 patch (archived): https://web.archive.org/web/20011121032509/http://www.metrowerks.com:80/games/gamecube/update/
- TP makerel.py: https://github.com/zeldaret/tp/blob/master/tools/makerel.py
