# Decompilation Knowledge: June 2025

## Compiler Patterns

### fcmpo vs fcmpu - Float Comparison Instructions
- When the target uses `fcmpo` + `cror` but you're getting `fcmpu`, the issue is usually a combined operation involving equality
- `cror` is typically used for combined float comparisons
- Switching from `==` to `<=` can fix this pattern
- Source: mr.grillo, gamemasterplc (2025-06-01)

### u32 vs unsigned int Stack Size Difference
- `u32` is defined as `unsigned long` in Melee, while `unsigned int` is a different type
- Changing `u32` to `unsigned int` can cause 8-byte stack size differences
- This caused issues during the extern/dolphin merge
- Source: rtburns, ribbanya, 2s2w (2025-06-02)

### GET_FIGHTER Cast Causing Mismatches
- The `GET_FIGHTER` macro has an ifdef for M2C contexts that adds a cast from `Fighter_GObj*` to `HSD_GObj*`
- This cast is unnecessary for matching because `Fighter_GObj` and `HSD_GObj` are the same struct
- The extra cast can cause extra loads and stack usage issues
- In actual repo code, remove the cast that m2c generates
- When using decomp.me, the context has the M2C version "baked in" which can prevent organic matches
- Source: revosucks, rtburns (2025-06-26)

### Implicit Function Declarations
- If you call a function without a declaration, the compiler assumes it returns `int`
- This causes extra instructions to convert the assumed int back to the actual return type
- The pattern `xoris on r3 after a function call` is a telltale sign of implicit declarations
- Common culprits: `sqrtf`, `atan2f`, `lbVector_AngleXY`
- Always ensure proper includes for math functions
- Source: gamemasterplc, gelatart, rtburns (2025-06-25)

### Inlining Heuristics
- mwcc has a "small enough to inline" heuristic
- Functions can be "too large" to auto-inline, but breaking them into smaller inlines can trigger the heuristic
- Using nested inlines (like `ft_SetVec` for vector operations) can make a function small enough to inline
- Assigning a variable inline with a condition check can reduce "line count" for inlining
- Source: revosucks, gigabowser (2025-06-27)

### addi vs mr Peephole Optimization
- The infamous `mr r3,r4` vs `addi r3,r4,0` replacement is a peephole optimization
- Can be broken by inserting dead code that doesn't get pruned until after the mr/addi pass
- Common workaround: `!gobj;` as a statement (from mwcc-debugger research by cadmic)
- Source: rtburns (2025-06-17)

### Loop Unrolling Recognition
- Metrowerks aggressively unrolls loops
- A simple `for (i = 0; i < 215; i++) array[i] = 0;` can become 13 iterations with 16 stores each (16 * 13 = 208), plus a cleanup loop
- Look for repeated store patterns and calculate: stores_per_iter * iterations
- The remainder value (like `0xD7 = 215`) often appears in the cleanup loop
- Source: chippy__ (2025-06-19)

### Bitfield Patterns
- Bitfields often produce weird constant loads that look unfamiliar
- Pattern: `rlwimi` instructions with specific bit ranges
- Define struct members as `: 1` bitfields when you see these patterns
- Source: gamemasterplc (2025-06-29)

### C++ Exceptions Flag
- Some HSD units were compiled with C++ exceptions enabled
- Look for `extab`/`extabindex` entries in objdiff to identify these
- Affected files: particle, psdisp, and some unsplit HSD files
- No dolphin or game code uses it
- Source: rtburns, ribbanya (2025-06-20-21)

## Matching Techniques

### goto to while Loop Conversion
- When m2c generates a `goto` at the end of an if statement that jumps back to a condition, it's a `while` loop
- Converting `if (...) { ...; goto condition; }` to `while (...)` can significantly improve match percentage
- Source: rtburns (2025-06-17)

### Removing goto with Compound Conditions
- `goto` patterns like `if (cond1) goto X; if (cond2) goto X;` can often be folded into `if ((cond1 && cond2) || cond3)`
- Look for shared jump targets to identify foldable conditions
- Source: revosucks, gigabowser (2025-06-23)

### Stack Padding for sqrt/inline Issues
- mwcc's sqrt inline puts intermediate values on the stack
- Due to inline weirdness, the intermediate may go to a different stack slot
- Adding more inlines can push the intermediate deeper into the stack to match
- `FORCE_PAD_STACK_8` can fake a match but may not be the real code
- Source: rtburns (2025-06-25)

### Struct Traversal from m2c Output
- m2c generates ugly chains like `(int *)(*(int *)(*(int *)(iVar3 + 0x10c) + 0x38) + iVar5)`
- Translation: `thing->x10C->x38[iVar5]`
- The base is iVar3, 0x10C is a pointer to another struct, 0x38 is an array in that struct
- Use `m2c --valid-syntax --stack-structs` locally for better output with M2C macros
- Source: werewolf.zip, allocsb, ribbanya (2025-06-24)

### Callback Function Pointer Types
- Callback arrays require careful type matching
- If callbacks don't take arguments but the array type expects `void*`, give them a dummy argument
- Function pointer syntax: think of definition matching usage - `(*(arr[5]))()` means `int (*(arr[5]))()`
- Source: kellz, altafen, revosucks (2025-06-27)

## Type Information

### Fighter Union for Character-Specific State
- `ext_attr` (void*) points to character-specific attribute structs
- Use the appropriate character's attributes struct (e.g., `ftYoshiAttributes` for Yoshi code)
- Fighter struct has a union `Fighter_FighterVars` at offset +222C for character-specific state
- Each character has their own `ftXX_FighterVars` struct in the union
- Source: werewolf.zip (2025-06-25)

### SpecialS vs SpecialHi Unions
- `SpecialS` = Side-Special (side-B)
- `SpecialHi` = Up-Special (up-B)
- Add new union members as needed for specific moves
- Source: rtburns (2025-06-21)

### Attribute Structs
- Almost everything in character Attributes structs is a `float`
- If you see `s32` in attributes causing int-to-float conversion instructions, it's likely wrong
- Use `ninja baseline` / `ninja changes_all` to verify type changes don't regress other functions
- Source: werewolf.zip, gelatart (2025-06-17-18)

### Mtx Type
- `Mtx` is a 3x4 matrix (not 3x3), called a TRS (Translation-Rotation-Scale) matrix
- It's a float array: `float Mtx[3][4]`
- Source: ribbanya (2025-06-22-23)

### Jump Input Type Enum
- Return value indicating jump type: 0 = none, 1 = stick, 2 = C-stick, 3 = button (X/Y)
- Stored at `fp+2344` in kneebend states
- Source: gigabowser, ribbanya (2025-06-28-30)

### HSD_SisLib Debug Font
- `hsd_8040FF80` is not a real relocation - it's a GXColor constant that dtk mistakenly turned into a reloc
- The 100KB+ data starting at `8040FF80` is actually font texture images for dev text (DVD error messages)
- `HSD_SisLib_8040CD40` is an array of 512-byte images passed to `GXInitTexObj`
- Source: rtburns, gamemasterplc, kellz (2025-06-09-15)

## Function-Specific Insights

### State Entry Function Naming
- Functions that initialize MotionState should be named with `_Enter` suffix
- Example: `ftCo_KneeBend_Enter` for entering KneeBend state
- Tilt turn vs smash turn use the same state (0x12/Turn) but different entry points
- State duration is set via `mv.x10`
- Source: gigabowser, altafen, ribbanya (2025-06-01)

### Static vs External Functions
- `fn_` prefix means the function "fell through naming cracks" - usually static/local functions
- If a function is called from another TU, remove `static` and add to header
- Use lower camelCase for static functions inside a file (e.g., `onEnter`)
- Address-based names (`fn_XXXXXXXX`) are temporary
- Source: ribbanya, gigabowser, altafen (2025-06-01)

### OSReport Stack Effects
- Changes to `OSReport` declaration can cause stack size changes in calling functions
- This caused issues during the extern/dolphin integration
- Functions calling `Player_CheckSlot` (which calls OSReport) were affected
- Source: werewolf.zip, rtburns (2025-06-02)

### AXSetVoiceMix Bug Fix
- DolSDK2001 had a bug: `src = (u16*)&mix;` (pointer to pointer)
- Melee's version has the correct: `src = (u16*)mix;`
- Source: werewolf.zip (2025-06-03)

### ftCo_800CBAC4 Inline Pattern
- This function gets inlined by many callers but also called directly from other files
- Solution: Mark it `inline` - the compiler decides whether to actually inline based on context
- Breaking it into smaller helper functions/inlines can help match
- Source: revosucks, gigabowser (2025-06-27)

## Tool Tips

### ninja Commands
- `ninja baseline` - Create baseline for comparison (run on master branch)
- `ninja changes` - Show functions that regressed
- `ninja changes_all` - Show both regressions AND improvements
- `ninja diff` - Compare built DOL against target
- `ninja apply` - Fix expected sizes in symbols.txt (causes churn with @1234 temporaries)
- Source: altafen, ribbanya (2025-06-01)

### Symbol Renaming
- Use `cargo run -rpq melee-replace-symbols` from `tools/replace-symbols`
- Takes pairs of `from:to` separated by whitespace
- Accepts console input or text file
- Updates symbols.txt, asm, docs, everything
- Source: ribbanya (2025-06-01)

### Context Issues and Solutions
- Pinned context in Discord has issues (OSContext not defined errors)
- Use `build/ctx.c` generated by ninja instead
- For decomp.py: Uses pcpp and is smarter about header smushing
- `decompctx.py` from dtk-template uses regex matching, not integrated well with M2CTX
- Source: rtburns, ribbanya (2025-06-29)

### dtk ISO/DOL Handling
- dtk can auto-extract main.dol from ISO/RVZ disc images
- Set `object_base` in config.yml, remove base path from every `object` value
- Use `dtk vfs` to extract main.dol manually
- Use `dtk shasum` to verify file hash
- boot.dol and main.dol are the same - just rename if needed
- Source: encounter, kooshnoo (2025-06-18)

### objdiff Setup
- ninja must be in PATH for objdiff to work
- Windows: Add ninja.exe location to system PATH via Environment Variables
- Don't forget to actually implement the function locally before checking objdiff!
- Source: altafen, gelatart (2025-06-24)

### Missing Relocations in dtk
- dtk can miss relocations, causing hardcoded `bl` calls that break shiftability
- Use `add_relocations` in config.yml to fix missed relocs
- Example shows 75+ broken `bl -0x` calls in one file
- Check `config.yml.example` in dtk-template for syntax
- Can be scripted with regex patterns to generate the yml
- Source: rtburns, encounter (2025-06-05)

### Shiftability Testing
- Add shift code and move it later in linking order until issues appear
- Shift code example:
```c
void shift() {
    *(volatile int *)0 = 0; // repeat several times
}
```
- "Boot to CSS" gekko code modifications can verify shiftability
- Source: revosucks (2025-06-24)

### -sym on in decomp.me
- Enable `-sym on` in scratch Options to show approximate line numbers of the asm
- Helps correlate source lines with generated assembly
- Source: bbr0n (2025-06-17)

### m2c Local Usage
- `m2c --valid-syntax --stack-structs` generates compilable code with M2C macros
- Outputs struct guesses that can be included back into context and iterated
- Source: ribbanya (2025-06-24)

## Git Workflow

### Fork Sync Issues
- Don't commit to master on your fork - it will diverge from upstream
- Use feature branches instead
- If diverged: `git reset --soft upstream/master`, then commit, then force push
- Or: `git reset --hard upstream/master` (loses local changes!)
- Source: clownssbm, ribbanya, kooshnoo (2025-06-28)

### Feature Branch Workflow
1. Create local branch tracking `doldecomp/melee:master`
2. Pull to get upstream changes
3. Create feature branch for your work
4. Make changes and PR
5. Delete feature branch after merge
6. Repeat
- Source: ribbanya, clownssbm (2025-06-28)

### CI Checks
- ninja is what CI uses - run locally to verify
- Can push to your fork to run checks before opening PR to upstream
- Draft PRs also trigger checks
- Source: rtburns, ribbanya (2025-06-22)

## Pitfalls and Gotchas

### AT_ADDRESS Macro for hw_regs
- `volatile u16 __VIRegs[59] : 0xCC002000;` syntax causes decomp.py syntax errors
- Use `AT_ADDRESS` macro instead for m2c compatibility
- Source: mr.grillo, werewolf.zip, rtburns (2025-06-03)

### Wrong Union Member
- Using the wrong character's union member (e.g., Captain Falcon instead of Sheik) can appear to match better
- This indicates the correct union member needs its types fixed to match the "wrong" one
- Always use the semantically correct union member
- Source: ribbanya, gelatart (2025-06-21)

### Headers in extern/ Not Triggering Rebuilds
- ninja wasn't seeing changes to headers in `extern/` directory
- Fixed by switching from `-i` includes to `-I` includes
- System includes don't get added to dep files
- Source: rtburns, ribbanya (2025-06-03)

### m2c Generating Extra Casts
- m2c generates `(Fighter_GObj*)` casts that should be removed when committing
- These casts can cause stack/register differences
- The actual repo code should not have these casts
- Source: revosucks, rtburns (2025-06-26)

### Scratches Matching on decomp.me but Not Locally
- Usually a missing `#include` in the local file
- decomp.me context has every header, but locally you must include manually
- Calling undeclared functions causes implicit int return assumption
- Source: rtburns (2025-06-19)

### Items are More Than Pickups
- "Item" in code refers to fighter accessories too: Fox's laser, Link's arrows, G&W's bucket
- Many item functions are callbacks accessed indirectly via state tables
- Source: rtburns, werewolf.zip (2025-06-17-18)

## Progress and Milestones

### June 2025 Progress
- Started at ~28% matched
- Ended at ~29% matched
- 67 trophies collected (from 59)
- 10 event matches
- extern/dolphin merged (PR #1559)
- AX, AXFX matched
- Several character files progressed (Sheik, Yoshi, G&W items)
- Source: werewolf.zip, revosucks (various dates)

### Playable Build Progress
- Most of sysdolphin is functional (regswaps or matched)
- Missing: audio, bytecode stuff
- `resolveCnsOrientation` can be stubbed as `return;` for basic functionality
- Text rendering has shiftability issues causing visual glitches
- mncharsel has gnarly functions - might be worth bypassing initially
- Source: werewolf.zip, rtburns, revosucks (2025-06-24)

## Resources

### Documentation Links
- Getting started guide: https://doldecomp.github.io/melee/getting_started.html
- foxcam's guide (pinned): https://gist.github.com/thefoxcam/678c9fa9050651e5f8a3aeedb2cf87e0
- decomp wiki intro: https://wiki.decomp.dev/en/resources/decomp-intro
- State tables glossary: https://wiki.decomp.dev/en/resources/decomp-glossary#state-tables-for-items-and-stages
- cdecl.org - C declaration parser/explainer
- mwcc-debugger: https://github.com/cadmic/mwcc-debugger

### AI Tools for Decompilation
- ChatGPT is trained on the existing codebase - useful for already-matched functions
- Gemini can annotate asm lines decently as a learning aid
- No good AI decompiler exists yet - would need training on compiler IR
- PowerPC instructions can be explained by asking about MIPS (similar enough)
- Source: werewolf.zip, allocsb, revosucks, ribbanya (2025-06-24)
