# Decompilation Knowledge: June 2022

## Compiler Patterns

### Float Literal Precision Issues
- When using float literals, the compiler may choose slightly different hex representations
- Example: `1.0472f` generates `0x3F860AA6` instead of expected `0x3F860A92`
- Solution: Use mathematical expressions like `M_PI/3` to get exact values, or find exact decimal precision
- If two floats with similar values appear, check if another function uses that constant
- Source: nic6372, amber_0714, revosucks (2022-06-05)

### Peephole Optimization Bug (MWCC 1.0-1.2.5)
- After an inline/asm function, peephole optimizations are disabled for the rest of the file
- This causes `bnelr` to become `bne + b` (separate instructions)
- Workaround: Use `#pragma peephole off` before affected functions, or `#pragma peephole on` after asm functions
- Fixed in compiler versions 1.3.2-2.7
- Source: revosucks, ninji, epochflame (2022-06-17)

```c
// peephole is on for this
void blahblah() { }

asm blahasmblah() {
    nop
}

// oops! peephole is off now for rest of file
void blahblah2() { }
```

### Inline Auto Depth
- `-inline auto` tends to inline 3 levels deep by default
- Can be controlled with `-inline auto,level=N` where N is 1-8
- The depth is not strictly fixed - compiler uses heuristics
- If inline depth is exceeded, the compiler may emit a standalone function even for code marked `inline`
- Source: revosucks (2022-06-18, 2022-06-28)

### Volatile Stack Reservation Trick
- Using `volatile s32` can force stack reservation when needed
- May indicate the struct field being accessed is itself volatile
- Example: `fighter->x2070_int` might actually be volatile in the original code
- Source: snuffysasa, revosucks (2022-06-20)

### Const Stack Consolidation
- Using `const` on local variables helps the compiler consolidate stack locations
- Useful for clearing vectors: `const float c = 0.0f;` then assign to multiple struct members
- Source: revosucks (2022-06-30)

### Integer to Float Conversion Assembly
- The compiler converts u32 to double using magic constants:
- `double v = *(double*)&(0x43300000_00000000 | val ^ 0x80000000) - *(double*)&43300000_80000000`
- This generates lengthy assembly that looks unusual
- Source: revosucks (2022-06-25)

## Matching Techniques

### Register Swap Solutions

#### Using Inline Functions
- Inline functions for getting data pointers can fix register allocation:
```c
inline Item* GetItemData(HSD_GObj* item_gobj) {
    return item_gobj->user_data;
}

inline HSD_JObj* GetItemJObj(HSD_GObj* item_gobj) {
    return item_gobj->hsd_obj;
}

// Combined inline for setting both pointers
inline void SetPointers(HSD_GObj* item_gobj, HSD_JObj** item_jobj, Item** item_data) {
    *item_jobj = GetItemJObj(item_gobj);
    *item_data = GetItemData(item_gobj);
}
```
- Source: revosucks (2022-06-11)

#### Void Cast Trick
- Casting return values to void can change stack allocation:
```c
inline HSD_JObj *getHSDJObj(HSD_GObj* hsd_gobj) {
    HSD_JObj *hsd_jobj = hsd_gobj->hsd_obj;
    return (void *)hsd_jobj;  // void cast affects codegen
}
```
- Source: revosucks (2022-06-18)

### Float Comparison Without Suffix
- For float comparisons, sometimes omitting the `f` suffix matches better:
```c
// This might not match:
if (item_data->xD3C_spinSpeed != 0.0f)

// Try this instead:
if (item_data->xD3C_spinSpeed != 0.0)
```
- Source: vetroidmania, revosucks (2022-06-11)

### Stack Filler Reduction with Macros
- Repetitive stick assignments can use macros to reduce fake filler:
```c
#define SET_STICKS(stickXPtr, stickYPtr, x, y) \
    do { \
        f32 *stickX = &stickXPtr; \
        f32 *stickY = &stickYPtr; \
        *stickX = x; \
        *stickY = y; \
    } while(0)
```
- Each use of this macro saves ~2 words of filler
- Source: revosucks (2022-06-24)

### Backward Store Chains
- Backward stores (z then y then x) indicate chain assignment:
```c
// Assembly shows: stw z, stw y, stw x (backwards)
// C code is:
fighter->x74_anim_vel.x = fighter->x74_anim_vel.y = fighter->x74_anim_vel.z = 0;
```
- Source: revosucks (2022-06-24)

### Switch Statement Patterns
- Optimized switch blocks can be tricky - branches past the function end indicate unusual structure
- Sometimes a switch appears as nested if/else with specific comparison order
- Example: Check `>= 3` first, then `== 0`, then handle remaining cases
- Source: chippy__, vetroidmania, amber_0714 (2022-06-16, 2022-06-21)

### Function Argument Ordering with Floats
- Floats use FPRs, integers use GPRs - they can be freely reordered in declarations
- Changing float position in signature doesn't break functional equivalence
- BUT it can affect evaluation/load order of arguments:
```c
// These are called identically:
void func(int x, float y, int z);
void func(int x, int z, float y);
// Both result in: r3=x, r4=z, f1=y

// BUT evaluation order differs - check for mismatched loads before calls
```
- Source: kiwidev (2022-06-15)

### Comma Operator in For Loops
- Use comma operator to increment multiple variables:
```c
for (i = 0; i < count; i++, dynamicBones++) {
    // ...
}
```
- The comma operator evaluates left to right, returns rightmost value
- Source: kiwidev, gibhaltmannkill (2022-06-15)

### Identifying Inlined Code
- Look for "variable hoisting" - vars initialized at scope start but used much later
- Repeated code patterns across scopes often indicate inlined static functions
- "One is an anomaly, two is a coincidence, three is a pattern"
- Move repeated patterns to their own static functions and let the compiler inline them
- Source: revosucks (2022-06-15, 2022-06-18)

## Type Information

### Fighter Struct
- `x2C_facing_direction` - facing direction
- `xE0_ground_or_air` - ground/air state (HAL's original name based on symbols)
- `x1A5C` - GObj pointer for linked hitlag partner
- `x2070_int` - may be volatile
- `x68C` through `x6B0` - possibly an AnimPose/SRT/Transform structure

### Small Data Sections (sdata/sdata2)
- GPR13 points to SDA (+0x8000)
- GPR2 points to SDA2 (+0x8000)
- Variables < 8 bytes typically go in sdata/sdata2
- Single floats may be aligned with padding when following integers
- Source: gibhaltmannkill (2022-06-29)

### Bitfield Ordering
- The type of bitfield (`u8 x0: 1`) matters for generated instructions
- `lwz`/`lhz`/`lbz` selection depends on bitfield type and span
- Source: altafen (2022-06-04)

## Function-Specific Insights

### getFighter() Paradox
- Some functions in fighter.c require `getFighter()` inline, others break with it
- The lower half of fighter.c may have been written by a different programmer
- Two programmers credited with "Player programming" in Melee credits
- Source: revosucks (2022-06-20, 2022-06-24)

### Fighter_UpdateModelScale
- Requires multiple nested inlines: getFighter, getHSDJObj, Fighter_InitScale, HSD_JObjSetScale
- HSD_JObjSetScale calls HSD_JObjSetMtxDirty which calls HSD_JObjMtxIsDirty
- Inline depth limits cause issues - may need manual inlining
- Source: revosucks (2022-06-18, 2022-06-28)

### HSD JObj Inlines
- Most HSD inlines have asserts at their start
- `HSD_JObjSetMtxDirty` is the exception - no assert
- `HSD_JObjMtxIsDirty` definitely exists as inline (high usage)
- JObj's mtx callback struct changed between sysdolphin versions
- Source: werewolf.zip, revosucks (2022-06-26, 2022-06-28)

### OSReport Strings
- OSReport strings go in .rodata section
- If leaving strings in .s file causes duplication, use extern labels instead
- Source: vetroidmania, epochflame (2022-06-19)

## Tool Tips

### decomp.me Updates (June 2022)
- Small data relocations no longer penalize scores - 100% match shows score 0
- Click a register to highlight all usages of that register
- Symbol consistency checking added - flags when @N refers to different labels
- Matching external data shows blue inline markers but white line text
- Source: snuffysasa (2022-06-03, 2022-06-11, 2022-06-12)

### asm-differ
- Run with `--debug` flag for detailed scoring information
- Scoring issues can sometimes be asm-differ bugs, not code issues
- Some "white" (matching) lines may actually have differences - inspect carefully
- Source: snuffysasa (2022-06-10, 2022-06-11)

### Permuter
- Doesn't work with `?` placeholder types from decompiler - replace with actual types
- Variable function calls can cause issues - comment out errors
- Use `PERM_RANDOMIZE()` macro for targeted permutation
- Check `compile.sh` paths in nonmatching folder if permuter fails
- Source: snuffysasa, vetroidmania (2022-06-07, 2022-06-10, 2022-06-21)

### Build System
- Redirect errors to file: `make GENERATE_MAP=1 2> error.txt` or `&>` for all output
- Use `MAX_ERRORS=1` to limit error output
- Check link map (GALE01.map) to find which function uses a specific float
- Float labels like `@79` can be searched in linkmap to find source function
- Source: gibhaltmannkill, altafen (2022-06-15, 2022-06-06)

### Frank (Compiler Patch)
- Frank combines 1.2.5e with 1.2.5 compiler output for prologue/epilogue ordering
- Using `-g` (debug info) effectively disables Frank's modifications
- Some optimized switch statements break Frank - branches past function end
- Known to have edge cases that produce incorrect output
- Source: kiwidev, epochflame, amber_0714 (2022-06-21, 2022-06-24)

### Dolphin Debugging
- Use breakpoints to find runtime values for .bss labels
- Check pointer values in unknown structs by inspecting at runtime
- Source: nic6372 (2022-06-13)

## Pitfalls and Gotchas

### Duplicate Float Generation
- If compiler generates two floats instead of one, another function likely uses that value
- Check all uses of a float constant across the entire file
- Source: nic6372, altafen, revosucks (2022-06-05, 2022-06-06)

### Relocation Errors
- "Relocation of symbol is out of range" - check if array size/type is correct
- Invalid target ASM can cause cryptic relocation errors
- Source: glazedgoose (2022-06-12)

### Symbol Map Shifting
- Functions blending into others in symbol map indicates size mismatch
- Usually caused by unexpected inlining or missing code elsewhere
- Source: vetroidmania (2022-06-23)

### Fake Variables from m2c
- m2c creates many pointless variables - remove as many as possible
- Getting code to compile first, then reduce variables
- Source: camthesaxman, revosucks (2022-06-30)

### Copy-Paste Bugs in Original Code
- Original HAL code contains copy-paste bugs:
```c
pAtkShieldKB->x = p_kb_vel->y = 0;  // Bug: should be pAtkShieldKB->y
```
- Tired programmers, small screens, 3am coding - bugs happen
- Source: revosucks (2022-06-24)

### File Splitting for Float Allocation
- Floats are generated per C file
- If original DOL has multiple copies of same float value, functions must be in separate files
- Split functions based on which float labels they use
- Source: vetroidmania, nic6372 (2022-06-05)

### ActionStateChange Flags
- 32-bit flag values like `0x0C4C5080` are typically ORed constants:
```c
#define FLAG_A (1 << 7)
#define FLAG_B (1 << 14)
// ...
func(FLAG_A | FLAG_B | FLAG_C | ...)
```
- Source: ninji, vetroidmania (2022-06-28)

## Progress Notes

### June 2022 Milestones
- June 15: Reached 7% code sections (272,316 / 3,882,272 bytes)
- June 19: Trophy count reached 21 of 290
- June 20: Reached 7.45% code sections (289,364 bytes)
- ftMario completed and PR submitted (nic6372)
- Major fighter.c cleanup pass begun (revosucks)
- item.c files progressing (vetroidmania)

### Active Contributors
- snuffysasa: decomp.me/asm-differ development, permuter support
- revosucks: fighter.c cleanup, inline discovery
- vetroidmania: item.c, ftNess work
- nic6372: ftMario completion
- altafen: general matching help
- kiwidev: switch matching, argument ordering insights
- amber_0714: optimized switch blocks, item IDs
- chippy__: switch matching
