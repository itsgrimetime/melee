# Decompilation Knowledge: 2023-03

## Compiler Patterns

### Stack Usage with Vec Parameters
- Functions taking `Vec` by value (instead of pointer) can cause unpredictable stack copies
- Fix: Change parameter type from `Vec` to `Vec*` to eliminate stack copies
- Example: `void HSD_CObjSetInterest(HSD_CObj*, Vec);` should be `void HSD_CObjSetInterest(HSD_CObj*, Vec*);`
- Source: chippy__ (2023-03-03)

### Static Function Removal with Inline Auto
- When using `-inline auto`, static functions may get always inlined and subsequently removed by the linker
- The linker knows nothing else can call a static function, so it optimizes away the non-inlined version
- Removing `static` can cause DOL mismatch because the linker preserves the function thinking another file might call it
- Workaround: If a function was static, keep it static or explicitly mark it `inline`
- Source: revosucks (2023-03-15)

### Bitfield Member Size Convention
- HAL used `u32` as the standard bitfield member size in SSB (Smash 64)
- Example: `u32 : 1` instead of other integer types
- This convention likely carries over to Melee
- Bitfield ordering is compiler-defined and can differ between compilers on the same platform
- Source: vetroidmania (2023-03-29)

### DWARF Type Information from HSD
- HSD library has DWARF debug information that reveals:
  - `enum_t` in Update functions should actually be `unsigned int`
  - `HSD_ObjData` was originally named `FObjData`
  - Whether types are actual enums vs integers compared against enum values
- Source: werewolf.zip (2023-03-15)

## Matching Techniques

### GET_FIGHTER Macro Pattern
- The `GET_FIGHTER(gobj)` macro (expanding to `((Fighter*)HSD_GObjGetUserData(gobj))`) fixes fake stack allocations in "probably hundreds" of functions
- This pattern extends to `GET_ITEM(gobj)` and `GET_GROUND(gobj)`
- In short functions, replacing `gobj->user_data` with `GET_FIGHTER(gobj)` typically won't cause mismatches
- Direct access from return value (`GET_FIGHTER(gobj)->some_var`) is valid and HAL likely used this pattern for laziness/efficiency
- Source: revosucks, ribbanya (2023-03-18)

### User Data Direct Casts
- HAL used direct `user_data` casts rather than assigning to local variables
- Evidence from Smash 64: functions won't match if you declare a local variable for `article_gobj->user_data`
- This is confirmed by IDO's strict codegen which allows fewer permutations than MWCC
- Source: vetroidmania (2023-03-09)

### Small Data Access in Assembly
- For assembly with labels like `lfs f1, lbl_804DE210(r2)`, decomp.me requires SDA21 syntax
- Convert to: `lfs f1, lbl_804DE210@sda21(r2)`
- Generally all small data accesses (r2/r13) can use `@sda21` but GNU assembler still requires the register
- Source: kiwidev, encounter (2023-03-21)

### Handling Missing Return Statements (UB)
- Some functions have undefined behavior with no return statement on all paths
- If the function always reaches a return (via loop), there may be no UB in practice
- A trailing `return` without a result can generate an extra `mr` instruction causing mismatch
- Workaround using `MUST_MATCH` define:
```c
HSD_LObj* func_8000CDC0(HSD_LObj* cur) {
    while (cur != NULL) {
        if (FLAGS_NONE(cur->flags, (1 << 0) | (1 << 1)) &&
            FLAGS_NONE(HSD_LObjGetFlags(cur), 1 << 5))
        {
            return cur;
        }
        cur = lobj_next(cur);
    }
#ifndef MUST_MATCH
    return NULL;
#endif
}
```
- Adding `NORETURN` to `__assert`, `HSD_Panic`, and `OSPanic` solves other UB errors without affecting codegen
- Source: rtburns, ribbanya (2023-03-15)

## Type Information

### Fighter Struct Naming
- `x2D4` - Read-only file pointer to character-specific attributes (move attrs, special attrs)
- `x222C` - Renamed to `FighterVars` - mutable character-specific persistent variables
- `x2340` - Renamed to `MotionVars` - action state-specific variables (previously StateVars)
- `x222C` can contain dynamic pointers to GObjs (e.g., Mario's cape reference)
- Source: vetroidmania, ribbanya, werewolf.zip (2023-03-20)

### HAL Naming Conventions from Smash 64
- `mstat` = motion status (action_state_index)
- `ga` = ground_or_air (changed to full name in Melee)
- `lr` = facing direction (-1 left, 1 right) - used for multiplying velocity
- `gp` = ground pointer (Ground *gp)
- `Ground_Struct` - struct naming convention uses `_Struct` suffix
- States are called "motions" internally: `"don't have smash42 motion!!!"`
- Source: vetroidmania (2023-03-06, 2023-03-12, 2023-03-20)

### Proc Callback Naming (from Smash 64)
- proc update = animation callback
- proc map = collision callback
- proc hit = item deals damage to hurtbox
- proc shield = item gets blocked
- proc hop = item bounces off shield
- proc setoff = item collides with an attack
- proc reflector = reflection callback
- proc damage = item gets hit
- Source: vetroidmania (2023-03-06)

### Item vs Fighter Variable Patterns
- Items: Single state vars struct shared across all action states (ItemVars)
- Fighters: Separate structs per action state, plus persistent FighterVars
- Pokemon are items and follow item conventions
- Ground/stages: Have GroundVars (non-volatile)
- Source: vetroidmania (2023-03-20)

### GObj Class Indices
- Class 5 is unused/missing - likely a leftover from Smash 64 where it represented "projectiles"
- Class 6 corresponds to items (Melee unified projectiles under items)
- Source: vetroidmania (2023-03-06)

### Smash 64 to Melee Similarities
- Default item lifetime: 1400 frames in both games
- Reflector damage threshold: 100 damage cap in both games
- Hitbox detection is similar
- Many architectural patterns carried over due to 1-year dev timeline
- Melee likely used defines for HSD obj layer stuff that became inlines
- Source: vetroidmania (2023-03-06, 2023-03-09)

### Module Abbreviations
- `gm` = game (main program, game modes)
- `mp` = map (specifically collision-related)
- `mpcoll` = map collision
- Source: vetroidmania, ribbanya (2023-03-12)

## Function-Specific Insights

### TExp Functions
- Functions like `HSD_TExpColorIn`, `HSD_TExpAlphaOp`, `HSD_TExpAlphaIn` have type aliasing issues
- Sometimes last parameter is a pointer, sometimes it's `HSD_TEXP_RAS` (-1)
- Uses "ghetto type aliasing" with `HSD_TExpGetType`
- Branch with more matches: https://github.com/doldecomp/melee/compare/master...PsiLupan:melee:texp-match
- Source: werewolf.zip (2023-03-15)

### Update Function Signatures
- `MObjUpdateFunc` and similar should use `unsigned int` for type parameter, not `enum_t`
- These are called through function pointers so they don't get inlined
- Source: werewolf.zip (2023-03-15)

### Special Attrs Access Pattern Issue
- The special attrs at offset 0x2D4 sometimes behave unexpectedly
- Hypothesis: May be a union in original HAL code but we're using casts
- `getFtSpecialAttrsD` matches more often than the non-D variant (which may be a fake function)
- Finding smallest functions that demonstrate the issue helps narrow down the fix
- Source: revosucks, ribbanya (2023-03-18, 2023-03-19)

## Tool Tips

### Wibo for Faster Compilation
- Using wibo instead of wine for compiling makes objdiff "instantaneous"
- Wibo is a lightweight Windows binary compatibility layer
- Docker + wibo is a potential option for macOS users
- Source: ribbanya (2023-03-01)

### Docker Build Environment
- Prime Decomp's setup: https://github.com/PrimeDecomp/build
- Can host Docker images on GitHub Container Registry
- Image size matters less than setup time - GitHub hosts and downloads it
- For minimal images: start with alpine/debian-slim and copy only needed binaries
- Use ninja instead of make for faster Windows builds
- Source: encounter, ribbanya (2023-03-01)

### Lima VM for macOS
- https://github.com/lima-vm/lima is better than Docker on Mac for Linux VMs
- Docker on Mac runs a Linux VM anyway
- Source: encounter (2023-03-01)

### dadosod for ASM Extraction
- Tool for dumping functions in proper format: https://github.com/InusualZ/dadosod
- Dumps entire DOL, then search for specific function
- Preserves symbols when used with build system
- Source: ribbanya (2023-03-21)

### Submitting Matches Without Git
1. Find function (pinned ASM zip or Trello board)
2. Get context from https://doldecomp.github.io/melee/ctx.html
3. Create scratch on decomp.me
4. Submit GitHub issue with decomp.me link
5. Maintainers will add the code
- Partial functions are acceptable submissions
- Source: ribbanya (2023-03-28)

### Vim/Neovim Config for Melee
```vim
function! MeleeProjectSetup()
  let project_root = "/path/to/melee"
  let project_vimrc = project_root . "/tools/vimrc"
  if expand('%:p:h') =~ project_root
    execute "source " . project_vimrc
  endif
endfunction

augroup MeleeProject
  autocmd!
  autocmd DirChanged,BufRead,BufEnter * call MeleeProjectSetup()
augroup END
```
Source: ribbanya (2023-03-22)

## Pitfalls and Gotchas

### Gotos in Nested Loops
- Using gotos to break out of nested loop conditions is sometimes inevitable
- Java's `break label;` accomplishes the same thing
- Some functions can be refactored to use a helper function returning bool instead
- Note: IDO (N64) doesn't recognize the bool type
- Source: werewolf.zip, ribbanya (2023-03-05)

### enum_t Usage
- `enum_t` is just `int` for unknown enums
- Using it where DWARF says `unsigned int` may cause future matching issues
- Even if wrong, you can cast to `(unsigned)` at usage sites
- Source: werewolf.zip, ribbanya (2023-03-11, 2023-03-15)

### Mass Function Renaming
- Renaming functions can be painful for anyone with WIP branches
- Suggestion: Only rename when preliminary matching C code exists
- File splits may not be finalized anyway
- Counter: Modern git tooling can handle merge conflicts
- Source: rtburns, ribbanya (2023-03-22)

### Inline Fake Functions
- Some functions that look like copy-paste are actually MWCC inlining
- Example: Ness yoyo setup appeared to be duplicated but was an inline
- Source: vetroidmania (2023-03-18)

### IDO Strictness vs MWCC Flexibility
- IDO (Smash 64 compiler) creates register swaps for minor discrepancies
- MWCC has many more permutations that result in identical code
- Example: A single redundant `else` on a return caused IDO to switch from stack vars to saved registers
- IDO also quietly casts `(var)` and `(!var)` as `u32`
- Source: vetroidmania (2023-03-09, 2023-03-29)

## Infrastructure Notes

### Progress API
- Progress tracking is a decompals service
- API key needed for integration
- Project slug: `melee`
- Source: encounter, ethteck (2023-03-31)

### Build System
- GitHub Actions = Azure Pipelines (shared Azure instances)
- Windows jobs likely run in VMs for sandboxing
- Docker images cached: https://github.com/actions/runner-images/blob/main/images/linux/Ubuntu2204-Readme.md#cached-docker-images
- Source: ribbanya, werewolf.zip (2023-03-01)

## Historical Context

### Dantarion's Naming
- Called 0x2D4 attributes "Article Floating Points" based on Brawl structure
- Historical reference: https://web.archive.org/web/20200210183610/http://opensa.dantarion.com/wiki/Article_Floating_Points_(Melee)
- "Special" naming came from how Brawl was organized
- Source: werewolf.zip (2023-03-20)

### Menu Music RNG
- Alternate menu theme: 1/4 chance (feels like 1/50)
- Paused game music: 20% of normal volume
- Source: vetroidmania, drl (2023-03-20, 2023-03-23)
