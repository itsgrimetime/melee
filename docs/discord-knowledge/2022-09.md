# Decompilation Knowledge: 2022-09

This document distills valuable decompilation knowledge from the #smash-bros-melee Discord channel during September 2022.

## Compiler Patterns

### Peephole Optimization and ASM Functions
- If there's an `asm{}` function above a C function in the same file, the peephole optimizer behavior changes
- Solution: Use `#pragma peephole off` after the asm function
- The pragma applies to subsequent functions in the file
- Source: revosucks (2022-09-03)

Example:
```c
// there's a hecking asm{} function above this one...
#pragma peephole off

int lbl_8038815C(s32 arg0, s32 arg1, s32* arg2, s32 arg3) {
    if (lbl_804D7710 != NULL) {
        lbl_804D7710(arg1, *arg2);
    }
    lbl_804D7718(arg0, arg1, arg2, arg3);
    return 0;
}
```

### Float Literal Merging
- MWCC won't merge `0.5` with `0.5L` - they get separate addresses in sdata2
- `0.5L` is `long double` (128-bit), `0.5` is `double` (64-bit)
- This can be problematic with inlines like `sqrtf` that use float constants
- Recommendation: Hold off on using the `L` suffix everywhere
- Source: rtburns, gibhaltmannkill (2022-09-03)

### Register Usage for SDA Access
- GPR13 is used for SDA (mutable small data)
- GPR2 is used for SDA2 (constant small data)
- Variables use r13 when: not constant, declared outside of a function
- Static variables still end up in normal sdata
- Source: seekyct, gibhaltmannkill (2022-09-03)

### Variadic Functions and crclr
- Variadic functions need `crclr` instructions to indicate if float arguments were passed
- If you see unexpected `crclr` instructions, declare the function prototype as variadic
- Source: kiwidev, gibhaltmannkill (2022-09-03)

### Branch Hint Bits
- Gekko has branch hint bits (+/-) in conditional branch instructions
- `bdnz+, bne+, beq+, blt+` are used in loops (positive = likely taken, negative offset)
- However, Gekko doesn't actually support branch hints - they have no effect on the branch predictor
- CW doesn't set the branch hint bits; the +/- suffix just indicates branch direction
- Source: encounter, vetroidmania, gibhaltmannkill (2022-09-18-19)

### Instruction Scheduling
- PPC 750/Gekko can run six instructions simultaneously
- Has branch prediction and out-of-order execution capabilities
- The 1.2.5e compiler patch involves epilogue scheduling issues
- `lmw` instruction ordering in epilogues is inconsistent
- Source: encounter, camthesaxman (2022-09-14-18)

## Matching Techniques

### HSD_JObjSetMtxDirty - Inline vs Define
- Evidence suggests `HSD_JObjSetMtxDirty` should be a **define**, not an inline function in Melee's version
- Using a define fixes the fighter.c inline problem and other functions
- `HSD_JObjSetupMatrix` appears to be a real inline
- This may be a leftover from an earlier sysdolphin version where macros were defines instead of inlines
- Source: revosucks (2022-09-03, 2022-09-10)

Define version that works:
```c
#define HSD_JObjSetMtxDirty(jobj)                       \
{                                                       \
    if (jobj != NULL && !HSD_JObjMtxIsDirty(jobj)) {    \
        HSD_JObjSetMtxDirtySub(jobj);                   \
    }                                                   \
}
```

### Fighter Pointer Initialization Patterns
Three common patterns for fighter pointer initialization:
1. `fp = gobj->user_data`
2. `fp = getFighter(gobj)`
3. `fp = fp = getFighter(gobj)` (double assignment)

Sometimes also: `fp = fp = gobj->user_data`

The double assignment pattern is needed for certain register allocation behaviors.
- Source: revosucks (2022-09-24)

### Float Constant Sharing Between ASM and C
- For functions mixing ASM and C that need to share float constants:
  1. Inline the float in C
  2. Put a `.set lbl_DEADBABE` in a .s file pointing to the offset of the inlined float
  3. Use `extern f32 lbl_DEADBABE;`
- This allows C functions to use the inlined float while ASM functions secretly also use it
- Source: ribbanya (2022-09-01)

### Inline ASM Data Access
- Keep `@ha` / `@l` suffixes when accessing labels that are too large for single instruction loading
- Only remove `@sda21` suffixes when converting to inline asm
- Arrays with explicit size `[32]` can cause linker errors; use `extern u8 lbl_xxx[];` instead
- Source: rtburns (2022-09-15)

Example declarations that work:
```c
extern u8 lbl_803B75C0[];
extern f32 lbl_804D9A28;
```

### Static Callbacks
- Static callback functions don't need `.global` in assembly
- Whether a symbol is local/global doesn't affect the resulting bits in the DOL
- Use `static` in C to force file-local, but it typically doesn't affect codegen
- Source: encounter, altafen (2022-09-19)

## Type Information

### OSContext Size
- OSContext struct is 0x2C8 bytes
- Some files have padding after OSContext in .bss that gets stripped
- May need `#pragma force_active on` or FORCEACTIVE in LCF for unused data
- Source: revosucks (2022-09-03)

### HSD Object Inlines
The `ref_INC` inline (or similar name):
```c
inline void incref(void* o)
{
    if (o != NULL) {
        HSD_OBJ(o)->ref_count++;
        if (!(HSD_OBJ(o)->ref_count != (u16) -1)) {
            __assert("object.h", 0x5D, "HSD_OBJ(o)->ref_count != HSD_OBJ_NOREF");
        }
    }
}
```
- Source: rtburns (2022-09-02)

### JObj Assert Inlines
JObj header has many inlines with asserts. These generate separate strings for each translation unit where they're included:
- `"jobj.h"` and line numbers appear repeatedly in rodata
- Each macro call is an assert usage
- The scale assert at line 761 gets removed by compiler when it knows value is always true
- Source: revosucks, ribbanya (2022-09-02)

### Vec/Vec3/Point3d Consolidation
- `Vec3` is in `common_structs`
- `Vec` is in `mtxtypes`
- Should be consolidated to mtxtypes following Dolphin SDK style
- Note: HSD has `HSD_VecAlloc` and `HSD_MtxAlloc` with separate HSD_Mtx44 types
- Source: rtburns, ribbanya, werewolf.zip (2022-09-04)

### GXColor Literals
- Some data labels like `lbl_804DE200` might be GXColor literals
- Source: rtburns (2022-09-05)

## Function-Specific Insights

### debug.c Functions
- Contains 4 functions including `__assert` and `HSD_Panic`
- First function requires `#pragma peephole off` due to stripped asm function above it
- Has a stripped/stubbed asm function that affects peephole behavior
- Contains unused symbol `lbl_804C28D0[0x10]` that requires FORCEACTIVE in LCF
- Source: revosucks (2022-09-03)

```c
void __assert(char* str, u32 arg1, char* arg2) {
    OSReport("assertion \"%s\" failed", arg2);
    HSD_Panic(str, arg1, &lbl_804D6010);
}
```

### HSD_TevExpFreeList Typo
Original code has a bug - duplicate check instead of checking both fields:
```c
// Bugged original:
if (ptr->tev.c_ref == 0 && ptr->tev.c_ref == 0) {
// Should be:
if (ptr->tev.c_ref == 0 && ptr->tev.a_ref == 0) {
```
- Source: werewolf.zip (2022-09-14)

### OSRestoreInterrupts SDK Bug
- In Melee's SDK version, OSRestoreInterrupts has a bug where it returns the value in r4 instead of r3
- Fixed in later SDK versions (1.2+)
- Nothing uses the return value of RestoreInterrupts, so it doesn't cause issues
- Source: werewolf.zip, shibboleet (2022-09-06)

```asm
/* Melee's bugged version: */
/* 803473A8 */ rlwinm r4, r4, 0x11, 0x1f, 0x1f
/* Should use r3 for return value */
```

### assert2 Macro
Pattern for assert with message:
```c
assert2(tobj_toon, ("cannot allocate tobj for toon."));
```
- Source: werewolf.zip (2022-09-14)

### Fighter GObj Naming Convention
- Use `fighter_gobj` (snake_case) not `fighterObj` (camelCase)
- Based on leftover asserts and OSReports showing `item_gobj` pattern for items
- Source: vetroidmania (2022-09-01)

## Tool Tips

### dadosod Usage
- Use release mode for significantly better performance: `cargo b -r`
- Works natively on Linux, can use wibo on Windows
- Needs map.csv from `python tools/parse_map.py`
- Can dump DOL to structured ASM with symbol names
- Source: ribbanya (2022-09-01, 2022-09-12)

### Comparing DOL Output
Workflow for checking if your function matches:
1. Build :ok: branch (master) with `./build.sh -lfme`
2. Switch to your branch
3. Build your branch (`./build.sh -lfm -r ifstatus`)
4. `python tools/parse_map.py`
5. `dadosod.exe dol expected/build/ssbm.us.1.2/main.dol -m build/map.csv`
6. `dadosod.exe dol build/ssbm.us.1.2/main.dol -m build/map.csv`
7. Compare the output
- Source: ribbanya (2022-09-03)

### asm-differ Usage
```bash
python tools/asm-differ/diff.py -wos func_name
```
Shows assembly comparison for a function.
- Source: ribbanya (2022-09-03)

### calcprogress Updates
- New calcprogress parses by TUs (translation units) not by symbols
- Use `--asm-obj-ext=.s.o` and `--old-map=true` flags for Melee
- Requires Python 3.9+ for lowercase type hints like `dict[str, ...]`
- Progress dropped from ~14% to ~12% when properly excluding inline asm
- Source: kiwidev, ribbanya (2022-09-02, 2022-09-04)

### objdiff Reference
- https://github.com/encounter/objdiff - useful reference for diffing tools
- Source: encounter (2022-09-14)

### Windows stdout Performance
- stdout is slower when the window is visible
- Minimizing the terminal window makes long-running processes faster
- This is a known Windows issue with stdout rendering
- Source: werewolf.zip, altafen (2022-09-13-14)

## Pitfalls and Gotchas

### #pragma force_active Limitations
- `#pragma force_active on` does NOT work reliably for data symbols
- May need to use FORCEACTIVE section in the LCF file instead
- Even with extern forward declaration trick, some symbols still get discarded
- Source: revosucks, seekyct (2022-09-03)

```c
// In LCF file:
FORCEACTIVE {
    lbl_804C28D0
}
```

### sdata vs sbss
- Initialized data goes to sdata
- Uninitialized or zero-initialized data goes to sbss
- `char lbl[1] = "";` goes to sdata (initialized)
- `char lbl[1]` goes to sbss (uninitialized)
- Must specify array size `[1]` - otherwise uses .data relocs
- Source: rtburns (2022-09-03)

### Parallel Build Issues
- `make -j` can cause build failures
- Some dependencies may not be properly specified
- Source: revosucks, kiwidev (2022-09-17)

### Function Mismatches Between Scratch and Repo
- When function matches on decomp.me but not in repo, check:
  - Function/struct declarations that differ between scratch and repo
  - Values being passed as f64 instead of f32
  - Float conversion constants being generated incorrectly
- Tip: Put function in its own compilation unit and objdump to inspect sections
- Source: rtburns (2022-09-16)

### CPP Environment Variable
- GitHub Actions may set CPP to use mwcc for preprocessing
- This can break LCF preprocessing
- Solution: Explicitly set `CPP=` or remove LCF preprocessing if not needed
- Source: rtburns (2022-09-04)

### Static vs Global in Inline ASM
- Static callback functions in asm don't need `.global`
- But adding `static` in C to force file-local may not match
- Source: glazedgoose, encounter (2022-09-19)

## Project Organization

### Code Style Decisions
- Bare `return;` at end of void functions: Style preference (psi prefers explicit return)
- Float suffix: Use uppercase `F` (e.g., `1.0F`)
- Squash merge is preferred for PRs (cleaner history, decomp commits tend to be messy)
- Source: Multiple contributors (2022-09-04)

### Branch Protection Rules
Recommended settings for master branch:
- Require pull request before merging
- Require status checks to pass
- Require branches to be up to date
- Add "build (GENERATE_MAP=1)" and "build (NON_MATCHING=1)" checks
- Require conversation resolution
- Dismiss stale PR approvals
- Source: ribbanya (2022-09-05)

### Forward Declarations
- Modern compilers (clang-tidy) don't like implicit `struct _GObj` usage
- Proposed solution: Forward declare typedefs in a header
- Better approach: Include proper headers where needed, avoid `struct _*` usage
- Source: rtburns, werewolf.zip (2022-09-15)

## Compiler Decompilation Project

Discussion started about decompiling the mwcceppc compiler itself:
- Goal: Understand and potentially fix the 1.2.5e scheduling patch
- Different versions to consider: 1.2.5, 2.6, 7.2
- Symbol information available for some versions
- Could help solve the `lmw` epilogue ordering problem
- Source: encounter, ninji (2022-09-15)
