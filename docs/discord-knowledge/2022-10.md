# Decompilation Knowledge: 2022-10

## Compiler Patterns

### Duplicate Condition Branches
The mwcc compiler can optimize out duplicate compare instructions but keeps redundant branch instructions that check the same condition:
- Two consecutive branches with the same condition but different targets
- The compiler merges the comparison but not the branches themselves
- First check typically skips a loop, while second branches into it
- Source: seekyct, antidote6212 (2022-10-26)

### Register Shuffling with r3/r4
Sometimes the compiler produces seemingly redundant `addi` instructions moving values between r3 and r4:
- Can be difficult to reproduce in C code
- May relate to function call setup or return value handling
- Source: vetroidmania (2022-10-14, 2022-10-25)

### Loop Countdown Pattern with bdnz
When you see `bdnz` (branch decrement not zero) instruction:
- The loop condition is typically `i = N; i != 0; i--` not `i < N`
- The compiler uses the count register for the loop
- Source: werewolf.zip (2022-10-28)

### lwzu Chain Patterns
Some functions use chains of `lwzu` (load word with update) instructions:
- These can be tricky to match in C
- Often appear in list traversal or sequential memory access
- Source: vetroidmania (2022-10-23)

## Matching Techniques

### Inline ASM in C Files
Moving assembly to inline asm in C files enables partial progress:
```c
asm void FunctionName(void) {
    // assembly here
}
```
- Syntax differs from gas assembler: use `asm void` not `void asm`
- Return type goes before `asm` keyword: `asm HSD_GObj* funcname(...)`
- Callers will typecheck against the signature even though function body is asm
- Source: ribbanya, altafen, rtburns (2022-10-23)

### Inline ASM Caveats
- `@sda21` relocs need to be removed from inline asm
- Float constants from sda2 can be replaced with numeric literals
- Jump tables require special handling: use `entry` keyword instead of colons
- Jump table documentation: p.384 of CWMCUCFCMPREF.pdf (NXP reference manual)
- Inline asm functions don't get reordered like C functions
- Source: rtburns, ribbanya, seekyct (2022-10-23, 2022-10-26)

### Negative Float Bug in Older CW
Older CodeWarrior versions have a bug with negative floats in inline asm:
- Need to use "manual" option where you define float order includes
- The asm refers to those floats via an orderfloats include
- Source: seekyct (2022-10-26)

### Context Generation for decomp.me
To generate context for decomp.me:
```bash
gcc -E -P include/melee/ft/fighter.h > ctx.c
```
- Include paths may need `-I` flags
- Some declarations cause errors (like `@address` syntax)
- Replace `OSContext* OS_CURRENT_CONTEXT @ 0x800000D4;` with `OSContext* OS_CURRENT_CONTEXT = (OSContext*)0x800000D4;`
- Source: rtburns, yoyoeat, ribbanya (2022-10-15, 2022-10-28)

### Hermite Spline Match
```c
f32 splGetHermite(f32 fterm, f32 time, f32 p0, f32 p1, f32 d0, f32 d1)
{
    f32 fVar1;
    f32 fVar2;
    f32 fVar3;
    f32 fVar4;

    fVar1 = time * time;
    fVar2 = fterm * fterm * fVar1 * time;
    fVar3 = 3.0f * fVar1 * fterm * fterm;
    fVar4 = fVar2 - fVar1 * fterm;
    fVar2 = 2.0f * fVar2 * fterm;
    return d1 * fVar4 + d0 * (time + (fVar4 - fVar1 * fterm)) + p0 * (1.0f + (fVar2 - fVar3)) + p1 * (-fVar2 + fVar3);
}
```
- Function name is `splGetHermite` (note: spelled "Helmite" in original but should be "Hermite")
- Source: werewolf.zip, gibhaltmannkill (2022-10-28)

## Type Information

### HSD_GObj Naming
- "HSD" = HAL SysDolphin (HAL's proprietary game engine library)
- "GObj" = Game Object (or possibly General Object, Global Object)
- Used across multiple HAL games including Pokemon Colosseum
- Source: vetroidmania, gibhaltmannkill, krystalcoconut (2022-10-28)

### HSD_Joint and HSD_Spline
- `HSD_Joint` has a `next` field for traversal
- `HSD_Spline` definition may be incomplete/missing in headers
- Source: stephenjayakar (2022-10-18)

### Fighter File Naming Conventions
Character data file naming:
- `PlDk.dat` - Player Donkey Kong (fighter data)
- `PlDkNr.dat` - Normal colors/models
- `PlDkAJ.dat` - Animation Joint data
- `PlDkDViWaitAJ.dat` - Some idle animation data
  - "AJ" = AnimJoint
  - "DViWait" - purpose unclear, possibly unused
- Clone characters (Falco, Ganon, etc.) mostly just have function pointers to their parent fighter
- Source: jasperrlz, vetroidmania (2022-10-08)

### Signed Int to Float Conversion Constant
The magic number `0x4330000080000000` appears frequently:
- Used for signed integer to float conversion
- Hex representation: `433000...008000...00`
- For unsigned conversion, the `8000` part is missing
- Source: vetroidmania, altafen (2022-10-25)

## Function-Specific Insights

### Clone Fighter Code Structure
Clone fighters (Falco, Ganon, Young Link, Pichu, Dr. Mario, Roy) share most code with their parent:
- `ftFalco.s` mostly contains data with function pointers to Fox functions
- Actual game logic lives in parent fighter code
- Parent checks which clone is calling and runs appropriate animation
- Example: Ganon's warlock punch and Falcon's falcon punch are the same function
- Source: altafen, rtburns (2022-10-15)

### ftcoll.c Status
- Contains hitbox collision checking code
- Was created by vetroidmania but work stalled on an `lwzu` chain
- Needed migration to inline asm for partial matching
- Source: vetroidmania, ribbanya (2022-10-23-27)

### CPU AI Code
- Described as "serious spaghetti"
- Has a 60,000+ line function
- Example: Luigi AI never uses upB to recover (poor implementation)
- Source: ribbanya, cortex420 (2022-10-29)

### getFighter - Possibly a Macro
- Suspected to be a macro rather than a real function
- Question raised about whether macros can affect codegen
- Source: ribbanya, vetroidmania (2022-10-31)

## Tool Tips

### PowerPC Assembly Reference
- Best reference: https://math-atlas.sourceforge.net/devel/assembly/ppc_isa.pdf
- Source: altafen (2022-10-15)

### Register Conventions
- r0 = scratch register
- r1 = stack pointer
- r2/r13 = pointers to data sections
- r3 = return value
- r3+ = function arguments
- r31- = locals (decreasing from r31)
- r12 = usually reserved for variable function calls, but used for general purposes if needed
- Source: altafen, vetroidmania (2022-10-15)

### decomp.me Usage
- Only updates output when there are no compilation errors
- To see ASM comparison, comment out problematic lines first
- `-g` switch decompiles everything; not needed if using decomp.me (it does this automatically)
- Scratches require `func_1234:` or `glabel func_1234` at the top of ASM
- Source: vetroidmania, altafen, ribbanya (2022-10-15-17)

### dadosod Performance
- Became "extremely fast" as of commit 67d662c
- Tool for disassembly/analysis
- Source: ribbanya (2022-10-24)

### Dolphin Debugger with Memory Map
- Can use community symbol database in Dolphin's debugger
- Warning: Community names are NOT to be used in the decomp codebase
- Names are guesses accumulated over 20 years, some accurate, some wrong
- Source: stephenjayakar, ribbanya, vetroidmania (2022-10-18)

### IDA vs Ghidra
- IDA preferred by some for pseudo-C output
- Both decompilers can be wrong
- IDA struggles with virtual functions
- Source: cortex420 (2022-10-17)

## Workflow Tips

### File Claiming
- Claim files on Trello board to avoid duplicate work
- Can announce in Discord channel and someone will update Trello
- Trello is public access via link in channel topic
- Typically claim whole files and submit complete file PRs
- Source: revosucks, ribbanya (2022-10-24)

### Top-Down vs Bottom-Up Matching
- Standard approach: match functions from top of .s file going down
- Convenient because you can move matched functions to .c and link before .s
- Alternative: two people work same file, one top-down, one bottom-up
- Source: rtburns, epochflame (2022-10-23, 2022-10-26)

### Inferring Function Signatures
- Look at callsite ASM to infer parameter types
- Search codebase for other uses of the function
- Some functions have declarations in .h files even while body is in .s
- Source: altafen, ribbanya (2022-10-16)

### OOT-style Global ASM Approach
OOT project uses a different approach to partial matching:
```c
#include "global.h"

GLOBAL_ASM("path/to/func1.s")
GLOBAL_ASM("path/to/func2.s")
```
- Enables function-based instead of file-based contributions
- Discussed but Melee project decided inline asm in C is better for CW compiler
- Source: revosucks, ribbanya, seekyct (2022-10-26-27)

### ppcdis Tool
- Supports inline asm includes and autogenerated includes (orderfloats, orderstrings)
- Works with CW compilers; best documented for GC 3.0 (SPM project)
- Inline asm floats need special handling for older CW due to negative float bug
- Source: seekyct (2022-10-26)

## Pitfalls and Gotchas

### Community Symbol Database Warning
Do NOT use names from the Dolphin memory map / community database in the codebase:
- Contains 20 years of modder guesses
- Some names are completely wrong
- C++ mangled names that don't match actual behavior
- Source: ribbanya, vetroidmania (2022-10-18)

### Context Syntax Errors
Common issues with generated context:
- `@address` syntax not supported by m2c: convert to cast assignment
- Missing return types on forward declarations
- Example fix: `OSContext* OS_CURRENT_CONTEXT @ 0x800000D4;` becomes `OSContext* OS_CURRENT_CONTEXT = (OSContext*)0x800000D4;`
- Source: kiwidev, yoyoeat, ribbanya (2022-10-28)

### Matching vs Non-Matching Decomp Distinction
This project is a MATCHING decomp:
- Goal is byte-for-byte identical output to original DOL
- Different from projects like Metaforce (Prime) which is non-matching
- All code compiled fresh, no mixed assembly patchwork
- Source: sage_of_mirrors, vetroidmania, ribbanya (2022-10-03)

### Portability is NOT a Current Goal
- Project explicitly not targeting x86/ARM recompilation currently
- Inline ASM will not work on other architectures
- Native ports would require rewriting hardware layer (like Super Monkey Ball x86 port)
- Can split `dolphin` namespace from repo later
- Source: ribbanya, stephenjayakar (2022-10-27)

## Project Status and Direction

### Progress Statistics (October 2022)
```
Code sections: 476736 / 3882272 bytes in src (12.28%)
Data sections: 62507 / 1223369 bytes in src (5.11%)
35 of 293 Trophies, 2 of 51 Event Matches
```
- Progress dropped because project stopped counting asm functions
- Source: ribbanya (2022-10-26)

### Multiple Pass Philosophy
1. First pass: Write "shitty C code" that matches
2. Later pass: Document structs, clean up patterns
3. Full documentation comes last (like sm64's shadow.c example)
- Source: stephenjayakar, ribbanya, revosucks (2022-10-27)

### Contributor Profile
- Most contributors are Melee modders interested in specific code sections
- Fighter code gets the most attention
- Libraries, menu code, other systems less loved
- High friction for first-time contributors
- Source: ribbanya (2022-10-26-27)

### Long-Term Vision
- Native Melee client (no emulator)
- Rollback netcode built into game code, not Dolphin patches
- Low-end device support (Raspberry Pi, Steam Deck)
- UI modding in C instead of complex hex editing
- Depends on near-complete decompilation
- Source: ribbanya, stephenjayakar, cortex420 (2022-10-09, 2022-10-27)
